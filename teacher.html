<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>과제 배정 (교사용)</title>

  <!-- 폰트: 제목=Jua, 본문/버튼=SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">

  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js" defer></script>

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --brand:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);
    }

    *{ box-sizing:border-box }
    html, body { min-height:100% }

    /* ================================
       배경 & 기본 타이포
       ================================ */
    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);

      /* 부드러운 배경 그래픽 */
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));

      /* 상단 로고칩 공간 확보 + 가운데 정렬 */
      padding:96px 16px 40px;
      display:flex;
      justify-content:center;
      align-items:flex-start;   /* 세로 가운데 고정 방지 */
      overflow-y:auto;          /* 세로 스크롤 허용 */
    }

    /* 배경의 구름 */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.9;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }

    /* ================================
       가운데 카드 컨테이너
       ================================ */
    .container{
      max-width:960px;
      width:100%;
      background:var(--card);
      border:1px solid var(--card-line);
      border-radius:26px;
      box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:28px 24px 32px;

      /* 긴 내용 대응 */
      height:auto;
      overflow-wrap:break-word;
    }

    /* ================================
       공통 제목/섹션
       ================================ */
    h2, h3 { margin:0 0 14px; }
    h2{
      text-align:center;
      font-family:'Jua',sans-serif;
      font-weight:400;
      letter-spacing:-.2px;
    }
    section{ margin-top:26px; }

    /* ================================
       입력/셀렉트/버튼 공통
       ================================ */
    input[type="text"],
    input[type="password"],
    input[type="date"],
    select{
      padding:10px 12px;
      border:2px solid #dcdfe4;
      border-radius:14px;
      outline:none;
      font:inherit;
      background:#fff;
    }
    input:focus, select:focus{
      border-color:#b9c7c5;
      box-shadow:0 0 0 4px rgba(185,199,197,.28);
    }
    button{
      padding:10px 14px;
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--card-line);
      background:#fff;
      font:inherit;
    }
    .btn-primary{
      color:#fff;
      background:var(--brand);
      border-color:var(--brand);
      box-shadow:0 12px 28px var(--btn-shadow);
    }

    /* ================================
       과제 입력 행
       ================================ */
    .task-input{
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .task-input input{ flex:1; }

    /* 학생 체크박스 라벨 */
    .student-checkboxes label{
      display:inline-block;
      margin:6px 8px 0 0;
      padding:6px 10px;
      border:1px solid #e6e8eb;
      border-radius:12px;
      background:#fff;
    }

    /* 저장내역/학생칩 */
    .saved-item, .student-item{
      border-top:1px dashed #d5d5d5;
      padding-top:8px;
      margin-top:10px;
    }

    /* ================================
       달력 스타일
       ================================ */
    .calendar{ display:none; }
    .calendar table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    .calendar th, .calendar td{
      border:1px solid #ececec;
      width:14.28%;
      height:96px;
      text-align:left;
      vertical-align:top;
      padding:8px;
      font-size:14px;
    }
    .calendar thead th{ background:#f9fafb; }
    .calendar td > strong{ display:block; margin-bottom:6px; }

    /* 달력 과제 pill */
    .task-pill{
      background:#f6c1c1;
      border-radius:10px;
      padding:4px 8px;
      margin-top:6px;
      font-size:12px;
      cursor:pointer;
      display:inline-block;
      border:1px solid rgba(0,0,0,.06);
    }
    .task-pill:hover{ opacity:.9; }

    /* 선택 안내/버튼 영역 */
    #task-action-selected{ margin:10px 0; font-size:14px; color:#555; }

    /* ================================
       과제별 완료 여부(칩)
       ================================ */
    .student-chip-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .student-chip{
      border:1px solid #e6e8eb;
      border-radius:12px;
      padding:10px 12px;
      min-width:92px;
      text-align:center;
      background:#fff;
    }
    .student-chip.missed{
      background:#f6c1c1;
      border-color:#e9b3b3;
    }

    /* ================================
       학생 관리 표
       ================================ */
    #student-list{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    #student-list col:nth-child(1){ width: 8ch; }
    #student-list col:nth-child(2){
      width:auto;
      min-width: 14rem;
    }
    #student-list col:nth-child(3){ width: 14ch; }
    #student-list col:nth-child(4){ width: 7ch;  }
    #student-list col:nth-child(5){ width: 16ch; }

    #student-list th, #student-list td{
      border:1px solid #ccc;
      padding:6px;
      text-align:center;
      vertical-align:middle;
    }
    #student-list td input[type="text"],
    #student-list td input[type="password"]{
      width:100%;
      height:32px;
      box-sizing:border-box;
      display:block;
      margin:0;
    }
    #student-list td.col-actions .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }
    #student-list td.col-actions .actions button{
      height:32px;
      padding:0 12px;
    }
    @media (max-width: 520px){
      #student-list col:nth-child(4){ width: 6ch; }
      #student-list col:nth-child(5){ width: 14ch; }
    }
    .table-wrap{ overflow-x:auto; }

    /* 버튼 줄 한 줄 정렬 */
    #task-action-buttons{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #task-action-buttons button{
      height:36px;
      padding:0 14px;
    }

    
  </style>
</head>
<body>
  <!-- 상단 풀바(칩 버튼형) -->
  <header class="topbar">
    <div class="logo-area">
      <a href="./"><img src="logo.png" alt="오늘 할 일 로고"></a>
    </div>
    <nav class="menu-area" aria-label="주요 메뉴">
      <button id="tab-status"  onclick="showStudentStatus()">오늘 할 일</button>
      <button id="tab-task"    onclick="showTaskManagement()">과제 관리</button>
      <button id="tab-student" onclick="showStudentManagement()">학생 관리</button>
    </nav>
    <div class="right-tools">
      <button type="button" id="modeBtn" class="mode-btn" aria-pressed="false"></button>
    </div>
  </header>

  <!-- =====================================
       가운데 카드 컨테이너
       ===================================== -->
  <div class="container">
    <!-- ===== 오늘 할 일(학생별 현황) ===== -->
    <div id="student-status-page" style="display:none; margin-top: 8px;">
      <h3>✅ 학생별 과제 완료 현황</h3>
      <div
        id="student-status-list"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;"
      ></div>
    </div>

    <!-- ===== 과제 관리 + 달력 ===== -->
    <div id="task-management" style="display:none; margin-top: 8px;">
      <h2>📋 과제 추가 및 달력</h2>

      <!-- 과제 입력 영역 -->
      <section>
        <label>📅 과제 날짜:</label>
        <input type="date" id="task-date" />

        <div class="task-list" id="task-list">
          <div class="task-input">
            <input type="text" placeholder="할 일 입력" />
            <button onclick="removeTask(this)">⊖</button>
          </div>
        </div>

        <button class="btn-primary" onclick="addTask()">+ 할 일 추가</button>

        <label style="display:block; margin-top:10px;">🔁 반복 설정:</label>
        <select id="repeat">
          <option value="none">없음</option>
          <option value="daily">매일</option>
          <option value="mon">매주 월요일</option>
          <option value="tue">매주 화요일</option>
          <option value="wed">매주 수요일</option>
          <option value="thu">매주 목요일</option>
          <option value="fri">매주 금요일</option>
        </select>

        <label style="display:block; margin-top:10px;">👥 대상 선택:</label>
        <select id="target">
          <option value="all">전체 학생</option>
          <option value="selected">특정 학생 지정</option>
        </select>

        <div id="student-checkboxes" class="student-checkboxes" style="display: none;"></div>

        <button class="btn-primary" style="margin-top:10px;" onclick="saveAssignment()">💾 저장하기</button>
      </section>

      <!-- 달력 -->
      <section class="calendar" style="margin-top:20px;">
        <h3>🗓️ 달력 (과제 클릭 시 수정/삭제 버튼 표시)</h3>
        <div id="cal-controls" style="display:flex;align-items:center;gap:8px;margin:8px 0 4px;">
          <button type="button" onclick="changeMonth(-1)">◀</button>
          <div id="cal-label" style="font-weight:600;min-width:120px;text-align:center;"></div>
          <button type="button" onclick="changeMonth(1)">▶</button>
          <button type="button" onclick="goToday()" style="margin-left:8px;">오늘</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </section>

      <!-- 과제 선택 안내 + 액션 버튼 -->
      <div id="task-action-selected"></div>
      <div id="task-action-buttons" style="margin-top:10px; display:none;">
        <button class="btn-primary" onclick="closeTaskCompletion()">닫기</button>
        <button class="btn-primary" onclick="editTask()">수정</button>
        <button class="btn-primary" onclick="deleteTaskClicked()">삭제</button>
      </div>

      <!-- 과제별 학생 완료 여부 -->
      <div id="task-completion" style="margin-top:20px; display:none;">
        <h3>과제별 학생 완료 여부</h3>
        <div id="completion-list"></div>
      </div>
    </div>

    <!-- ===== 학생 관리 ===== -->
    <div id="student-management" style="display:none; margin-top:20px;">
      <h3>👩‍🎓 학생 관리</h3>

      <!-- 학생 추가 폼 -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <input type="text" id="new-student-id" placeholder="번호" style="flex:0 0 110px;" />
        <input type="text" id="new-student-name" placeholder="이름" style="flex:1 1 160px;" />
        <input type="password" id="new-student-password" placeholder="비밀번호" style="flex:0 0 140px;" />
        <button class="btn-primary" onclick="addStudent()">추가</button>
      </div>

      <!-- 전체 비밀번호 보기 토글 -->
      <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
        <label>
          <input type="checkbox" id="show-all-passwords" onchange="toggleAllPw(this)">
          비밀번호 모두 보기
        </label>
      </div>

      <!-- 학생 목록 표 -->
      <table id="student-list" border="1" style="margin-top:10px; width: 100%; border-collapse:collapse;">
        <colgroup>
          <col><!-- 번호 -->
          <col><!-- 이름 -->
          <col><!-- 비밀번호 -->
          <col><!-- 보기 -->
          <col><!-- 작업 -->
        </colgroup>
        <thead>
          <tr>
            <th>번호</th>
            <th>이름</th>
            <th>비밀번호</th>
            <th>보기</th>
            <th>작업</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===========================================================
       스크립트 (기능 그대로 / 가독성 있게 정리 + 주석 제목 추가)
       =========================================================== -->
  <script>
    // ===========================================================
    // 전역 상태
    // ===========================================================
    let selectedDate = null;
    let selectedTaskIndex = null;
    let selectedTaskText = "";
    let selectedOriginDate = null;
    let selectedOriginKey = null;
    let isEditing = false;
    let editingOriginalDate = null;

    let calendarRefs = {};

    let viewYear  = (new Date()).getFullYear();
    let viewMonth = (new Date()).getMonth(); // 0=1월, 11=12월

    function setCalLabel(){
      const label = document.getElementById('cal-label');
      if (!label) return;
      label.textContent = `${viewYear}년 ${viewMonth+1}월`;
    }

    function changeMonth(delta){
      viewMonth += delta;
      if (viewMonth < 0) { viewMonth = 11; viewYear--; }
      if (viewMonth > 11){ viewMonth = 0;  viewYear++; }
      renderCalendar();
      hideActionUI();
    }

    function goToday(){
      const today = new Date();
      viewYear  = today.getFullYear();
      viewMonth = today.getMonth();
      renderCalendar();
      hideActionUI();
    }

    

    // ===========================================================
    // 유틸리티: 학생 정렬/라벨
    // ===========================================================
    function _toNum(v) {
      const n = parseInt(String(v), 10);
      return isNaN(n) ? 0 : n;
    }
    function sortStudents(arr) {
      return (arr || []).slice().sort((a, b) => {
        const an = _toNum(a.id), bn = _toNum(b.id);
        const ag = an > 50 ? 1 : 0, bg = bn > 50 ? 1 : 0;
        if (ag !== bg) return ag - bg;
        return an - bn;
      });
    }
    function getStudentsSorted() { return sortStudents(loadStudents()); }
    function labelOf(stu) { return `${stu.id} ${stu.name}`; }

    // ===========================================================
    // 초기화: 첫 화면은 '오늘 할 일'
    // ===========================================================
    window.onload = function () {
      showStudentStatus();
    };

    // ===========================================================
    // 상단 풀바: 활성 탭 표시 함수
    // ===========================================================
    function setActiveTab(key){
      const map = {
        status:  document.getElementById('tab-status'),
        task:    document.getElementById('tab-task'),
        student: document.getElementById('tab-student')
      };
      Object.values(map).forEach(btn => btn && btn.classList.remove('active'));
      if (map[key]) map[key].classList.add('active');
    }

    // ===========================================================
    // 화면 전환: 탭 버튼 핸들러
    // ===========================================================
    function showStudentStatus() {
      setActiveTab('status');
      document.getElementById("student-status-page").style.display = "block";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "none";
      hideActionUI();
      renderStudentStatus();
    }

    function showTaskManagement() {
      setActiveTab('task');
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "block";
      document.getElementById("student-management").style.display = "none";
      renderCalendar();
      hideActionUI();
      renderStudentListToCheckbox();
      const calendarSection = document.querySelector("#task-management section.calendar");
      if (calendarSection) calendarSection.style.display = "block";
    }

    function showStudentManagement() {
      setActiveTab('student');
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "block";
      hideActionUI();
      renderStudentList();
    }

    
    // ===========================================================
    // 학생 체크박스 렌더링(과제 대상 지정용)
    // ===========================================================
    function renderStudentListToCheckbox() {
      const container = document.getElementById("student-checkboxes");
      container.innerHTML = "";
      const students = getStudentsSorted();
      students.forEach(stu => {
        const label = document.createElement("label");
        label.innerHTML = `<input type="checkbox" value="${stu.name}" /> ${labelOf(stu)}`;
        container.appendChild(label);
      });
    }
    document.getElementById("target").addEventListener("change", function () {
      const show = this.value === "selected";
      document.getElementById("student-checkboxes").style.display = show ? "block" : "none";
    });

    // ===========================================================
    // 과제 완료 저장/조회 (학생별)
    // ===========================================================
    function getDoneTasks(student) {
      return getJSON("doneTasks-" + student, {});
    }
    function setDoneTasks(student, doneTasks) {
      setJSON("doneTasks-" + student, doneTasks);
    }
    function makeDoneKey(dateStr, taskText) { return `${dateStr}@@${taskText}`; }
    function isDone(studentName, dateStr, taskText) {
      const store = getDoneTasks(studentName) || {};
      const doneKey = makeDoneKey(dateStr, taskText);
      return store[doneKey] === true || store[taskText] === true;
    }
    function setDone(studentName, dateStr, taskText, done) {
      const store = getDoneTasks(studentName) || {};
      const doneKey = makeDoneKey(dateStr, taskText);
      if (done) store[doneKey] = true; else delete store[doneKey];
      setDoneTasks(studentName, store);
    }

    // ===========================================================
    // 과제 입력 행 추가/삭제
    // ===========================================================
    function addTask() {
      const div = document.createElement("div");
      div.className = "task-input";
      div.innerHTML =
        '<input type="text" placeholder="할 일 입력" />' +
        '<button onclick="removeTask(this)">⊖</button>';
      document.getElementById("task-list").appendChild(div);
    }
    function removeTask(btn) { btn.parentElement.remove(); }

    // ===========================================================
    // 과제 저장 (신규/편집 모드 공용)
    // ===========================================================
    function saveAssignment() {
      const date = document.getElementById("task-date").value;
      if (!date) { alert("과제 날짜를 선택하세요."); return; }

      const repeat = document.getElementById("repeat").value;
      const target = document.getElementById("target").value;

      const newTasks = Array
        .from(document.querySelectorAll("#task-list input"))
        .map(i => i.value.trim())
        .filter(t => t !== "");
      if (newTasks.length === 0) { alert("과제를 하나 이상 입력하세요."); return; }

      let students = [];
      if (target === "selected") {
        students = Array
          .from(document.querySelectorAll("#student-checkboxes input:checked"))
          .map(cb => cb.value);
        if (students.length === 0) { alert("학생을 하나 이상 선택하세요."); return; }
      } else {
        students = ["전체"];
      }

      if (isEditing) {
        const originalKey = "teacherTasks-" + editingOriginalDate;
        const newKey      = "teacherTasks-" + date;
        const data = { tasks: newTasks, repeat, students };
        if (newKey !== originalKey) localStorage.removeItem(originalKey);
        localStorage.setItem(newKey, JSON.stringify(data));
        isEditing = false;
        editingOriginalDate = null;
        alert("수정되었습니다!");
        renderCalendar(); hideActionUI(); renderStudentStatus();
        return;
      }

      const key = "teacherTasks-" + date;
      const existingRaw = localStorage.getItem(key);
      let existing = null;
      if (existingRaw) { try { existing = JSON.parse(existingRaw); } catch { existing = null; } }

      let mergedTasks = [];
      let mergedStudents = [];
      if (existing) {
        mergedTasks = Array.from(new Set(existing.tasks.concat(newTasks)));
        mergedStudents = Array.from(new Set(existing.students.concat(students)));
      } else {
        mergedTasks = newTasks;
        mergedStudents = students;
      }

      const data = { tasks: mergedTasks, repeat, students: mergedStudents };
      localStorage.setItem(key, JSON.stringify(data));
      alert("저장되었습니다!");
      renderCalendar();
      renderStudentStatus();
    }

    // ===========================================================
    // 달력 렌더링 (반복 과제 계산 포함)
    // ===========================================================
    function renderCalendar() {
      const tbody = qs("#calendar-body");
      tbody.innerHTML = "";
      calendarRefs = {};
      
      const year  = viewYear;
      const month = viewMonth;
      
      const firstDay         = new Date(year, month, 1);
      const startDay         = firstDay.getDay();
      const adjustedStartDay = (startDay + 6) % 7;
      const lastDate         = new Date(year, month + 1, 0).getDate();
      
      // 1) 원본 과제 한 번만 로드
      const originals = loadAllTeacherTasks();
      
      // 2) 이번 달에 실제로 보여줄 인스턴스 구성
      const instancesMap = {};
      const add = (dateStr, key, taskIndex, text) => {
        (instancesMap[dateStr] ??= []).push({ key, taskIndex, text });
      };
      
      for (const { key, dateKey, data } of originals) {
        const tasks = data.tasks || [];
        const rpt   = data.repeat || "none";
        
        if (rpt === "daily") {
          for (let d=1; d<=lastDate; d++){
            const dateStr = `${year}-${pad2(month+1)}-${pad2(d)}`;
            tasks.forEach((t, idx) => add(dateStr, key, idx, t));
          }
        } else if (["mon","tue","wed","thu","fri"].includes(rpt)) {
          const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
          for (let d=1; d<=lastDate; d++){
            const dateObj = new Date(year, month, d);
            if (dateObj.getDay() === dayMap[rpt]) {
              const dateStr = `${year}-${pad2(month+1)}-${pad2(d)}`;
              tasks.forEach((t, idx) => add(dateStr, key, idx, t));
            }
          }
        } else {
          const dateStr = dateKey;
          tasks.forEach((t, idx) => add(dateStr, key, idx, t));
        }
      }
      
      // 3) calendarRefs 구성
      for (const [dateStr, arr] of Object.entries(instancesMap)) {
        calendarRefs[dateStr] = arr.map(({ key, taskIndex }) => ({ key, taskIndex }));
      }
      
      // 4) 표 HTML 생성 (escape 적용)
      let html = "<tr>";
      for (let i=0; i<adjustedStartDay; i++) html += "<td></td>";
      
      for (let day=1; day<=lastDate; day++){
        const dateStr = `${year}-${pad2(month+1)}-${pad2(day)}`;
        const pills = (instancesMap[dateStr] || []).map((inst, idx) =>
          `<div class="task-pill" onclick="selectTask('${dateStr}', ${idx})">${escapeHTML(inst.text)}</div>`
                                                       ).join("");
        html += `<td><strong>${day}</strong>${pills}</td>`;
        if ((adjustedStartDay + day) % 7 === 0) html += "</tr><tr>";
      }
      html += "</tr>";
      tbody.innerHTML = html;
      setCalLabel();
    }


    // ===========================================================
    // 과제 편집/삭제/확인
    // ===========================================================
    function editTask() {
      if (!selectedDate) { alert("과제를 먼저 선택하세요."); return; }

      const refs = calendarRefs[selectedDate] || [];
      const found = refs.find(r => {
        const data = JSON.parse(localStorage.getItem(r.key) || "null");
        return data?.tasks?.[selectedTaskIndex] !== undefined;
      });
      if (!found) { alert("원본 과제를 찾을 수 없습니다."); return; }

      const data = JSON.parse(localStorage.getItem(found.key) || "{}");
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';

      (data.tasks || []).forEach(task => {
        const div = document.createElement('div');
        div.className = 'task-input';
        div.innerHTML = `<input type="text" value="${task}"/><button onclick="removeTask(this)">⊖</button>`;
        taskList.appendChild(div);
      });

      const originalDate = found.key.replace("teacherTasks-", "");
      document.getElementById('task-date').value = originalDate;
      document.getElementById('repeat').value    = data.repeat || 'none';

      const target = (data.students || []).includes('전체') ? 'all' : 'selected';
      document.getElementById('target').value = target;
      document.getElementById('student-checkboxes').style.display = (target === 'selected') ? 'block' : 'none';

      if (target === 'selected') {
        const set = new Set(data.students || []);
        document.querySelectorAll('#student-checkboxes input').forEach(cb => {
          cb.checked = set.has(cb.value);
        });
      }

      isEditing = true;
      editingOriginalDate = originalDate;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteTaskClicked() {
      if (!selectedDate || selectedTaskIndex == null) { alert("과제를 먼저 선택하세요."); return; }

      const refs = calendarRefs[selectedDate] || [];
      const ref = refs.find(r => {
        const d = JSON.parse(localStorage.getItem(r.key) || "null");
        return d?.tasks?.[selectedTaskIndex] !== undefined;
      });
      if (!ref) { alert("원본 과제를 찾을 수 없습니다."); return; }

      const data  = JSON.parse(localStorage.getItem(ref.key) || "null");
      const target = data.tasks[selectedTaskIndex];
      if (!confirm(`"${target}" 과제를 삭제할까요?`)) return;

      data.tasks.splice(selectedTaskIndex, 1);
      if (data.tasks.length === 0) localStorage.removeItem(ref.key);
      else localStorage.setItem(ref.key, JSON.stringify(data));

      selectedTaskIndex = null;
      document.getElementById('task-action-buttons').style.display = 'none';

      renderCalendar();
      hideActionUI();
      renderStudentStatus();
    }

    function closeTaskCompletion() { hideActionUI(); }

    // ===========================================================
    // 달력: 과제 선택 시 상태 갱신
    // ===========================================================
    function selectTask(dateStr, idx) {
      selectedDate = dateStr;
      selectedTaskIndex = null;
      selectedTaskText = "";
      selectedOriginDate = null;
      selectedOriginKey  = null;

      const refs = calendarRefs[dateStr] || [];
      const ref  = refs[idx];

      const $btns     = document.getElementById('task-action-buttons');
      const $selected = document.getElementById('task-action-selected');
      const $compBox  = document.getElementById('task-completion');

      if (!ref) {
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }

      let pack = null;
      try { pack = JSON.parse(localStorage.getItem(ref.key) || 'null'); } catch { pack = null; }
      const text = pack?.tasks?.[ref.taskIndex];

      if (typeof text !== 'string' || text.trim() === "") {
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }

      selectedTaskIndex  = ref.taskIndex;
      selectedTaskText   = text;
      selectedOriginDate = ref.key.replace('teacherTasks-', '');
      selectedOriginKey  = ref.key;

      if ($selected) $selected.textContent = `선택: ${dateStr} — ${selectedTaskText}`;

      if (typeof renderTaskCompletion === 'function') {
        renderTaskCompletion(selectedOriginKey, selectedTaskIndex);
      }
      if ($compBox) $compBox.style.display = 'block';

      if ($btns) {
        $btns.style.display = 'flex';
        const parent = $compBox?.parentNode;
        if (parent && $compBox) parent.insertBefore($btns, $compBox.nextSibling);
      }
    }

    // ===========================================================
    // 과제별 학생 완료 여부 렌더링
    // ===========================================================
    function renderTaskCompletion(originKey, taskIdx) {
      const container = document.getElementById("completion-list");
      container.innerHTML = "";

      if (!originKey || typeof taskIdx !== 'number') {
        container.textContent = "원본 과제를 찾을 수 없습니다.";
        return;
      }

      let data = null;
      try { data = JSON.parse(localStorage.getItem(originKey) || "null"); } catch { data = null; }
      if (!data || !Array.isArray(data.tasks) || data.tasks[taskIdx] == null) {
        container.textContent = "과제가 없습니다.";
        return;
      }

      const task       = data.tasks[taskIdx];
      const originDate = originKey.replace("teacherTasks-","");

      let students = getStudentsSorted();
      if (!data.students.includes("전체")) {
        const set = new Set(data.students || []);
        students  = students.filter(s => set.has(s.name));
      }

      const h = document.createElement('h4');
      h.textContent = `📌 ${task} (${originDate})`;
      container.appendChild(h);

      const grid = document.createElement('div');
      grid.className = "student-chip-grid";
      grid.style.userSelect = "none";

      students.forEach(stu => {
        const done = isDone(stu.name, originDate, task);
        const chip = document.createElement('div');
        chip.className = "student-chip" + (done ? "" : " missed");
        chip.dataset.student = stu.name;
        chip.dataset.date = originDate;
        chip.dataset.task = task;
        chip.style.cursor = "pointer";
        chip.textContent = `${stu.id} ${stu.name}`;
        grid.appendChild(chip);
      });

      container.appendChild(grid);

      grid.onclick = (e) => {
        const chip = e.target.closest('.student-chip');
        if (!chip) return;

        const student = chip.dataset.student;
        const dateStr = chip.dataset.date;
        const taskTxt = chip.dataset.task;

        const nowIsDone = !chip.classList.contains('missed');
        setDone(student, dateStr, taskTxt, !nowIsDone);
        chip.classList.toggle('missed', nowIsDone);

        if (typeof renderStudentStatus === 'function') renderStudentStatus();
      };
    }

    // ===========================================================
    // '오늘 할 일' 화면 렌더링 (학생별 카드)
    // ===========================================================
    function renderStudentStatus() {
      const container = qs("#student-status-list");
      container.innerHTML = "";
      
      const students = getStudentsSorted();
      const originals = loadAllTeacherTasks();
      
      // allAssignments: {tasks, repeat, students, date}
      const allAssignments = originals.map(({data, dateKey}) => ({ ...data, date: dateKey }));
      
      const today = normalizeDate(new Date());
      
      const validAssignments = allAssignments
        .filter(assign => {
          if (!assign.date) return false;
          const d = normalizeDate(assign.date);
          return !isNaN(d) && d <= today;
        })
        .map(assign => {
          const d = normalizeDate(assign.date);
          return {
            ...assign,
            dateObj: d,
            formattedDate: `${d.getMonth()+1}월 ${d.getDate()}일 (${dayNames[d.getDay()]})`
          };
        })
        .sort((a,b) => b.dateObj - a.dateObj);
      
      // DOM Fragment로 조립 (레이아웃 스로틀링 방지)
      const frag = document.createDocumentFragment();
      
      students.forEach(stu => {
        const card = document.createElement("div");
        Object.assign(card.style, {
          border:"1px solid #e6e8eb", padding:"12px", borderRadius:"16px",
          background:"#fff", boxShadow:"0 4px 10px rgba(0,0,0,.04)", marginBottom:"10px"
        });
        card.innerHTML = `👦 ${labelOf(stu)}<div style="margin-top: 10px;"></div>`;
        const listBox = card.lastElementChild;
        
        validAssignments.forEach(assign => {
          const assigned = assign.students.includes("전체") || assign.students.includes(stu.name);
          if (!assigned) return;
          
          assign.tasks.forEach(task => {
            const done = isDone(stu.name, assign.date, task);

            //레거시 키('과제명'만 저장된 것)를 표준 키로 이주
            const store = getDoneTasks(stu.name) || {};
            const legacy = store[task];            // '과제명'만으로 체크된 예전 키
            const fullKey = `${assign.date}@@${task}`;
            if (legacy && store[fullKey] !== true) {
              store[fullKey] = true;
              delete store[task];
              setDoneTasks(stu.name, store);
            }
          
            const isPast = assign.dateObj < today;
            if (done && isPast) return;
            
            let bg = "#f6c1c1", dateColor = "#666";
            if (isPast && !done) { bg = "#c0392b"; dateColor = "#fff"; }
            else if (!isPast && done) { bg = "white"; dateColor = "#666"; }
            
            const chip = document.createElement("div");
            chip.className = "student-chip" + (done ? "" : " missed");
            chip.dataset.student = stu.name;
            chip.dataset.date = assign.date;
            chip.dataset.task = task;
            chip.style.cssText = `
            border:1px solid #e6e8eb; background:${bg}; padding:8px; border-radius:12px;
            margin:6px 0; display:flex; justify-content:space-between; align-items:center; cursor:pointer;`;
            chip.innerHTML = `
            <span>${escapeHTML(task)}</span>
            <span style="font-size:10px; color:${dateColor};">${assign.formattedDate}</span>
            `;
            listBox.appendChild(chip);
          });
        });
        
        frag.appendChild(card);
      });
      
      container.appendChild(frag);
    }


    // '오늘 할 일' 학생 칩 클릭 델리게이션
     window.addEventListener('load', () => {
       const container = document.getElementById('student-status-list');
       if (!container) return;
      
      // rAF 기반 재렌더 스로틀러 (중복 호출 억제)
      let raf = null;
      const schedule = () => {
        if (raf) return;
        raf = requestAnimationFrame(() => { raf = null; renderStudentStatus(); });
      }
      
        container.addEventListener('click', (e) => {
          const chip = e.target.closest('.student-chip');
          if (!chip || !container.contains(chip)) return;
          
          const { student, date:dateStr, task:taskTxt } = chip.dataset;
          const nowIsDone = !chip.classList.contains('missed');

          // 저장 키 토글
          const dKey  = `${dateStr}@@${taskTxt}`;
          const store = getDoneTasks(student) || {};
          if (nowIsDone) { delete store[dKey]; chip.classList.add('missed'); }
          else { store[dKey] = true; chip.classList.remove('missed'); }
          setDoneTasks(student, store);
          
          schedule(); // 렌더 요청 (여러 번 눌러도 1프레임에 1회만)
        }, false);
    })();


    // ===========================================================
    // 학생 데이터 로드/저장
    // ===========================================================
    function loadStudents() {
      return loadStudentsCached();
    }
    
    function saveStudents(students) {
      setJSON("students", students);
      invalidateStudentsCache();
    }
    // ===========================================================
    // 학생 리스트 렌더링
    // ===========================================================
    function renderStudentList() {
      const students = getStudentsSorted();
      const showAll = document.getElementById("show-all-passwords")?.checked;
      const tbody = document.querySelector("#student-list tbody");

      tbody.innerHTML = "";

      students.forEach(stu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-id">
            <input data-field="id" value="${stu.id}" />
          </td>
          <td>
            <input data-field="name" value="${stu.name}" />
          </td>
          <td>
            <input data-field="password" ${showAll ? 'type="text"' : 'type="password"'} value="${stu.password}" />
          </td>
          <td style="text-align:center;">
            <input type="checkbox" onchange="toggleRowPw(this)" ${showAll ? "checked" : ""}/>
          </td>
          <td class="col-actions">
            <div class="actions">
              <button onclick="saveStudentRow('${stu.id}','${stu.name}', this)">저장</button>
              <button onclick="deleteStudentByKey('${stu.id}','${stu.name}')">삭제</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===========================================================
    // 학생: 비밀번호 보기 토글(행 단위 / 전체)
    // ===========================================================
    function toggleRowPw(checkboxEl) {
      const tr = checkboxEl.closest("tr");
      const pwInput = tr.querySelector('input[data-field="password"]');
      pwInput.type = checkboxEl.checked ? "text" : "password";
    }
    function toggleAllPw(masterCheckbox) {
      const show = masterCheckbox.checked;
      document
        .querySelectorAll('#student-list tbody input[data-field="password"]')
        .forEach(inp => (inp.type = show ? "text" : "password"));
      document
        .querySelectorAll('#student-list tbody input[type="checkbox"]')
        .forEach(cb => (cb.checked = show));
    }

    // ===========================================================
    // 학생: 추가/저장/삭제
    // ===========================================================
    function addStudent() {
      const id = document.getElementById("new-student-id").value.trim();
      const name = document.getElementById("new-student-name").value.trim();
      const password = document.getElementById("new-student-password").value.trim();

      if (!id || !name || !password) { alert("번호, 이름, 비밀번호를 모두 입력하세요."); return; }

      const students = loadStudents();
      if (students.some(s => s.id === id)) { alert("이미 존재하는 번호입니다."); return; }

      students.push({ id, name, password });
      saveStudents(students);

      document.getElementById("new-student-id").value = "";
      document.getElementById("new-student-name").value = "";
      document.getElementById("new-student-password").value = "";
      renderStudentList();
    }

    function saveStudentRow(oldId, oldName, btnEl) {
      const tr = btnEl.closest("tr");

      const newId = tr.querySelector('input[data-field="id"]').value.trim();
      const newName = tr.querySelector('input[data-field="name"]').value.trim();
      const newPw = tr.querySelector('input[data-field="password"]').value.trim();

      if (!newId || !newName || !newPw) { alert("번호, 이름, 비밀번호를 모두 입력하세요."); return; }

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(oldId) && s.name === oldName);
      if (idx < 0) { alert("대상 학생을 찾을 수 없습니다."); return; }

      if (String(newId) !== String(oldId) && students.some(s => String(s.id) === String(newId))) {
        alert("이미 존재하는 번호입니다."); return;
      }

      students[idx] = { id: newId, name: newName, password: newPw };
      saveStudents(students);
      invalidateStudentsCache();

      renderStudentList();
      renderStudentListToCheckbox?.();
      renderStudentStatus?.();
    }

    function deleteStudentByKey(id, name) {
      if (!confirm("정말 삭제하시겠습니까?")) return;

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(id) && s.name === name);

      if (idx >= 0) {
        students.splice(idx, 1);
        saveStudents(students);
        invalidateStudentsCache();
        
        renderStudentList();
        renderStudentListToCheckbox();
        renderStudentStatus();
      }
    }

    function hideActionUI() {
      const $btns     = document.getElementById('task-action-buttons');
      const $selected = document.getElementById('task-action-selected');
      const $compBox  = document.getElementById('task-completion');

      if ($btns)     $btns.style.display = 'none';
      if ($compBox)  $compBox.style.display = 'none';
      if ($selected) $selected.textContent = '';

      selectedDate = null;
      selectedTaskIndex = null;
      selectedTaskText = '';
      selectedOriginDate = null;
      selectedOriginKey = null;
    }
  </script>
</body>
</html>
