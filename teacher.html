<script>
  document.getElementById("target").addEventListener("change", function() {
    const show = this.value === "selected";
    document.getElementById("student-checkboxes").style.display = show ? "block" : "none";
  });

  function addTask() {
    const div = document.createElement("div");
    div.className = "task-input";
    div.innerHTML = '<input type="text" placeholder="할 일 입력" /><button onclick="removeTask(this)">⊖</button>';
    document.getElementById("task-list").appendChild(div);
  }

  function removeTask(btn) {
    btn.parentElement.remove();
  }

  async function saveAssignment() {
    const date = document.getElementById("task-date").value;
    if (!date) {
      alert("과제 날짜를 선택하세요.");
      return;
    }
    const repeat = document.getElementById("repeat").value;
    const target = document.getElementById("target").value;
    const newTasks = Array.from(document.querySelectorAll("#task-list input"))
      .map(i => i.value.trim())
      .filter(t => t !== "");
    if (newTasks.length === 0) {
      alert("과제를 하나 이상 입력하세요.");
      return;
    }
    const students = target === "selected"
      ? Array.from(document.querySelectorAll("#student-checkboxes input:checked")).map(cb => cb.value)
      : ["전체"];

    const key = "teacherTasks-" + date;
    const existingDataRaw = localStorage.getItem(key);
    let existingData = null;
    if (existingDataRaw) {
      try {
        existingData = JSON.parse(existingDataRaw);
      } catch {
        existingData = null;
      }
    }

    let mergedTasks = [];
    let mergedStudents = [];

    if (existingData) {
      mergedTasks = Array.from(new Set(existingData.tasks.concat(newTasks)));
      mergedStudents = Array.from(new Set(existingData.students.concat(students)));
    } else {
      mergedTasks = newTasks;
      mergedStudents = students;
    }

    const data = {
      tasks: mergedTasks,
      repeat: repeat,
      students: mergedStudents
    };

    localStorage.setItem(key, JSON.stringify(data));
    alert("저장되었습니다!");
    loadSavedTasks();
    renderCalendar();
    renderStudentStatus();
  }

  function loadSavedTasks() {
    const container = document.getElementById("task-storage");
    const filter = document.getElementById("filter-date").value;
    container.innerHTML = "";

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith("teacherTasks-")) {
        const date = key.replace("teacherTasks-", "");
        if (filter && filter !== date) continue;
        const data = JSON.parse(localStorage.getItem(key));
        const div = document.createElement("div");
        div.className = "saved-item";
        div.innerHTML = `<strong>${date}</strong> | 대상: ${data.students.join(", ")}<br>
          📌 ${data.tasks.join(", ")}<br>
          🔁 반복: ${data.repeat}<br>
          <button onclick="copyTask('${date}')">📄 복사</button>
          <button onclick="deleteTask('${date}')">❌ 삭제</button>`;
        container.appendChild(div);
      }
    }
  }

  function deleteTask(date) {
    if (!confirm("삭제하시겠습니까?")) return;

    localStorage.removeItem("teacherTasks-" + date);
    loadSavedTasks();
    renderCalendar();
    renderStudentStatus();
  }

  function copyTask(date) {
    const data = JSON.parse(localStorage.getItem("teacherTasks-" + date));
    const taskList = document.getElementById("task-list");
    taskList.innerHTML = "";
    data.tasks.forEach(task => {
      const div = document.createElement("div");
      div.className = "task-input";
      div.innerHTML = `<input type="text" value="${task}" /><button onclick="removeTask(this)">⊖</button>`;
      taskList.appendChild(div);
    });
    document.getElementById("task-date").value = date;
    document.getElementById("repeat").value = data.repeat;
    document.getElementById("target").value = data.students.includes("전체") ? "all" : "selected";
    document.getElementById("student-checkboxes").style.display = data.students.includes("전체") ? "none" : "block";
    if (!data.students.includes("전체")) {
      document.querySelectorAll("#student-checkboxes input").forEach(input => {
        input.checked = data.students.includes(input.value);
      });
    }
  }

  function renderCalendar() {
    const tbody = document.getElementById("calendar-body");
    tbody.innerHTML = "";

    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();

    const firstDay = new Date(year, month, 1);
    const startDay = firstDay.getDay();

    const lastDate = new Date(year, month + 1, 0).getDate();

    let allAssignments = [];

    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith("teacherTasks-")) {
        const date = key.replace("teacherTasks-", "");
        const data = JSON.parse(localStorage.getItem(key));
        if(data.repeat === "daily") {
          for(let d=1; d<=lastDate; d++) {
            allAssignments.push({date: `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, tasks: data.tasks});
          }
        } else if (["mon","tue","wed","thu","fri"].includes(data.repeat)) {
          const dayMap = {mon:1,tue:2,wed:3,thu:4,fri:5};
          for(let d=1; d<=lastDate; d++) {
            const day = new Date(year, month, d).getDay();
            if(day === dayMap[data.repeat]) {
              allAssignments.push({date: `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, tasks: data.tasks});
            }
          }
        } else {
          allAssignments.push({date: date, tasks: data.tasks});
        }
      }
    }

    let html = "<tr>";
    for(let i=0; i<startDay; i++) {
      html += "<td></td>";
    }

    for(let day=1; day<=lastDate; day++) {
      const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const tasksForDay = allAssignments.filter(a => a.date === dateStr).flatMap(a => a.tasks);
      const taskHtml = tasksForDay.map(t => `<div style="background:#f6c1c1; border-radius:6px; padding:2px; margin-top:2px; font-size:12px;">${t}</div>`).join("");

      html += `<td><strong>${day}</strong>${taskHtml}</td>`;

      if((startDay + day) % 7 === 0) {
        html += "</tr><tr>";
      }
    }

    html += "</tr>";
    tbody.innerHTML = html;
  }

  function renderStudentStatus() {
    const container = document.getElementById("student-status-list");
    container.innerHTML = "";

    const students = ["학생1", "학생2", "학생3"];
    let allAssignments = [];

    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.startsWith("teacherTasks-")) {
        const data = JSON.parse(localStorage.getItem(key));
        allAssignments.push(data);
      }
    }

    students.forEach(student => {
      const div = document.createElement("div");
      div.style.border = "2px solid #aaa";
      div.style.padding = "10px";
      div.style.borderRadius = "16px";
      div.style.marginBottom = "10px";

      div.innerHTML = `👦 ${student}<div style="margin-top: 10px;">`;

      allAssignments.forEach(assign => {
        let tasks = assign.tasks;
        let assigned = assign.students.includes("전체") || assign.students.includes(student);

        tasks.forEach(task => {
          const color = assigned ? "#f6c1c1" : "transparent";
          div.innerHTML += `<div style="border: 1px solid #888; background: ${color}; padding: 8px; border-radius: 12px; margin: 6px 0;">${task}</div>`;
        });
      });

      div.innerHTML += "</div>";
      container.appendChild(div);
    });
  }

  // 초기 로딩
  loadSavedTasks();
  renderCalendar();
  renderStudentStatus();

  function showList() {
    document.getElementById("teacher-list").style.display = "block";
    document.getElementById("calendar").style.display = "none";
  }

  function showCalendar() {
    document.getElementById("teacher-list").style.display = "none";
    document.getElementById("calendar").style.display = "block";
    renderCalendar();
  }

  showList();
</script>
