<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³¼ì œ ë°°ì • (ì„ ìƒë‹˜)</title>

  <!-- í°íŠ¸: ì œëª©=Jua, ë³¸ë¬¸/ë²„íŠ¼=SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>

  
  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js"></script>

  <style>
    *{ box-sizing:border-box }
    html, body { min-height:100% }

    /* ================================
       ë°°ê²½ & ê¸°ë³¸ íƒ€ì´í¬
       ================================ */
    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);

      /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ ê·¸ë˜í”½ */
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));

      /* ìƒë‹¨ ë¡œê³ ì¹© ê³µê°„ í™•ë³´ + ê°€ìš´ë° ì •ë ¬ */
      padding:96px 16px 40px;
      display:flex;
      justify-content:center;
      align-items:flex-start;   /* ì„¸ë¡œ ê°€ìš´ë° ê³ ì • ë°©ì§€ */
      overflow-y:auto;          /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
    }

    /* ë°°ê²½ì˜ êµ¬ë¦„ */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.9;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }

    /* ================================
       ê°€ìš´ë° ì¹´ë“œ ì»¨í…Œì´ë„ˆ
       ================================ */
    .container{
      max-width:960px;
      width:100%;
      background:var(--card);
      border:1px solid var(--card-line);
      border-radius:26px;
      box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:28px 24px 32px;

      /* ê¸´ ë‚´ìš© ëŒ€ì‘ */
      height:auto;
      overflow-wrap:break-word;
    }

    /* ================================
       ê³µí†µ ì œëª©/ì„¹ì…˜
       ================================ */
    h2, h3 { margin:0 0 14px; }
    h2{
      text-align:center;
      font-family:'Jua',sans-serif;
      font-weight:400;
      letter-spacing:-.2px;
    }
    section{ margin-top:26px; }

    /* ================================
       ì…ë ¥/ì…€ë ‰íŠ¸/ë²„íŠ¼ ê³µí†µ
       ================================ */
    input[type="text"],
    input[type="password"],
    input[type="date"],
    select{
      padding:10px 12px;
      border:2px solid #dcdfe4;
      border-radius:14px;
      outline:none;
      font:inherit;
      background:#fff;
    }
    input:focus, select:focus{
      border-color:#b9c7c5;
      box-shadow:0 0 0 4px rgba(185,199,197,.28);
    }
    button{
      padding:10px 14px;
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--card-line);
      background:#fff;
      font:inherit;
    }
    .btn-primary{
      color:#fff;
      background:var(--brand);
      border-color:var(--brand);
      box-shadow:0 12px 28px var(--btn-shadow);
    }

    /* ================================
       ê³¼ì œ ì…ë ¥ í–‰
       ================================ */
    .task-input{
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .task-input input{ flex:1; }

    /* í•™ìƒ ì²´í¬ë°•ìŠ¤ ë¼ë²¨ */
    .student-checkboxes label{
      display:inline-block;
      margin:6px 8px 0 0;
      padding:6px 10px;
      border:1px solid #e6e8eb;
      border-radius:12px;
      background:#fff;
    }

    /* ì €ì¥ë‚´ì—­/í•™ìƒì¹© */
    .saved-item, .student-item{
      border-top:1px dashed #d5d5d5;
      padding-top:8px;
      margin-top:10px;
    }

    /* ì¢…ë¥˜ í† ê¸€ */
    .type-toggle{ display:flex; gap:6px; align-items:center; }
    .type-toggle button{
      height:36px; padding:0 12px; border-radius:12px;
      border:1px solid var(--card-line); background:#fff; cursor:pointer;
    }
    .type-toggle button.is-active{
      background:var(--brand); color:#fff; border-color:var(--brand);
    }

    /* ë°˜ë³µ ë²”ìœ„ */
    .repeat-range{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .repeat-range input{ height:40px; padding:6px 10px; border:2px solid #dcdfe4; border-radius:12px; }

    /* ì„¤ëª… */
    .desc-wrap{ display:flex; flex-direction:column; gap:8px; }
    .task-desc{
      width:100%; border:2px solid #dcdfe4; border-radius:12px; padding:10px; resize:vertical;
    }

    /* í•™ìƒ ì¹´ë“œ í† ê¸€ */
    .student-card-grid{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .student-card{
      border:1px solid #e6e8eb; border-radius:12px; padding:8px 12px;
      background:#fff; cursor:pointer; user-select:none;
    }
    .student-card.is-selected{
      background:#2e7d57; color:#fff; border-color:#2e7d57;
    }

    /* ë‹¬ë ¥ pill ìƒíƒœ  */
    .task-pill{ background:#fff; border-radius:10px; padding:4px 8px; margin-top:6px;
               font-size:12px; cursor:pointer; display:inline-block; border:1px solid rgba(0,0,0,.06); }
    .task-pill.pending{ background:#f6c1c1; border-color:#e9b3b3; }
    .task-pill.done{ background:#fff; border-color:#dfe3e6; }

    .event-pill{
      margin-top:6px;
      font-size:12px;
      cursor:pointer;
      display:inline-block;
    }
    /* ================================
       ë‹¬ë ¥ ìŠ¤íƒ€ì¼
       ================================ */
    .calendar{ display:none; }
    .calendar table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    .calendar th, .calendar td{
      border:1px solid #ececec;
      width:14.28%;
      height:96px;
      text-align:left;
      vertical-align:top;
      padding:8px;
      font-size:14px;
    }
    .calendar thead th{ background:#f9fafb; }
    .calendar td > strong{ display:block; margin-bottom:6px; }
    
    /* ìš”ì¼ í—¤ë” ê°€ìš´ë° ì •ë ¬ + ë†’ì´ ì¤„ì´ê¸° */
    .calendar thead th{
      text-align:center;
      height: 36px;            /* ê¸°ì¡´ë³´ë‹¤ ë‚®ê²Œ */
      padding: 6px 0;          /* íšŒìƒ‰ì¹¸ ë†’ì´ ì¶•ì†Œ */
      vertical-align:middle;
    }
    
    /* ì£¼ë§ ìš”ì¼ ë¹¨ê°„ìƒ‰ */
    .calendar thead th.sat,
    .calendar thead th.sun{
      color:#d33;              /* ë¹¨ê°„ìƒ‰ */
      font-weight:600;
    }
    
    /* ë‚ ì§œ ìˆ«ì(ì™¼ìª½ êµµì€ ìˆ«ì) ìŠ¤íƒ€ì¼ */
    .calendar td > strong{
      display:inline-block;
      margin-right:6px;
    }
    
    /* í† /ì¼(weekend), ê³µíœ´ì¼, ë°©í•™ì¸ ë‚ ì˜ 'ìˆ«ì' ë¹¨ê°„ìƒ‰ */
    .calendar td.weekend > strong,
    .calendar td.holiday > strong,
    .calendar td.vacation > strong{
      color:#d33;
    }
    
    /* ê³µíœ´ì¼/ë°©í•™ ë¼ë²¨ (ìˆ«ì ì˜†ì— ë¶™ëŠ” í…ìŠ¤íŠ¸) */
    .calendar .day-label{
      font-size:12px;
      font-weight:600;
      color:#d33;
      margin-left:4px;
      white-space:nowrap;
    }

    /* ë‹¬ë ¥ ê³¼ì œ pill */
    .task-pill{
      background:#f6c1c1;
      border-radius:10px;
      padding:4px 8px;
      margin-top:6px;
      font-size:12px;
      cursor:pointer;
      display:inline-block;
      border:1px solid rgba(0,0,0,.06);
    }
    .task-pill:hover{ opacity:.9; }

    /* ì„ íƒ ì•ˆë‚´/ë²„íŠ¼ ì˜ì—­ */
    #task-action-selected{ margin:10px 0; font-size:14px; color:#555; }

    /* ================================
       ê³¼ì œë³„ ì™„ë£Œ ì—¬ë¶€(ì¹©)
       ================================ */
    .student-chip-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .student-chip{
      border:1px solid #e6e8eb;
      border-radius:12px;
      padding:10px 12px;
      min-width:92px;
      text-align:center;
      background:#fff;
    }
    .student-chip.missed{
      background:#f6c1c1;
      border-color:#e9b3b3;
    }

    .student-chip.postponed{
      background:#fddf7f;
      border-color:#f0c24c;
      color:#604400;
    }

    /* ================================
       í•™ìƒ ê´€ë¦¬ í‘œ
       ================================ */
    #student-list{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
    }
    #student-list col:nth-child(1){ width: 8ch; }
    #student-list col:nth-child(2){
      width:auto;
      min-width: 14rem;
    }
    #student-list col:nth-child(3){ width: 14ch; }
    #student-list col:nth-child(4){ width: 7ch;  }
    #student-list col:nth-child(5){ width: 16ch; }

    #student-list th, #student-list td{
      border:1px solid #ccc;
      padding:6px;
      text-align:center;
      vertical-align:middle;
    }
   
    /* í‘œ ì•ˆ ì…ë ¥ì¹¸ ë‘¥ê¸€ê²Œ + ë™ì¼ ìŠ¤íƒ€ì¼ */
    #student-list td input[data-field="id"],
    #student-list td input[data-field="name"],
    #student-list td input[data-field="password"]{
      width:100%;
      height:36px;             
      padding:6px 10px;
      border:2px solid #dcdfe4;
      border-radius:14px;        /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
      background:#fff;
      box-sizing:border-box;
      display:block;
      margin:0;
    }
    #student-list td.col-actions .actions{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
    }
    /* ë²ˆí˜¸ ì…ë ¥ì€ ê°€ìš´ë° ì •ë ¬*/
    #student-list td input[data-field="id"]{
      text-align:center;
    }
    #student-list td.col-actions .actions button{
      height:32px;
      padding:0 12px;
    }
    @media (max-width: 520px){
      #student-list col:nth-child(4){ width: 6ch; }
      #student-list col:nth-child(5){ width: 14ch; }
    }
    .table-wrap{ overflow-x:auto; }

    /* ë²„íŠ¼ ì¤„ í•œ ì¤„ ì •ë ¬ */
    #task-action-buttons{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    #task-action-buttons button{
      height:36px;
      padding:0 14px;
    }

    /* ìš”ì¼ ê°€ìš´ë° ì •ë ¬ + ë†’ì´ ì¤„ì´ê¸° */
    . th { text-align:center; height: 36px; padding:6px 0; }
    /* í† /ì¼ & ê³µíœ´ì¼/ë°©í•™ í‘œì‹œìš© */
    .calendar td .day-num { font-weight:600; }
    .calendar td.sun  .day-num,
    .calendar td.sat  .day-num { color:#d74b4b; }     /* ì£¼ë§ ë¹¨ê°• */
    .calendar td.holiday .day-num,
    .calendar td.vacation .day-num { color:#d74b4b; } /* ê³µíœ´ì¼/ë°©í•™ ë¹¨ê°• */
   
    .badge-holiday, .badge-vacation{
      display:inline-block;
      margin-left:6px;
      font-size:12px;
      padding:0;                 /* ì—¬ë°± ì œê±° */
      border-radius:0;           /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ì œê±° */
      background:transparent;    /* ë°°ê²½ ì œê±° */
      color:#d33;                /* ê¸€ìë§Œ ë¹¨ê°„ìƒ‰ */
      font-weight:600;           /* ì¡°ê¸ˆ êµµê²Œ(ì„ íƒ) */
      border:none;               /* í˜¹ì‹œ ëª¨ë¥¼ í…Œë‘ë¦¬ ì œê±° */
      box-shadow:none;           /* ê·¸ë¦¼ì ì œê±° */
    }
    /* (ì„ íƒ) í† /ì¼ ìš”ì¼ ë¨¸ë¦¬ê¸€ë„ ë¹¨ê°„ìƒ‰ */
    . th:nth-child(6),
    .calendar thead th:nth-child(7) { color:#d74b4b; }
    
    /* ===== í•™ìƒ ì¶”ê°€ ì˜ì—­ ì¼ë ¬ ì •ë ¬ & í†µì¼ ===== */
    .teacher-page { --ctrl-h: 36px; }
    
    .add-student-row {
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      flex-wrap:nowrap;
    }
    
    .add-student-row input {
      height:var(--ctrl-h);
      padding:6px 10px;
      border:2px solid #dcdfe4;
      border-radius:12px;
      font:inherit;
      background:#fff;
      box-sizing:border-box;
    }
    
    /* ê° ì…ë ¥ì¹¸ í­ */
    #new-student-id { width:72px; text-align:center; }
    #new-student-name { flex:1 1 200px; min-width:140px; }
    #new-student-password { width:160px; }
    
    /* ì¶”ê°€ ë²„íŠ¼ í†µì¼ */
    .add-student-row button {
      height:var(--ctrl-h);
      border-radius:12px;
      padding:0 16px;
    }

    /* ì ‘ê·¼ì„± ìˆ¨ê¹€ ë¼ë²¨(ì•„ì´ì½˜ë§Œ ì“°ëŠ” ê³³) */
.sr { position: absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }

/* ë‘ ì¤„ í¼ ë ˆì´ì•„ì›ƒ */
.task-form { display:flex; flex-direction:column; gap:12px; }

/* ê° ì¤„ ê³µí†µ */
.task-row {
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;           /* ì¢ì€ í™”ë©´ì—ì„œ ìë™ ì¤„ë°”ê¿ˆ */
}

/* 1ì¤„: ë‚ ì§œëŠ” ì§§ê²Œ, í• ì¼ ì…ë ¥ì€ ê¸¸ê²Œ */
.task-row.row-1 #task-date { flex:0 0 180px; height:40px; }
.task-row.row-1 .task-list.inline { flex:1 1 auto; min-width:260px; }

/* task-list ë‚´ë¶€ ì…ë ¥í–‰ì€ ì„¸ë¡œë¡œ ìŒ“ì„ */
.task-list.inline { display:flex; flex-direction:column; gap:8px; }
.task-input { display:flex; gap:8px; }
.task-input input { flex:1 1 auto; height:40px; }
.task-input button { height:40px; padding:0 12px; }

/* 2ì¤„: select í¬ê¸° í†µì¼ */
.task-row.row-2 select { height:40px; min-width:160px; }

/* ë²„íŠ¼ í†µì¼ */
.task-row button { height:40px; padding:0 14px; border-radius:14px; border:1px solid var(--card-line); }
.btn-secondary { background:#f3f4f6; }
.btn-primary   { background:var(--brand); color:#fff; border-color:var(--brand); box-shadow:0 12px 28px var(--btn-shadow); }

/* ëª¨ë°”ì¼ì—ì„œ 1ì—´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë–¨ì–´ì§€ë„ë¡ */
@media (max-width: 560px){
  .task-row.row-1 #task-date { flex:0 0 140px; }
  .task-row.row-2 { gap:10px; }
}



    
    
  </style>
</head>
<body data-role="teacher" class="teacher-page">
  <!-- ìƒë‹¨ í’€ë°”(ì¹© ë²„íŠ¼í˜•) -->
  <header class="topbar">
    <div class="logo-area">
      <a href="./"><img src="logo.png" alt="ì˜¤ëŠ˜ í•  ì¼ ë¡œê³ "></a>
    </div>
    <nav class="menu-area" aria-label="ì£¼ìš” ë©”ë‰´">
      <button id="tab-status"  onclick="showStudentStatus()">ì˜¤ëŠ˜ í•  ì¼</button>
      <button id="tab-task"    onclick="showTaskManagement()">ê³¼ì œ ê´€ë¦¬</button>
      <button id="tab-student" onclick="showStudentManagement()">í•™ìƒ ê´€ë¦¬</button>
    </nav>
    <div class="right-tools">
      <button type="button" id="eventsBtn" class="mode-btn" aria-pressed="false">ì¼ì •ìˆ¨ê¹€</button>
      <button type="button" id="peToggleBtn" class="mode-btn" aria-pressed="false"></button>
      <button type="button" id="modeBtn" class="mode-btn" aria-pressed="false"></button>
    </div>
  </header>

  <!-- =====================================
       ê°€ìš´ë° ì¹´ë“œ ì»¨í…Œì´ë„ˆ
       ===================================== -->
  <div class="container">
    <!-- ===== ì˜¤ëŠ˜ í•  ì¼(í•™ìƒë³„ í˜„í™©) ===== -->
    <div id="student-status-page" style="display:none; margin-top: 8px;">
      <div id="events-strip-teacher" class="event-grid"></div>
      <div
        id="student-status-list"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;"
      ></div>
    </div>

    <!-- ===== ê³¼ì œ ê´€ë¦¬ + ë‹¬ë ¥ ===== -->
    <div id="task-management" style="display:none; margin-top: 8px;">
      
      <!-- ê³¼ì œ ì…ë ¥ ì˜ì—­ -->
      <section class="task-form">
        <!-- 1ì¤„: ë‚ ì§œ + í•  ì¼ ì…ë ¥(ê¸¸ê²Œ) + í•  ì¼ ì¶”ê°€ ë²„íŠ¼ -->
        <div class="task-row row-1">
        
          <!-- ì¢…ë¥˜ í† ê¸€ -->
          <div id="task-type-toggle" class="type-toggle" role="tablist" aria-label="ì¢…ë¥˜ ì„ íƒ">
            <button type="button" data-type="event" aria-pressed="false">ì¼ì •</button>
            <button type="button" data-type="assignment" aria-pressed="true" class="is-active">ê³¼ì œ</button>
            <button type="button" data-type="challenge" aria-pressed="false">ë„ì „</button>
            <input type="hidden" id="task-type" value="assignment">
          </div>
          
          <label for="task-date" class="sr">ğŸ“… ë‚ ì§œ</label>
          <input type="text" id="task-date" inputmode="none" autocomplete="off" />
          
          <div id="task-list" class="task-list inline">
            <div class="task-input">
              <input type="text" placeholder="í•  ì¼ ì…ë ¥" />
              <button type="button" onclick="removeTask(this)">âŠ–</button>
            </div>
          </div>
          
          <button type="button" class="btn-secondary" onclick="addTask()">+ í•  ì¼ ì¶”ê°€</button>
        </div>

        <!-- ì„¤ëª… í† ê¸€ & ì…ë ¥ -->
        <div class="desc-wrap">
          <button type="button" id="desc-toggle" class="btn-secondary">ì„¤ëª… ì¶”ê°€</button>
          <textarea id="task-desc" class="task-desc" rows="3" placeholder="(ì„ íƒ) ì°¸ê³ ìë£Œ/í†µê³¼ê¸°ì¤€ ë“±" style="display:none;"></textarea>
        </div>
        
        <!-- 2ì¤„: ë°˜ë³µ ì„¤ì • + ëŒ€ìƒ ì„ íƒ + ì €ì¥ -->
        <div class="task-row row-2">
          <label for="repeat">ğŸ” ë°˜ë³µ ì„¤ì •</label>
          
          <select id="repeat">
            <option value="none">ì—†ìŒ</option>
            <option value="daily">ë§¤ì¼</option>
            <option value="mon">ë§¤ì£¼ ì›”ìš”ì¼</option>
            <option value="tue">ë§¤ì£¼ í™”ìš”ì¼</option>
            <option value="wed">ë§¤ì£¼ ìˆ˜ìš”ì¼</option>
            <option value="thu">ë§¤ì£¼ ëª©ìš”ì¼</option>
            <option value="fri">ë§¤ì£¼ ê¸ˆìš”ì¼</option>
          </select>

          <!-- ë°˜ë³µ ë²”ìœ„ (ë°˜ë³µ ì„ íƒ ì‹œ ë³´ì´ê¸°) -->
          <div id="repeat-range" class="repeat-range" style="display:none;">
            <label for="task-start">ì‹œì‘</label>
            <input type="text" id="task-start" inputmode="none" placeholder="YYYY-MM-DD (ìš”ì¼)">
            <label for="task-end">ì¢…ë£Œ</label>
            <input type="text" id="task-end" inputmode="none" placeholder="ì„ íƒ(ì—†ìœ¼ë©´ ë¬´ê¸°í•œ)">
          </div>
          
          <label for="target">ğŸ‘¥ ëŒ€ìƒ ì„ íƒ</label>
          <select id="target">
            <option value="all">ì „ì²´ í•™ìƒ</option>
            <option value="selected">íŠ¹ì • í•™ìƒ ì§€ì •</option>
          </select>
          
          <button type="button" class="btn-primary" onclick="saveAssignment()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
        </div>
        
        <!-- íŠ¹ì • í•™ìƒ ì§€ì •: ì¹´ë“œ í† ê¸€ -->
        <div id="student-selector" class="student-card-grid" style="display:none;"></div>
      </section>


      <!-- ë‹¬ë ¥ -->
      <section class="calendar" style="margin-top:20px;">

        <div id="cal-controls" style="display:flex;align-items:center;gap:8px;margin:8px 0 4px;">
          <button type="button" onclick="changeMonth(-1)">â—€</button>
          <div id="cal-label" style="font-weight:600;min-width:120px;text-align:center;"></div>
          <button type="button" onclick="changeMonth(1)">â–¶</button>
          <button type="button" onclick="goToday()" style="margin-left:8px;">ì˜¤ëŠ˜</button>
        </div>

        <table>
          <thead>
            <tr>
                <th class="mon">ì›”</th>
              <th class="tue">í™”</th>
              <th class="wed">ìˆ˜</th>
              <th class="thu">ëª©</th>
              <th class="fri">ê¸ˆ</th>
              <th class="sat">í† </th>
              <th class="sun">ì¼</th></tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </section>
      
      <section style="margin-top:16px;">
        <h3>íœ´ì¼ ê´€ë¦¬</h3>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
          <input type="text" id="vac-name" placeholder="ì˜ˆ: ì—¬ë¦„ë°©í•™" style="flex:1 1 180px;">
          <input type="date" id="vac-start">
          <input type="date" id="vac-end">
          <button class="btn-primary" id="vac-add-btn" onclick="addVacation()">ì¶”ê°€</button>
          <button id="vac-cancel-btn" onclick="cancelEditVacation()" style="display:none;">ì·¨ì†Œ</button>
        </div>
        <div id="vac-list" style="margin-top:10px;"></div>
      </section>

      <!-- ê³¼ì œ ì„ íƒ ì•ˆë‚´ + ì•¡ì…˜ ë²„íŠ¼ -->
      <div id="task-action-selected"></div>
      <div id="task-action-buttons" style="margin-top:10px; display:none;">
        <button class="btn-primary" onclick="closeTaskCompletion()">ë‹«ê¸°</button>
        <button class="btn-primary" onclick="editTask()">ìˆ˜ì •</button>
        <button class="btn-primary" onclick="deleteTaskClicked()">ì‚­ì œ</button>
      </div>

      <!-- ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€ -->
      <div id="task-completion" style="margin-top:20px; display:none;">
        <h3>ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€</h3>
        <div id="completion-list"></div>
      </div>
    </div>


    <!-- ===== í•™ìƒ ê´€ë¦¬ ===== -->
    <div id="student-management" style="display:none; margin-top:20px;">

      <!-- í•™ìƒ ì¶”ê°€ í¼ -->
      <div class="add-student-row">
        <input type="text" id="new-student-id" placeholder="ë²ˆí˜¸">
        <input type="text" id="new-student-name" placeholder="ì´ë¦„">
        <input type="password" id="new-student-password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button type="button" class="btn-primary" onclick="addStudent()">ì¶”ê°€</button>
      </div>

      <!-- ì „ì²´ ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€ -->
      <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
        <label>
          <input type="checkbox" id="show-all-passwords" onchange="toggleAllPw(this)">
          ë¹„ë°€ë²ˆí˜¸ ëª¨ë‘ ë³´ê¸°
        </label>
      </div>

      <!-- í•™ìƒ ëª©ë¡ í‘œ -->
      <table id="student-list" border="1" style="margin-top:10px; width: 100%; border-collapse:collapse;">
        <colgroup>
          <col><!-- ë²ˆí˜¸ -->
          <col><!-- ì´ë¦„ -->
          <col><!-- ë¹„ë°€ë²ˆí˜¸ -->
          <col><!-- ë³´ê¸° -->
          <col><!-- ì‘ì—… -->
        </colgroup>
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th>ë¹„ë°€ë²ˆí˜¸</th>
            <th>ë³´ê¸°</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===========================================================
       ìŠ¤í¬ë¦½íŠ¸ (ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / ê°€ë…ì„± ìˆê²Œ ì •ë¦¬ + ì£¼ì„ ì œëª© ì¶”ê°€)
       =========================================================== -->
  <script>
    // ===========================================================
    // ì „ì—­ ìƒíƒœ
    // ===========================================================
    let selectedDate = null;
    let selectedTaskIndex = null;
    let selectedTaskText = "";
    let selectedOriginDate = null;
    let selectedOriginKey = null;
    let isEditing = false;
    let editingOriginalDate = null;
    let selectedUid = null;

    let calendarRefs = {};

    let viewYear  = (new Date()).getFullYear();
    let viewMonth = (new Date()).getMonth(); // 0=1ì›”, 11=12ì›”

    function setCalLabel(){
      const label = document.getElementById('cal-label');
      if (!label) return;
      label.textContent = `${viewYear}ë…„ ${viewMonth+1}ì›”`;
    }

    function changeMonth(delta){
      viewMonth += delta;
      if (viewMonth < 0) { viewMonth = 11; viewYear--; }
      if (viewMonth > 11){ viewMonth = 0;  viewYear++; }
      renderCalendar();
      hideActionUI();
    }

    function goToday(){
      const today = new Date();
      viewYear  = today.getFullYear();
      viewMonth = today.getMonth();
      renderCalendar();
      hideActionUI();
    }

    

    // ===========================================================
    // ìœ í‹¸ë¦¬í‹°: í•™ìƒ ì •ë ¬/ë¼ë²¨
    // ===========================================================
   
    function getStudentsSorted() { return sortStudents(loadStudents()); }
    function labelOf(stu) { return `${stu.id} ${stu.name}`; }

     // ===========================================================
    // ì¼ì •: íŠ¹ì • ë‚ ì§œì— ë°œìƒ ì—¬ë¶€
    // ===========================================================
    function occursOn(t, dateObj) {
      const d0 = new Date(dateObj); d0.setHours(0,0,0,0);
      const y = d0.getFullYear(), m = d0.getMonth()+1, dd = d0.getDate();
      const dateStr = `${y}-${pad2(m)}-${pad2(dd)}`;

      const s = t.repeatStart || t.date || "";
      const e = t.repeatEnd   || "";

      const inRange = (ds) => {
        if (s && ds < s) return false;
        if (e && ds > e) return false;
        return true;
      };

      const rpt = t.repeat || 'none';
      if (rpt === 'daily') return inRange(dateStr);

      const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
      if (dayMap[rpt] != null) {
        if (!inRange(dateStr)) return false;
        return d0.getDay() === dayMap[rpt];
      }
      if (!t.date) return false;
      const base = new Date(t.date); base.setHours(0,0,0,0);
      return base.getTime() === d0.getTime();
    }


    // ===========================================================
    // ì´ˆê¸°í™”: ì²« í™”ë©´ì€ 'ì˜¤ëŠ˜ í•  ì¼'
    // ===========================================================
    window.onload = function () {
      if (typeof migrateToUIDOnce === 'function') migrateToUIDOnce();
      showStudentStatus();
    };

    // ===========================================================
    // ìƒë‹¨ í’€ë°”: í™œì„± íƒ­ í‘œì‹œ í•¨ìˆ˜
    // ===========================================================
    function setActiveTab(key){
      const map = {
        status:  document.getElementById('tab-status'),
        task:    document.getElementById('tab-task'),
        student: document.getElementById('tab-student')
      };
      Object.values(map).forEach(btn => btn && btn.classList.remove('active'));
      if (map[key]) map[key].classList.add('active');
    }

    // ===========================================================
    // í™”ë©´ ì „í™˜: íƒ­ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    // ===========================================================
    function showStudentStatus() {
      renderEventsStrip('events-strip-teacher', { editable: true }); // ì„ ìƒë‹˜ í™”ë©´: ìˆ˜ì • ê°€ëŠ¥
      setActiveTab('status');
      document.getElementById("student-status-page").style.display = "block";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "none";
      hideActionUI();
      renderStudentStatus();
    }

    function showTaskManagement() {
      setActiveTab('task');
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "block";
      document.getElementById("student-management").style.display = "none";
      renderCalendar();
      hideActionUI();
      renderStudentSelector();
      renderVacationList();
      cancelEditVacation();
      const calendarSection = document.querySelector("#task-management section.calendar");
      if (calendarSection) calendarSection.style.display = "block";
    }

    function showStudentManagement() {
      setActiveTab('student');
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "block";
      hideActionUI();
      renderStudentList();
    }

    
    // ===========================================================
    // í•™ìƒ ì²´í¬ë°•ìŠ¤ ë Œë”ë§(ê³¼ì œ ëŒ€ìƒ ì§€ì •ìš©)
    // ===========================================================
    function renderStudentListToCheckbox(){ /* ì‚¬ìš© ì•ˆí•¨: í˜¸í™˜ ìœ„í•´ ë‚¨ê²¨ë„ OK */ }
    
    function renderStudentSelector(){
      const grid = document.getElementById("student-selector");
      if(!grid) return;
      grid.innerHTML = "";
      const students = getStudentsSorted(); // [{id,name,...}]
      students.forEach(stu=>{
        const card = document.createElement('div');
        card.className = 'student-card';
        card.dataset.name = stu.name;
        card.textContent = `${stu.id} ${stu.name}`;
        grid.appendChild(card);
      });
      grid.onclick = (e)=>{
        const card = e.target.closest('.student-card');
        if(!card) return;
        card.classList.toggle('is-selected');
      };
    }
    
    // target ì„ íƒì— ë”°ë¼ ì¹´ë“œ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸°
    document.getElementById("target").addEventListener("change", function () {
      const grid = document.getElementById("student-selector");
      const show = this.value === "selected" && !document.getElementById('task-type')?.value.includes('event');
      grid.style.display = show ? "flex" : "none";
    });


    document.getElementById("repeat").addEventListener("change", function(){
      const show = this.value !== "none";
      document.getElementById("repeat-range").style.display = show ? "flex" : "none";
      applyTypeEffects();
    });


    // ===========================================================
    // ê³¼ì œ ì™„ë£Œ ì €ì¥/ì¡°íšŒ (í•™ìƒë³„)
    // ===========================================================
    function getDoneTasks(student) {
      return getJSON("doneTasks-" + student, {});
    }
    function setDoneTasks(student, doneTasks) {
      setJSON("doneTasks-" + student, doneTasks);
    }
    
    // UID ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½
    function isDone(studentName, uid) {
      const store = getDoneTasks(studentName) || {};
      return store[uid] === true;
    }
    function setDone(studentName, uid, done) {
      const store = getDoneTasks(studentName) || {};
      if (done) store[uid] = true; else delete store[uid];
      setDoneTasks(studentName, store);
    }


    // ===========================================================
    // ê³¼ì œ ì…ë ¥ í–‰ ì¶”ê°€/ì‚­ì œ
    // ===========================================================
    function addTask() {
      const div = document.createElement("div");
      div.className = "task-input";
      div.innerHTML =
        '<input type="text" placeholder="í•  ì¼ ì…ë ¥" />' +
        '<button onclick="removeTask(this)">âŠ–</button>';
      document.getElementById("task-list").appendChild(div);
    }
    function removeTask(btn) { btn.parentElement.remove(); }
    
    // ì›”ìš”ì¼ ì‹œì‘, í¬ë§·ì€ ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ 'YYYY-MM-DD'
      function setupDatePicker(sel, opts={}){
        if (typeof window.flatpickr !== 'function') {
          const el = document.querySelector(sel);
          if (el) el.type = 'date';
          return;
        }
        return flatpickr(sel, {
          dateFormat:"Y-m-d",           // ì €ì¥ìš©(ê°’)
          altInput:true,
          altFormat:"Y-m-d (D)",        // í‘œì‹œìš©: 2025-03-10 (ì›”)
          locale:{...flatpickr.l10ns.ko, firstDayOfWeek:1},
          disableMobile:true,
          ...opts
        });
      }

      // ë‹¨ì¼ ë‚ ì§œ(ë¹„ë°˜ë³µ) - ê¸°ë³¸ ì˜¤ëŠ˜
      setupDatePicker("#task-date", { defaultDate:new Date() });
      // ë°˜ë³µ ë²”ìœ„
      const fpStart = setupDatePicker("#task-start", { defaultDate:new Date() });
      const fpEnd   = setupDatePicker("#task-end");


    // ===========================================================
    // ê³¼ì œ ì €ì¥ (ì‹ ê·œ/í¸ì§‘ ëª¨ë“œ ê³µìš©)
    // ===========================================================
    function saveAssignment() {
  // ê¸°ë³¸ ê°’ë“¤ ì½ê¸°
  const type    = document.getElementById("task-type")?.value || "assignment"; // event | assignment | challenge
  const repeat  = document.getElementById("repeat").value;                     // none | daily | mon..fri
  const target  = document.getElementById("target").value;                     // all | selected
  const desc    = (document.getElementById("task-desc")?.value || "").trim();

  // í•  ì¼ë“¤ ìˆ˜ì§‘
  const newTasks = Array
    .from(document.querySelectorAll("#task-list input"))
    .map(i => i.value.trim())
    .filter(Boolean);
  if (newTasks.length === 0) { alert("ê³¼ì œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”."); return; }

  // ëŒ€ìƒ í•™ìƒ ê³„ì‚° (ì¼ì •=ì „ì²´ ê³ ì •)
  let students = [];
  if (type === "event") {
    students = ["ì „ì²´"];
  } else if (target === "selected") {
    students = Array.from(document.querySelectorAll("#student-selector .student-card.is-selected"))
      .map(el => el.dataset.name);
    if (students.length === 0) { alert("í•™ìƒì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”."); return; }
  } else {
    students = ["ì „ì²´"];
  }

  // ë‚ ì§œ/ë°˜ë³µ
  const baseDateInput = document.getElementById("task-date");
  const baseDate = baseDateInput ? baseDateInput.value : "";

  let saveDate = "";              // ì €ì¥ìš© ëŒ€í‘œ ë‚ ì§œ
  let repeatStart = "", repeatEnd = "";

  if (repeat !== "none") {
    repeatStart = document.getElementById("task-start")?.value || "";
    repeatEnd   = document.getElementById("task-end")?.value || "";
    if (!repeatStart) { alert("ë°˜ë³µ ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
    saveDate = repeatStart;       // ë°˜ë³µì˜ ëŒ€í‘œ ë‚ ì§œëŠ” 'ì‹œì‘ì¼'
  } else if (type !== "challenge") {
    // ë°˜ë³µ ì—†ìŒ + ë„ì „ ì•„ë‹˜(=ì¼ì •/ê³¼ì œ) â†’ ë‚ ì§œ í•„ìˆ˜
    if (!baseDate) { alert("ê³¼ì œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
    saveDate = baseDate;
  } else {
    // challenge: ë‚ ì§œ ì—†ì´ ì €ì¥
    saveDate = "";
  }

  // ì €ì¥
  const all = (typeof getTasks === "function") ? getTasks() : [];
  newTasks.forEach(text => {
    all.push({
      id: (typeof genUID === "function") ? genUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)),
      type,                 // event | assignment | challenge
      date: saveDate,       // ë°˜ë³µì´ë©´ ì‹œì‘ì¼, ë„ì „ì´ë©´ ë¹ˆ ë¬¸ìì—´
      text,
      desc,                 // ì„ íƒ ì„¤ëª…
      repeat,               // none | daily | mon..fri
      repeatStart: repeatStart || null,
      repeatEnd:   repeatEnd   || null,
      students: students.slice()
    });
  });
  (typeof setTasks === "function") ? setTasks(all) : localStorage.setItem("tasksV2", JSON.stringify(all));

  // í¼ ë¦¬ì…‹: ì…ë ¥ê°’/ì„¤ëª…/í•™ìƒ ì„ íƒ/ë°˜ë³µë²”ìœ„
  document.querySelectorAll("#task-list input[type='text']").forEach(i => i.value = "");
  const ta = document.getElementById("task-desc"); if (ta) ta.value = "";
  document.querySelectorAll("#student-selector .student-card.is-selected").forEach(el => el.classList.remove("is-selected"));
  if (repeat !== "none") {
    const s = document.getElementById("task-start"); if (s) s.value = "";
    const e = document.getElementById("task-end");   if (e) e.value = "";
  }

  alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
  renderCalendar?.();
  renderStudentStatus?.();
}



    // ===========================================================
    // ë‹¬ë ¥ ë Œë”ë§ (ë°˜ë³µ ê³¼ì œ ê³„ì‚° í¬í•¨)
    // ===========================================================
    async function renderCalendar() {
      const tbody = qs("#calendar-body");
      if (!tbody) return;
      tbody.innerHTML = "";
      calendarRefs = {};
  
      const year  = viewYear;
      const month = viewMonth;

      // ê³µíœ´ì¼/ë°©í•™
      let holidaysMap = {};
      try {
        const hm = await ensureHolidays(year, 'KR');
        holidaysMap = (hm && typeof hm === 'object') ? hm : {};
      } catch (e) {
        console.warn('[calendar] holiday fetch failed:', e);
        holidaysMap = {};
      }
      const vacations   = (typeof getVacations === 'function' ? getVacations() : []) || [];
      const isVacation = (dateStr) => {
        const v = vacations.find(v => v.start <= dateStr && dateStr <= v.end);
        return v ? v.name : null;
      };
      const firstDay         = new Date(year, month, 1);
      const startDay         = firstDay.getDay();
      const adjustedStartDay = (startDay + 6) % 7;   // ì›”=0 ê¸°ì¤€
      const lastDate         = new Date(year, month + 1, 0).getDate();

      // âœ… V2 ê³¼ì œ ë¡œë“œ
      const tasks = (typeof getTasks === 'function') ? getTasks() : [];

      // ì´ ë‹¬ì— í‘œì‹œí•  ì¸ìŠ¤í„´ìŠ¤ êµ¬ì„±
      const instancesMap = {}; // dateStr -> [{id,text,originDate}]
      const pushInst = (dateStr, t) => {
        (instancesMap[dateStr] ??= []).push({ id: t.id, text: t.text, originDate: t.date });
      };
      const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };

      tasks.forEach(t => {
        const rpt = t.repeat || 'none';

        // ë°˜ë³µ ë²”ìœ„ í—¬í¼
        const inRange = (dateStr) => {
          const s = t.repeatStart || t.date || ""; // ì‹œì‘ ê¸°ì¤€
          const e = t.repeatEnd   || "";           // ì¢…ë£Œ(ì˜µì…˜)
          if (s && dateStr < s) return false;
          if (e && dateStr > e) return false;
          return true;
        };

        if (rpt === 'daily') {
          for (let d=1; d<=lastDate; d++){
            const dateStr = `${year}-${pad2(month+1)}-${pad2(d)}`;
            if (!inRange(dateStr)) continue;
            pushInst(dateStr, t);
          }
        } else if (dayMap[rpt] != null) {
          for (let d=1; d<=lastDate; d++){
            const dateObj = new Date(year, month, d);
            if (dateObj.getDay() === dayMap[rpt]) {
              const dateStr = `${year}-${pad2(month+1)}-${pad2(d)}`;
              if (!inRange(dateStr)) continue;
              pushInst(dateStr, t);
            }
          }
        } else {
          // ë°˜ë³µ ì—†ìŒ: ì§€ì • ë‚ ì§œë§Œ
          const d = new Date(t.date);
          if (d.getFullYear() === year && d.getMonth() === month) {
            const dateStr = `${year}-${pad2(month+1)}-${pad2(d.getDate())}`;
            pushInst(dateStr, t);
          }
        }
      });

  // refs: ë‚ ì§œë³„ UID ë°°ì—´
  for (const [dateStr, arr] of Object.entries(instancesMap)) {
    calendarRefs[dateStr] = arr.map(x => x.id); // â˜… UIDë§Œ ë³´ê´€
  }

  // í‘œ HTML
  let html = "<tr>";
  for (let i=0; i<adjustedStartDay; i++) html += "<td></td>";

  for (let day=1; day<=lastDate; day++){
    const dateStr = `${year}-${pad2(month+1)}-${pad2(day)}`;
    const wd = new Date(year, month, day).getDay();
    const isSun = (wd === 0), isSat = (wd === 6);

    const holName = holidaysMap[dateStr] || null;
    const vacName = isVacation(dateStr);
    const badge = holName
      ? `<span class="badge-holiday">${escapeHTML(holName)}</span>`
      : (vacName ? `<span class="badge-vacation">${escapeHTML(vacName)}</span>` : '');

    const cls = [];
    if (isSun) cls.push('sun');
    if (isSat) cls.push('sat');
    if (holName) cls.push('holiday');
    if (vacName) cls.push('vacation');

    const pills = (instancesMap[dateStr] || []).map((inst, idx) => {
  const t = tasks.find(x => x.id === inst.id);
  if (!t) return '';

  // â–¼ ì¼ì •: ê²€ì€ ê¸€ì”¨, ë°°ê²½ ì—†ìŒ, í´ë¦­ ì‹œ ì„¤ëª…ë§Œ
  if (t.type === 'event') {
    const title = escapeHTML(t.text || '(ì œëª© ì—†ìŒ)');
    const desc  = escapeHTML((t.desc||'').trim() || 'ì„¤ëª… ì—†ìŒ');
    return `<div class="event-pill" onclick="alert('ğŸ“£ ${title}\\n\\n${desc}')">${title}</div>`;
  }

  // â–¼ ê³¼ì œ: ê¸°ì¡´ ë¡œì§ ìœ ì§€
  let assignedNames = getStudentsSorted().map(s=>s.name);
  if (t && !t.students.includes('ì „ì²´')) {
    const set = new Set(t.students);
    assignedNames = assignedNames.filter(n => set.has(n));
  }
  // [teacher.html] renderCalendar()ì˜ pills ê³„ì‚° ë¶€ë¶„ êµì²´
const anyIncomplete = assignedNames.some(name => {
  const st = (typeof getStatusFor==='function') ? getStatusFor(name, inst.id) : null;

  // ë©´ì œëŠ” ë¶„ëª¨/ì²´í¬ì—ì„œ ì œì™¸
  if (st && st.s === 'e') return false;

  // ë¯¸ë£¸ì€ í•´ë‹¹ í•™ìƒì—ê²Œ ì˜¤ëŠ˜ ì¸ìŠ¤í„´ìŠ¤ê°€ ì‚¬ì‹¤ìƒ 'ë‹¤ë¥¸ ë‚ ì§œë¡œ ì´ë™' â†’ ì˜¤ëŠ˜ ë¯¸ì™„ë£Œì—ì„œ ì œì™¸
  if (st && st.s === 'p') {
    if (st.du && st.du !== dateStr) return false;
    // ë§Œì•½ duê°€ ì´ ë‚ ì§œì™€ ê°™ë‹¤ë©´(=ì˜¤ëŠ˜ë¡œ ì¬ë°°ì •), ì´ë•ŒëŠ” ì¼ë°˜ ê³¼ì œë¡œ ì·¨ê¸‰
  }

  // ì™„ë£Œë©´ ì œì™¸
  if (st && st.s === 'd') return false;

  // ìƒíƒœê¸°ë¡ ì—†ìŒ â†’ pending
  return true;
});
      
  const cls = anyIncomplete ? 'task-pill pending' : 'task-pill done';

  return `<div class="${cls}" onclick="selectTask('${dateStr}', ${idx})">${escapeHTML(t.text)}</div>`;
}).join("");




    html += `<td class="${cls.join(' ')}">
      <strong class="day-num">${day}</strong>
      ${badge}
      ${pills}
    </td>`;

    if ((adjustedStartDay + day) % 7 === 0) html += "</tr><tr>";
  }
  html += "</tr>";
  tbody.innerHTML = html;
  setCalLabel();
}


    
    // ===========================================================
    // ê³¼ì œ í¸ì§‘/ì‚­ì œ/í™•ì¸
    // ===========================================================
    function editTask() {
  if (!selectedUid) { alert("ê³¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const all = getTasks();
  const t = all.find(x => x.id === selectedUid);
  if (!t) { alert("ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  // 1) í¼ ê°’ ì±„ìš°ê¸° (í…ìŠ¤íŠ¸ ì…ë ¥ í•œ ì¹¸ë§Œ)
  const taskList = document.getElementById('task-list');
  taskList.innerHTML = '';
  const div = document.createElement('div');
  div.className = 'task-input';
  div.innerHTML = `<input type="text" value="${t.text}"/><button onclick="removeTask(this)">âŠ–</button>`;
  taskList.appendChild(div);

  // ë‚ ì§œ/ë°˜ë³µ/ì„¤ëª…/íƒ€ì…
  document.getElementById('task-date').value = t.date || '';
  document.getElementById('repeat').value    = t.repeat || 'none';
  const descEl = document.getElementById('task-desc');
  if (descEl) descEl.value = t.desc || '';
  const typeHidden = document.getElementById('task-type');
  if (typeHidden) typeHidden.value = t.type || 'assignment';

  // ë°˜ë³µ ë²”ìœ„ UI ì±„ìš°ê¸°
  const rs = document.getElementById('task-start');
  const re = document.getElementById('task-end');
  if (rs) rs.value = t.repeatStart || '';
  if (re) re.value = t.repeatEnd || '';

  // ëŒ€ìƒ ë³µì›(ì„ íƒí˜• ì¹´ë“œ)
  const tgt = document.getElementById('target');
  const grid = document.getElementById('student-selector');
  if (t.students?.includes('ì „ì²´')) {
    tgt.value = 'all';
    if (grid) grid.style.display = 'none';
  } else {
    tgt.value = 'selected';
    if (grid) {
      grid.style.display = 'flex';
      const set = new Set(t.students || []);
      grid.querySelectorAll('.student-card').forEach(c=>{
        c.classList.toggle('is-selected', set.has(c.dataset.name));
      });
    }
  }

  // 2) ì €ì¥ ë²„íŠ¼ì„ 1íšŒìš© ì—…ë°ì´íŠ¸ë¡œ ì˜¤ë²„ë¼ì´ë“œ
  const origSave = saveAssignment;
  window.saveAssignment = function(){
    const texts = Array.from(document.querySelectorAll("#task-list input"))
                  .map(i=>i.value.trim()).filter(Boolean);
    if (!texts.length) { alert('ê³¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    const type   = document.getElementById('task-type')?.value || 'assignment';
    const repeat = document.getElementById('repeat').value;
    const desc   = (document.getElementById('task-desc')?.value || '').trim();

    // ëŒ€ìƒ ê³„ì‚°(ì¼ì •ì€ í•­ìƒ ì „ì²´)
    let students = [];
    if (type === 'event' || document.getElementById('target').value === 'all') {
      students = ['ì „ì²´'];
    } else {
      students = Array.from(document.querySelectorAll('#student-selector .student-card.is-selected'))
                  .map(el=>el.dataset.name);
      if (!students.length) { alert('í•™ìƒì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.'); return; }
    }

    // ë‚ ì§œì™€ ë°˜ë³µ ë²”ìœ„
    let saveDate = document.getElementById('task-date')?.value || '';
    let repeatStart = "", repeatEnd = "";
    if (repeat !== 'none'){
      repeatStart = document.getElementById('task-start')?.value || "";
      repeatEnd   = document.getElementById('task-end')?.value || "";
      if (!repeatStart){ alert("ë°˜ë³µ ì‹œì‘ì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
      saveDate = repeatStart;
    }

    const all = getTasks();
    const i = all.findIndex(x => x.id === selectedUid);
    if (i < 0) { alert("ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

    // í…ìŠ¤íŠ¸ëŠ” ì²« ë²ˆì§¸ë§Œ ë°˜ì˜(ì—¬ëŸ¬ ê°œëŠ” + ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€)
    all[i] = {
      ...all[i],
      type,
      text: texts[0],
      date: saveDate,
      desc,
      repeat,
      repeatStart: repeatStart || null,
      repeatEnd:   repeatEnd   || null,
      students: students.slice()
    };
    setTasks(all);

    // 3) ì •ë¦¬
    window.saveAssignment = origSave; // ì›ë³µ
    alert('ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
    renderCalendar(); hideActionUI(); renderStudentStatus();
  };

  window.scrollTo({ top: 0, behavior: 'smooth' });
}


function deleteTaskClicked() {
  if (!selectedUid) { alert("ê³¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”."); return; }
  const all = getTasks();
  const idx = all.findIndex(t => t.id === selectedUid);
  if (idx < 0) { alert("ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

  const targetText = all[idx].text;
  if (!confirm(`"${targetText}" ê³¼ì œë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;

  all.splice(idx, 1);
  setTasks(all);

  selectedUid = null;
  document.getElementById('task-action-buttons').style.display = 'none';

  renderCalendar();
  hideActionUI();
  renderStudentStatus();
}


    function closeTaskCompletion() { hideActionUI(); }

    // ===========================================================
    // ë‹¬ë ¥: ê³¼ì œ ì„ íƒ ì‹œ ìƒíƒœ ê°±ì‹ 
    // ===========================================================
    function selectTask(dateStr, idx) {
      selectedDate = dateStr;
      selectedUid = null;

      const uids = calendarRefs[dateStr] || [];
      const uid  = uids[idx];
      
      const $btns     = document.getElementById('task-action-buttons');
      const $selected = document.getElementById('task-action-selected');
      const $compBox  = document.getElementById('task-completion');

      if (!uid) {
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }

      const all = (typeof getTasks === 'function') ? getTasks() : [];
      const task = all.find(t => t.id === uid);
      if (!task) {
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }
      selectedUid = uid;

if ($selected) $selected.textContent = `ì„ íƒ: ${dateStr}`;  // ì œëª© ì˜ì—­ì€ ë‚ ì§œë§Œ

// ì¼ì •ì€ ì„¤ëª…ë§Œ ë³´ì—¬ì£¼ê¸°
if (task.type === 'event') {
  if ($compBox) {
    $compBox.style.display = 'block';
    // ì„¤ëª…ë§Œ ì¶œë ¥
    const box = document.getElementById('completion-list');
    if (box) {
      const desc = task.desc?.trim() ? escapeHTML(task.desc.trim()) : 'ì„¤ëª… ì—†ìŒ';
      box.innerHTML = `
        <h4 style="margin:0 0 8px;">ğŸ“£ ${escapeHTML(task.text)}</h4>
        <div style="color:#444; line-height:1.6;">${desc.replace(/\n/g,'<br>')}</div>
      `;
    }
  }
  if ($btns) $btns.style.display = 'flex';
  return;
}

// (ê³¼ì œ/ë„ì „ ê¸°ì¡´ ë¡œì§)
if (typeof renderTaskCompletion === 'function') renderTaskCompletion(uid);
if ($compBox) $compBox.style.display = 'block';
if ($btns) {
  $btns.style.display = 'flex';
  const parent = $compBox?.parentNode;
  if (parent && $compBox) parent.insertBefore($btns, $compBox.nextSibling);
}

    }

    // -----------------------------------------------------------
    // ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ êµ¬ì„± ë° ìœ í‹¸ë¦¬í‹°
    // -----------------------------------------------------------
    let _statusModal = null, _statusStudent = null, _statusUID = null;

    function refreshStatusUI(uid){
      if (typeof renderTaskCompletion === 'function') renderTaskCompletion(uid);
      if (typeof renderCalendar === 'function') renderCalendar();
      if (typeof renderStudentStatus === 'function') renderStudentStatus();
    }

    function closeStatusModal(){
      if (_statusModal) _statusModal.style.display = 'none';
      _statusStudent = null;
      _statusUID = null;
    }

    function ensureStatusModal(){
      if (_statusModal) return _statusModal;
      const modal = document.createElement('div');
      modal.id = 'statusModal';
      modal.style.display = 'none';
      modal.style.position = 'fixed';
      modal.style.inset = '0';
      modal.style.zIndex = '2000';
      modal.innerHTML = `
        <div class="modal-backdrop" style="position:absolute; inset:0; background:rgba(0,0,0,.35);"></div>
        <div class="modal-card" style="
          position:absolute; left:50%; top:20%; transform:translateX(-50%);
          width:min(420px, 92vw); background:#fff; border-radius:16px;
          box-shadow:0 20px 50px rgba(0,0,0,.18); padding:20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="margin:0; font-size:18px;">ìƒíƒœ ë³€ê²½</h3>
            <button type="button" id="statusModalClose" style="all:unset; cursor:pointer; font-size:20px;">Ã—</button>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;">
            <button type="button" id="statusDoneBtn" class="btn-primary">ì™„ë£Œ</button>
            <button type="button" id="statusUndoneBtn">ë¯¸ì™„ë£Œ</button>
          </div>
          <div style="margin-bottom:12px;">
            <div style="margin-bottom:4px;">ë¯¸ë£¸</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap;">
              <button type="button" class="postponeBtn" data-add="1">+1</button>
              <button type="button" class="postponeBtn" data-add="2">+2</button>
              <button type="button" class="postponeBtn" data-add="3">+3</button>
              <button type="button" class="postponeBtn" data-add="custom">ì§ì ‘ì…ë ¥</button>
            </div>
          </div>
          <div style="display:flex; gap:6px; align-items:center;">
            <input type="text" id="exemptReason" placeholder="ë©´ì œ ì‚¬ìœ (ì„ íƒ)" style="flex:1; height:38px; border:1px solid #dcdfe4; border-radius:10px; padding:0 10px; font:inherit;">
            <button type="button" id="statusExemptBtn">ë©´ì œ</button>
          </div>
        </div>`;
      document.body.appendChild(modal);
      modal.querySelector('.modal-backdrop').addEventListener('click', closeStatusModal);
      modal.querySelector('#statusModalClose').addEventListener('click', closeStatusModal);
      modal.querySelector('#statusDoneBtn').addEventListener('click', () => {
        if (!_statusStudent) return;
        setDone(_statusStudent, _statusUID, true);
        refreshStatusUI(_statusUID);
        closeStatusModal();
      });
      modal.querySelector('#statusUndoneBtn').addEventListener('click', () => {
        if (!_statusStudent) return;
        setDone(_statusStudent, _statusUID, false);
        refreshStatusUI(_statusUID);
        closeStatusModal();
      });
      modal.querySelectorAll('.postponeBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (!_statusStudent) return;
          let add = btn.dataset.add;
          let days = 0;
          if (add === 'custom') {
            const v = prompt('+ë©°ì¹  ë¯¸ë£°ê¹Œìš”?');
            days = parseInt(v, 10);
          } else {
            days = parseInt(add, 10);
          }
          if (!days || days <= 0) return;
          const newDate = await calcBusinessDate(days);
          setPostponed(_statusStudent, _statusUID, newDate);
          refreshStatusUI(_statusUID);
          closeStatusModal();
        });
      });
      modal.querySelector('#statusExemptBtn').addEventListener('click', () => {
        if (!_statusStudent) return;
        const reason = modal.querySelector('#exemptReason').value;
        setExempt(_statusStudent, _statusUID, reason);
        refreshStatusUI(_statusUID);
        closeStatusModal();
      });
      return (_statusModal = modal);
    }

    function openStatusModal(student, uid){
      ensureStatusModal();
      _statusStudent = student;
      _statusUID = uid;
      _statusModal.style.display = 'block';
      _statusModal.querySelector('#exemptReason').value = '';
    }

    async function calcBusinessDate(addDays){
      const start = new Date(); start.setHours(0,0,0,0);
      const holidaysCache = {};
      let d = new Date(start);
      let count = 0;
      while(count < addDays){
        d.setDate(d.getDate() + 1);
        const year = d.getFullYear();
        if (!holidaysCache[year]) holidaysCache[year] = await ensureHolidays(year);
        const dateStr = `${year}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        const isHoliday = !!holidaysCache[year][dateStr];
        if (isWeekend || isHoliday) continue;
        count++;
      }
      return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    }

    // ===========================================================
    // ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€ ë Œë”ë§
    // ===========================================================
    function renderTaskCompletion(uid) {
  const container = document.getElementById("completion-list");
  container.innerHTML = "";

  const all = (typeof getTasks === 'function') ? getTasks() : [];
  const t = all.find(x => x.id === uid);
  if (!t) { container.textContent = "ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; return; }

  const originDate = t.date;
  const h = document.createElement('h4');
  h.textContent = `ğŸ“Œ ${t.text} (${originDate})`;
  container.appendChild(h);

  // ëŒ€ìƒ í•™ìƒ êµ¬í•˜ê¸°
  let students = getStudentsSorted();
  if (!t.students.includes("ì „ì²´")) {
    const set = new Set(t.students || []);
    students = students.filter(s => set.has(s.name));
  }

  const grid = document.createElement('div');
  grid.className = "student-chip-grid";
  grid.style.userSelect = "none";

  students.forEach(stu => {
    const st = (typeof getStatusFor === 'function') ? getStatusFor(stu.name, uid) : null;
    const statusCode = st?.s || '';
    const isExempt = statusCode === 'e';
    const done = statusCode === 'd';
    const isPostponed = statusCode === 'p';
    const chip = document.createElement('div');
    chip.className = "student-chip" + (isExempt ? " exempt" : (done ? "" : " missed"));
    chip.dataset.student = stu.name;
    chip.dataset.uid = uid;
    chip.style.cursor = "pointer";
    chip.textContent = `${stu.id} ${stu.name}${isExempt ? ' ğŸš«' : ''}`;
    grid.appendChild(chip);
  });

  container.appendChild(grid);

  // [teacher.html] renderTaskCompletion(uid) ë‚´ë¶€ì˜ grid.onclick êµì²´
grid.onclick = null; // ê¸°ì¡´ ë¸ë¦¬ê²Œì´ì…˜ ì œê±°(ì¤‘ë³µ ë°©ì§€)

// í´ë¦­/ë”ë¸”í´ë¦­ êµ¬ë¶„ìš© íƒ€ì´ë¨¸
let _tapTimer = null;
const TAP_DELAY = 250; // ë”ë¸”í´ë¦­ íŒì • ì‹œê°„(ms)

grid.addEventListener('click', (e) => {
  const chip = e.target.closest('.student-chip');
  if (!chip || chip.classList.contains('exempt')) return;
  // ë”ë¸”í´ë¦­ë¡œ ì „í™˜ë  ìˆ˜ ìˆìœ¼ë‹ˆ, ì¼ë‹¨ íƒ€ì´ë¨¸ì— í† ê¸€ ì˜ˆì•½
  if (_tapTimer) clearTimeout(_tapTimer);
  _tapTimer = setTimeout(() => {
    _tapTimer = null;

    const student = chip.dataset.student;
    const uid     = chip.dataset.uid;
    const st = (typeof getStatusFor === 'function') ? getStatusFor(student, uid) : null;
    const isDoneNow = !!(st && st.s === 'd');

    // ë‹¨ì¼ í´ë¦­ = ì™„ë£Œ/ë¯¸ì™„ë£Œ í† ê¸€(ê¸°ì¡´ ë™ì‘ ìœ ì§€)
    setDone(student, uid, !isDoneNow);

    // UI ê°±ì‹ 
    if (typeof renderTaskCompletion === 'function') renderTaskCompletion(uid);
    if (typeof renderCalendar === 'function') renderCalendar();
    if (typeof renderStudentStatus === 'function') renderStudentStatus();
  }, TAP_DELAY);
}, false);

grid.addEventListener('dblclick', (e) => {
  const chip = e.target.closest('.student-chip');
  if (!chip) return;

  // í´ë¦­ ì˜ˆì•½ ì·¨ì†Œ
  if (_tapTimer) { clearTimeout(_tapTimer); _tapTimer = null; }

  const student = chip.dataset.student;
  const uid     = chip.dataset.uid;
  // ë”ë¸”í´ë¦­ = ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
  openStatusModal(student, uid);
}, false);
}


    // ===========================================================
    // 'ì˜¤ëŠ˜ í•  ì¼' í™”ë©´ ë Œë”ë§ (í•™ìƒë³„ ì¹´ë“œ)
    // ===========================================================
    function renderStudentStatus() {
      const page = qs("#student-status-page");
      const container = qs("#student-status-list");
      container.innerHTML = "";
   
      const all = (typeof getTasks === 'function') ? getTasks() : [];
      const today = normalizeDate(new Date());
      
      const students = getStudentsSorted();

      const showPE = localStorage.getItem('showPostponedExempt') !== 'no';
      
      // ê³¼ì œ â†’ í‘œì‹œìš© ì¸ìŠ¤í„´ìŠ¤(ë‚ ì§œë³„)ë¡œ í’€ê¸°
      const instances = [];
      const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };

  // ì´ë²ˆ ë‹¬ ë¿ ì•„ë‹ˆë¼ "ì˜¤ëŠ˜ ì´ì „"ë„ í•„ìš”í•˜ë¯€ë¡œ, ë²”ìœ„ë¥¼ ì¡°ê¸ˆ ë„‰ë„‰íˆ(ì „ì›”~ì˜¤ëŠ˜) ì²˜ë¦¬
  // ê°„ë‹¨íˆ: ê° ê³¼ì œëŠ” 'ë°˜ë³µ' í˜•íƒœì— ë§ì¶° ì˜¤ëŠ˜ê¹Œì§€ì˜ í‘œì‹œ ë‚ ì§œë¥¼ ë§Œë“¤ì–´ í‘¸ì‹œ
      all.forEach(t => {
        if (t.type === 'event') return;
        const base = normalizeDate(t.date);
        const rpt = t.repeat || 'none';

        
        // ë²”ìœ„ê°’ ì½ê¸°
        const s = t.repeatStart || t.date || "";  // ì‹œì‘ ê¸°ì¤€(ì—†ìœ¼ë©´ date)
        const e = t.repeatEnd   || "";            // ì¢…ë£Œ(ì˜µì…˜)
        
        // ë²”ìœ„ì²´í¬ í—¬í¼ (ë¬¸ìì—´ YYYY-MM-DD ë¹„êµ)
        const inRange = (dateStr) => {
          if (s && dateStr < s) return false;
          if (e && dateStr > e) return false;
          return true;
        };
        
        const pushIfInRange = (d) => {
          const ds = `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
          if (!inRange(ds)) return; // â˜…ì¶”ê°€
          instances.push({
            uid: t.id,
            text: t.text,
            date: ds,
            dateObj: new Date(d),
            students: t.students
          });
        };

        if (rpt === 'daily') {

          const cur = new Date(base);
          while (cur <= today) {
            pushIfInRange(cur);
            cur.setDate(cur.getDate()+1);
          }
        } else if ({mon:1,tue:2,wed:3,thu:4,fri:5}[rpt] != null) {
          const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
          const cur = new Date(base);
          while (cur.getDay() !== dayMap[rpt]) cur.setDate(cur.getDate()+1);
          while (cur <= today) {
            pushIfInRange(cur);
            cur.setDate(cur.getDate()+7);
    }
        } else {
          // ë°˜ë³µ ì—†ìŒ: ê¸°ì¤€ì¼ 1ê±´ë§Œ
          if (!isNaN(base) && base <= today) pushIfInRange(base);
        }
      });

      // ìµœì‹ ìˆœ ì •ë ¬
      instances.sort((a,b)=> b.dateObj - a.dateObj);

      const frag = document.createDocumentFragment();

      students.forEach(stu => {
        const card = document.createElement("div");
        Object.assign(card.style, {
          border:"1px solid #e6e8eb", padding:"12px", borderRadius:"16px",
          background:"#fff", boxShadow:"0 4px 10px rgba(0,0,0,.04)", marginBottom:"10px"
        });
        card.innerHTML = `ğŸ‘¦ ${labelOf(stu)}<div style="margin-top: 10px;"></div>`;
        const listBox = card.lastElementChild;

        instances.forEach(inst => {
          const assigned = inst.students.includes("ì „ì²´") || inst.students.includes(stu.name);
          if (!assigned) return;

          const st = (typeof getStatusFor === 'function') ? getStatusFor(stu.name, inst.uid) : null;
          const statusCode = st?.s || '';
          const postponedTo = st?.du || null;
          const isExempt = statusCode === 'e';
          const done = statusCode === 'd';
          const isPostponed = statusCode === 'p';
          const isPast = inst.dateObj < today;

          if (isPostponed && postponedTo && postponedTo !== inst.date) return;
          if (!showPE && (isPostponed || isExempt)) return;
          if (!isExempt && done && isPast) return;  // ê³¼ê±° & ì™„ë£Œë©´ ìˆ¨ê¹€(ë©´ì œ ì œì™¸)


          let bg = "#f6c1c1", dateColor = "#666";
          if (isExempt) { bg = "#E5E7EB"; dateColor = "#374151"; }
          else if (isPast && !done) { bg = "#c0392b"; dateColor = "#fff"; }
          else if (!isPast && done) { bg = "white"; dateColor = "#666"; }

          const chip = document.createElement("div");
          let cls = "student-chip";
          if (!done && !isPostponed && !isExempt) cls += " missed";
          if (isPostponed) cls += " postponed";
          if (isExempt) cls += " exempt";
          chip.className = cls;
          chip.dataset.student = stu.name;
          chip.dataset.uid = inst.uid;               // UID ì €ì¥

          let style = "padding:8px; border-radius:12px; margin:6px 0; display:flex; justify-content:space-between; align-items:center; cursor:pointer;";
          if (!isPostponed && !isExempt) style = `border:1px solid #e6e8eb; background:${bg}; ` + style;
          chip.style.cssText = style;

          chip.innerHTML = `
          <span>${escapeHTML(inst.text)}${isExempt ? ' ğŸš«' : ''}</span>
          <span style="font-size:10px; color:${dateColor};">${inst.date}</span>
          `;
          listBox.appendChild(chip);
        });

        frag.appendChild(card);
      });

      container.appendChild(frag);
    }



    // 'ì˜¤ëŠ˜ í•  ì¼' í•™ìƒ ì¹© í´ë¦­ ë¸ë¦¬ê²Œì´ì…˜
    // 'ì˜¤ëŠ˜ í•  ì¼' ì¹© í´ë¦­ + ì´ˆê¸° ë™ê¸°í™”
window.addEventListener('load', () => {
  const container = document.getElementById('student-status-list');
  if (!container) return;

  // rAF ê¸°ë°˜ ì¬ë Œë” ìŠ¤ë¡œí‹€ëŸ¬
  let raf = null;
  const schedule = () => {
    if (raf) return;
    raf = requestAnimationFrame(() => { raf = null; renderStudentStatus(); });
  };

  // ì´ˆê¸° ì§„ì… ì‹œ í•œ ë²ˆ UI ìƒíƒœ ë§ì¶”ê¸° (ì™„ë£Œ/ë¯¸ì™„ë£Œ ë³µì›)
  schedule();

  // í´ë¦­/ë”ë¸”í´ë¦­ êµ¬ë¶„ìš© íƒ€ì´ë¨¸
  let _tapTimer = null;
  const TAP_DELAY = 250;

  // í´ë¦­ í† ê¸€ â†’ ì™„ë£Œ/ë¯¸ì™„ë£Œ ì €ì¥ + ì¬ë Œë”
  container.addEventListener('click', (e) => {
    const chip = e.target.closest('.student-chip');
    if (!chip || !container.contains(chip) || chip.classList.contains('exempt')) return;

    // ë”ë¸”í´ë¦­ê³¼ êµ¬ë¶„í•˜ê¸° ìœ„í•´ í† ê¸€ì„ ì§€ì—°
    if (_tapTimer) clearTimeout(_tapTimer);
    _tapTimer = setTimeout(() => {
      _tapTimer = null;

      const student  = chip.dataset.student;
      const uid      = chip.dataset.uid;
      const nowIsDone = !chip.classList.contains('missed');

      setDone(student, uid, !nowIsDone);          // UID ê¸°ì¤€ ì €ì¥
      chip.classList.toggle('missed', nowIsDone); // ì¦‰ì‹œ ë°˜ì˜
      schedule();                                 // íì— ì¬ë Œë”
    }, TAP_DELAY);
  }, false);

  // ë”ë¸”í´ë¦­ â†’ ìƒíƒœ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
  container.addEventListener('dblclick', (e) => {
    const chip = e.target.closest('.student-chip');
    if (!chip || !container.contains(chip)) return;

    // ëŒ€ê¸° ì¤‘ì¸ ë‹¨ì¼ í´ë¦­ ì‹¤í–‰ ì·¨ì†Œ
    if (_tapTimer) { clearTimeout(_tapTimer); _tapTimer = null; }

    const student = chip.dataset.student;
    const uid     = chip.dataset.uid;
    openStatusModal(student, uid);

  // (ì„ íƒ) ë‹¤ë¥¸ íƒ­/ì°½ì—ì„œ ë³€ê²½ë˜ë©´ ê°±ì‹ 
  window.addEventListener('storage', (e) => {
    if (!e.key) return;
    if (e.key.startsWith('doneTasks-') || e.key === 'tasksV2') schedule();
  });

  // (ì„ íƒ) ê°™ì€ íƒ­ ë‚´ ë‹¤ë¥¸ ì½”ë“œì—ì„œ ë³€ê²½ ì‹œ ì¬ë Œë”ë¥¼ ì›í•˜ë©´ ì•„ë˜ ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•˜ê³  ë“£ê¸°
  window.addEventListener('tasks:updated', schedule);
  window.addEventListener('students:updated', schedule);
});


    // ===========================================================
    // í•™ìƒ ë°ì´í„° ë¡œë“œ/ì €ì¥
    // ===========================================================
    function saveStudents(students) {
      setJSON("students", students);
      invalidateStudentsCache();
    }
    // ===========================================================
    // í•™ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // ===========================================================
    function renderStudentList() {
      const students = getStudentsSorted();
      const showAll = document.getElementById("show-all-passwords")?.checked;
      const tbody = document.querySelector("#student-list tbody");

      tbody.innerHTML = "";

      students.forEach(stu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-id">
            <input data-field="id" value="${stu.id}" />
          </td>
          <td>
            <input data-field="name" value="${stu.name}" />
          </td>
          <td>
            <input data-field="password" ${showAll ? 'type="text"' : 'type="password"'} value="${stu.password}" />
          </td>
          <td style="text-align:center;">
            <input type="checkbox" onchange="toggleRowPw(this)" ${showAll ? "checked" : ""}/>
          </td>
          <td class="col-actions">
            <div class="actions">
              <button onclick="saveStudentRow('${stu.id}','${stu.name}', this)">ì €ì¥</button>
              <button onclick="deleteStudentByKey('${stu.id}','${stu.name}')">ì‚­ì œ</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===========================================================
    // í•™ìƒ: ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€(í–‰ ë‹¨ìœ„ / ì „ì²´)
    // ===========================================================
    function toggleRowPw(checkboxEl) {
      const tr = checkboxEl.closest("tr");
      const pwInput = tr.querySelector('input[data-field="password"]');
      pwInput.type = checkboxEl.checked ? "text" : "password";
    }
    function toggleAllPw(masterCheckbox) {
      const show = masterCheckbox.checked;
      document
        .querySelectorAll('#student-list tbody input[data-field="password"]')
        .forEach(inp => (inp.type = show ? "text" : "password"));
      document
        .querySelectorAll('#student-list tbody input[type="checkbox"]')
        .forEach(cb => (cb.checked = show));
    }

    // ===========================================================
    // í•™ìƒ: ì¶”ê°€/ì €ì¥/ì‚­ì œ
    // ===========================================================
    function addStudent() {
      const id = document.getElementById("new-student-id").value.trim();
      const name = document.getElementById("new-student-name").value.trim();
      const password = document.getElementById("new-student-password").value.trim();

      if (!id || !name || !password) { alert("ë²ˆí˜¸, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }

      const students = loadStudents();
      if (students.some(s => s.id === id)) { alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤."); return; }

      students.push({ id, name, password });
      saveStudents(students);

      document.getElementById("new-student-id").value = "";
      document.getElementById("new-student-name").value = "";
      document.getElementById("new-student-password").value = "";
      renderStudentList();
    }

    function saveStudentRow(oldId, oldName, btnEl) {
      const tr = btnEl.closest("tr");

      const newId = tr.querySelector('input[data-field="id"]').value.trim();
      const newName = tr.querySelector('input[data-field="name"]').value.trim();
      const newPw = tr.querySelector('input[data-field="password"]').value.trim();

      if (!newId || !newName || !newPw) { alert("ë²ˆí˜¸, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(oldId) && s.name === oldName);
      if (idx < 0) { alert("ëŒ€ìƒ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); return; }

      if (String(newId) !== String(oldId) && students.some(s => String(s.id) === String(newId))) {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤."); return;
      }

      students[idx] = { id: newId, name: newName, password: newPw };
      saveStudents(students);
      invalidateStudentsCache();

      renderStudentList();
      renderStudentListToCheckbox?.();
      renderStudentStatus?.();
    }

    function deleteStudentByKey(id, name) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(id) && s.name === name);

      if (idx >= 0) {
        students.splice(idx, 1);
        saveStudents(students);
        invalidateStudentsCache();
        
        renderStudentList();
        renderStudentListToCheckbox();
        renderStudentStatus();
      }
    }

    function hideActionUI() {
      const $btns     = document.getElementById('task-action-buttons');
      const $selected = document.getElementById('task-action-selected');
      const $compBox  = document.getElementById('task-completion');

      if ($btns)     $btns.style.display = 'none';
      if ($compBox)  $compBox.style.display = 'none';
      if ($selected) $selected.textContent = '';

      selectedDate = null;
      selectedTaskIndex = null;
      selectedTaskText = '';
      selectedOriginDate = null;
      selectedOriginKey = null;
      selectedUid = null;
    }

    // ë ˆê±°ì‹œ ì™„ë£Œí‚¤ë§Œ ì •ë¦¬ (UIDëŠ” ì ˆëŒ€ ì‚­ì œí•˜ì§€ ì•ŠìŒ)
    function purgeLegacyDoneKeysForAllStudents() {
      const students = (loadStudentsCached?.() || []).map(s => s.name);
      const UID_RE = /^t_[0-9a-z]+_[0-9a-z]+$/i; // genUID() íŒ¨í„´

      students.forEach(name => {
        const store = getDoneTasks(name) || {};
        let changed = false;

        Object.keys(store).forEach(k => {
          const isUID = UID_RE.test(k);
          const isLegacy = k.includes('@@');              // ì˜ˆ: "YYYY-MM-DD@@ê³¼ì œëª…"
          const looksPlainText = !isUID && !k.includes('@@'); // ì˜ˆ: "ê³¼ì œëª…" ë‹¨ë… í‚¤
          
          if (isLegacy || looksPlainText) {               // ë ˆê±°ì‹œë§Œ ì§€ì›€
            delete store[k];
            changed = true;
          }
        });

        if (changed) setDoneTasks(name, store);
      });
    }


    // í•™ìƒë³„ doneTasksì˜ "YYYY-MM-DD@@ê³¼ì œëª…" -> UID ë¡œ ì´ì „
function migrateLegacyDoneToUIDOnce() {
  const FLAG = 'migratedDoneToUID';
  if (localStorage.getItem(FLAG) === 'yes') return;

  const all = (typeof getTasks === 'function') ? getTasks() : [];
  if (!Array.isArray(all) || !all.length) { localStorage.setItem(FLAG, 'yes'); return; }

  // ë¹ ë¥¸ ë§¤ì¹­ìš© ë§µ: "date@@text" -> uid
  const byDateText = new Map();
  all.forEach(t => byDateText.set(`${t.date}@@${t.text}`, t.id));

  const students = (loadStudentsCached?.() || []).map(s => s.name);
  students.forEach(name => {
    const store = getDoneTasks(name) || {};
    let changed = false;

    Object.entries(store).forEach(([k, v]) => {
      if (v === true && k.includes('@@')) {
        const uid = byDateText.get(k);
        if (uid) {
          store[uid] = true;  // UIDë¡œ ì´ì „
          delete store[k];
          changed = true;
        }
      }
    });

    if (changed) setDoneTasks(name, store);
  });

  localStorage.setItem(FLAG, 'yes');
}

    



    function getVacations(){ return getJSON('vacations', []); }
    function setVacations(v){ setJSON('vacations', v); }

    let editingVacIndex = null;

    function cancelEditVacation(){
      editingVacIndex = null;
      qs('#vac-name').value='';
      qs('#vac-start').value='';
      qs('#vac-end').value='';
      const addBtn = qs('#vac-add-btn');
      const cancelBtn = qs('#vac-cancel-btn');
      if (addBtn) addBtn.textContent = 'ì¶”ê°€';
      if (cancelBtn) cancelBtn.style.display = 'none';
    }

    function editVacation(idx){
      const list = getVacations();
      const v = list[idx];
      if (!v) return;
      editingVacIndex = idx;
      qs('#vac-name').value = v.name;
      qs('#vac-start').value = v.start;
      qs('#vac-end').value = v.end;
      const addBtn = qs('#vac-add-btn');
      const cancelBtn = qs('#vac-cancel-btn');
      if (addBtn) addBtn.textContent = 'ìˆ˜ì • ì™„ë£Œ';
      if (cancelBtn) cancelBtn.style.display = 'inline-block';
    }

    function addVacation(){
      const name  = qs('#vac-name').value.trim();
      const start = qs('#vac-start').value;
      const end   = qs('#vac-end').value;
      if (!name || !start || !end) { alert('ì´ë¦„/ì‹œì‘/ì¢…ë£Œ ë‚ ì§œë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if (start > end) { alert('ì‹œì‘ì´ ì¢…ë£Œë³´ë‹¤ ë’¤ì…ë‹ˆë‹¤.'); return; }
      
      const list = getVacations();
      if (editingVacIndex != null) {
        list[editingVacIndex] = { name, start, end };
      } else {
        list.push({ name, start, end });
      }
      setVacations(list);
      
      cancelEditVacation();
      renderVacationList();
      renderCalendar();
    }
    
    function deleteVacation(idx){
      const list = getVacations();
      list.splice(idx,1);
      setVacations(list);
       if (editingVacIndex === idx) {
        cancelEditVacation();
      } else if (editingVacIndex != null && editingVacIndex > idx) {
        editingVacIndex--;
      }
      renderVacationList();
      renderCalendar();
    }
    
    function renderVacationList(){
      const list = getVacations();
      const box = qs('#vac-list');
      if (!list.length){ box.innerHTML = '<div style="color:#666;">ë“±ë¡ëœ ë°©í•™ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
      box.innerHTML = list.map((v,i)=>`
      <div style="display:flex;align-items:center;gap:8px;margin:6px 0;">
      <div style="flex:1 1 auto;">ğŸ– ${escapeHTML(v.name)} â€” ${v.start} ~ ${v.end}</div>
      <button onclick="editVacation(${i})">ìˆ˜ì •</button>
      <button onclick="deleteVacation(${i})">ì‚­ì œ</button>
      </div>
      `).join('');
    }


    // ì¢…ë¥˜ í† ê¸€: 'ì¼ì •' 'ê³¼ì œ' 'ë„ì „'
    (function(){
      const wrap = document.getElementById('task-type-toggle');
      if (!wrap) return;
      const hidden = document.getElementById('task-type');
      wrap.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-type]');
        if(!btn) return;
        wrap.querySelectorAll('button').forEach(b=>{
          b.classList.toggle('is-active', b === btn);
          b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
        });
        hidden.value = btn.dataset.type;
        applyTypeEffects(); // UI ë³´ì—¬ì£¼ê¸°/ìˆ¨ê¸°ê¸° ì¡°ì •
      });
    })();

    function applyTypeEffects(){
      const type = document.getElementById('task-type')?.value || 'assignment';
      const repeatSel = document.getElementById('repeat');
      const rangeBox  = document.getElementById('repeat-range');
      const dateBox   = document.getElementById('task-date')?.closest('.task-row'); // ë‹¨ì¼ ë‚ ì§œê°€ ìˆëŠ” ì¤„
      const tgtSel    = document.getElementById('target');
      const stuGrid   = document.getElementById('student-selector');

      if (type === 'event'){        // ì¼ì •: ê³µì§€ìš©, ì™„ë£Œì²´í¬/ëŒ€ìƒ ë¶ˆí•„ìš”
        dateBox?.classList.remove('hidden');
        repeatSel.disabled = true; repeatSel.value = 'none';
        rangeBox.style.display = 'none';
        tgtSel.value = 'all'; tgtSel.disabled = true;
        stuGrid.style.display = 'none';
      } else if (type === 'challenge'){ // ë„ì „: ë¬´ê¸°í•œ, ë‚ ì§œ/ë°˜ë³µ ë¶ˆí•„ìš”, ëŒ€ìƒì€ í•„ìš”
        repeatSel.disabled = true; repeatSel.value = 'none';
        rangeBox.style.display = 'none';
        dateBox?.classList.add('hidden'); // ë‹¨ì¼ ë‚ ì§œ ìˆ¨ê¹€
        tgtSel.disabled = false;
        if (tgtSel.value === 'selected') document.getElementById('student-selector').style.display='flex';
      } else { // ê³¼ì œ
        dateBox?.classList.remove('hidden');
        repeatSel.disabled = false;
        // repeat===none? ë²”ìœ„ ìˆ¨ê¹€ : ë³´ì„ (ì•„ë˜ 3-3ì—ì„œ ì¶”ê°€ë¡œ ì œì–´)
        tgtSel.disabled = false;
      }
    }
    
    (function(){
      const tgl = document.getElementById('desc-toggle');
      const ta  = document.getElementById('task-desc');
      if(!tgl || !ta) return;
      tgl.addEventListener('click', ()=>{
        const on = ta.style.display !== 'none';
        ta.style.display = on ? 'none' : 'block';
        tgl.textContent  = on ? 'ì„¤ëª… ì¶”ê°€' : 'ì„¤ëª… ë‹«ê¸°';
      });
    })();

    // ===== V2 ì €ì¥ì†Œ í—¬í¼ =====
    const TASKS_V2_KEY = 'tasksV2';

    function genUID(){
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    function getTasks(){
      return getJSON(TASKS_V2_KEY, []);
    }
    function setTasks(list){
      setJSON(TASKS_V2_KEY, list);
    }

    // (ì„ íƒ) 1íšŒ ë§ˆì´ê·¸ë ˆì´ì…˜ í›… â€“ ê¸°ì¡´ êµ¬ì¡° â†’ V2ë¡œ ì˜®ê¸¸ ë•Œ ì“°ê³ , ëë‚˜ë©´ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë¨
    function migrateToUIDOnce(){
      const flag = getJSON('_migrated_v2', false);
      if (flag) return;
      // í•„ìš” ì‹œ ì—¬ê¸°ì—ì„œ teacherTasks-* ë¥¼ ì½ì–´ ë³€í™˜(push {id,date,text,repeat,students,...}))
      setJSON('_migrated_v2', true);
    }
    if (typeof migrateLegacyDoneToUIDOnce === 'function') migrateLegacyDoneToUIDOnce();

    function applyShowEventsBtn(){
      const btn = document.getElementById('eventsBtn');
      if (!btn) return;
      let pref = localStorage.getItem('showEvents');
      if (pref !== 'yes' && pref !== 'no'){ pref='yes'; localStorage.setItem('showEvents', pref); }
      const show = pref !== 'no';
      btn.textContent = show ? 'ì¼ì •ìˆ¨ê¹€' : 'ì¼ì •í‘œì‹œ';
      btn.setAttribute('aria-pressed', String(show));
      const strip = document.getElementById('events-strip-teacher');
      if (strip) strip.style.display = show ? '' : 'none';
    }
    function toggleShowEvents(){
      const show = localStorage.getItem('showEvents') !== 'no';
      localStorage.setItem('showEvents', show ? 'no' : 'yes');
      renderEventsStrip('events-strip-teacher', { editable: true });
      renderStudentStatus();
      applyShowEventsBtn();
    }
      applyShowEventsBtn();
    document.getElementById('eventsBtn')?.addEventListener('click', toggleShowEvents);
    window.addEventListener('storage', (e)=>{
        if (e.key === 'showEvents') {
          renderEventsStrip('events-strip-teacher', { editable: true });
          renderStudentStatus();
          applyShowEventsBtn();
        }
      });

    function applyPeBtn(){
      const btn = document.getElementById('peToggleBtn');
      if (!btn) return;
      let pref = localStorage.getItem('showPostponedExempt');
      if (pref !== 'yes' && pref !== 'no'){ pref='yes'; localStorage.setItem('showPostponedExempt', pref); }
      const show = pref !== 'no';
      btn.textContent = show ? 'ë¯¸ë£¸Â·ë©´ì œ ìˆ¨ê¸°ê¸°' : 'ë¯¸ë£¸Â·ë©´ì œ ë³´ê¸°';
      btn.setAttribute('aria-pressed', String(show));
    }
    function toggleShowPe(){
      const show = localStorage.getItem('showPostponedExempt') !== 'no';
      localStorage.setItem('showPostponedExempt', show ? 'no' : 'yes');
      renderStudentStatus();
      applyPeBtn();
    }
    applyPeBtn();
    document.getElementById('peToggleBtn')?.addEventListener('click', toggleShowPe);
    window.addEventListener('storage', (e)=>{
      if (e.key === 'showPostponedExempt') {
        renderStudentStatus();
        applyPeBtn();
      }
    });
    
    window.addEventListener('load', renderVacationList);

  </script>
</body>
</html>
