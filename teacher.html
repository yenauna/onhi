<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê³¼ì œ ë°°ì • (êµì‚¬ìš©)</title>

  <!-- í°íŠ¸: ì œëª©=Jua, ë³¸ë¬¸/ë²„íŠ¼=SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --brand:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);
    }

    *{ box-sizing:border-box }
    html, body { min-height:100% }

    /* ================================
       ë°°ê²½ & ê¸°ë³¸ íƒ€ì´í¬
       ================================ */
    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);

      /* ë¶€ë“œëŸ¬ìš´ ë°°ê²½ ê·¸ë˜í”½ */
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));

      /* ìƒë‹¨ ë¡œê³ ì¹© ê³µê°„ í™•ë³´ + ê°€ìš´ë° ì •ë ¬ */
      padding:140px 16px 40px;
      display:flex;
      justify-content:center;
      align-items:flex-start;   /* ì„¸ë¡œ ê°€ìš´ë° ê³ ì • ë°©ì§€ */
      overflow-y:auto;          /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
    }

    /* ë°°ê²½ì˜ êµ¬ë¦„ */
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.9;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }

    /* ================================
       ê°€ìš´ë° ì¹´ë“œ ì»¨í…Œì´ë„ˆ
       ================================ */
    .container{
      max-width:960px;
      width:100%;
      background:var(--card);
      border:1px solid var(--card-line);
      border-radius:26px;
      box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:28px 24px 32px;

      /* ê¸´ ë‚´ìš© ëŒ€ì‘ */
      height:auto;
      overflow-wrap:break-word;
    }

    /* ================================
       ìƒë‹¨ ë¡œê³  ì¹© (ê°€ìš´ë°)
       ================================ */
    header{
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      z-index:1000;

      background:#fff;
      padding:8px 10px;
      border-radius:16px;
      border:1px solid var(--card-line);
      box-shadow:0 10px 24px rgba(0,0,0,.08);
    }
    #logo{ width:64px; height:auto; cursor:pointer; display:block; }

    /* ================================
       ê³µí†µ ì œëª©/ì„¹ì…˜
       ================================ */
    h2, h3 { margin:0 0 14px; }
    h2{
      text-align:center;
      font-family:'Jua',sans-serif;
      font-weight:400;
      letter-spacing:-.2px;
    }
    section{ margin-top:26px; }

    /* ================================
       ìƒë‹¨ íƒ­ ë²„íŠ¼
       ================================ */
    .toggle-buttons{
      display:flex;
      justify-content:center;
      gap:10px;
      margin-bottom:16px;
    }
    .toggle-buttons button{
      padding:10px 18px;
      font-size:15px;
      cursor:pointer;
      border-radius:999px;
      border:1px solid var(--card-line);
      background:#fff;
      box-shadow:0 6px 14px rgba(0,0,0,.06);
    }
    .toggle-buttons button:active{ transform:translateY(1px); }

    /* ================================
       ì…ë ¥/ì…€ë ‰íŠ¸/ë²„íŠ¼ ê³µí†µ
       ================================ */
    input[type="text"],
    input[type="password"],
    input[type="date"],
    select{
      padding:10px 12px;
      border:2px solid #dcdfe4;
      border-radius:14px;
      outline:none;
      font:inherit;
      background:#fff;
    }
    input:focus, select:focus{
      border-color:#b9c7c5;
      box-shadow:0 0 0 4px rgba(185,199,197,.28);
    }
    button{
      padding:10px 14px;
      cursor:pointer;
      border-radius:14px;
      border:1px solid var(--card-line);
      background:#fff;
      font:inherit;
    }
    .btn-primary{
      color:#fff;
      background:var(--brand);
      border-color:var(--brand);
      box-shadow:0 12px 28px var(--btn-shadow);
    }

    /* ================================
       ê³¼ì œ ì…ë ¥ í–‰
       ================================ */
    .task-input{
      display:flex;
      gap:8px;
      margin-bottom:10px;
    }
    .task-input input{ flex:1; }

    /* í•™ìƒ ì²´í¬ë°•ìŠ¤ ë¼ë²¨ */
    .student-checkboxes label{
      display:inline-block;
      margin:6px 8px 0 0;
      padding:6px 10px;
      border:1px solid #e6e8eb;
      border-radius:12px;
      background:#fff;
    }

    /* ì €ì¥ë‚´ì—­/í•™ìƒì¹© */
    .saved-item, .student-item{
      border-top:1px dashed #d5d5d5;
      padding-top:8px;
      margin-top:10px;
    }

    /* ================================
       ë‹¬ë ¥ ìŠ¤íƒ€ì¼
       ================================ */
    .calendar{ display:none; }
    .calendar table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    .calendar th, .calendar td{
      border:1px solid #ececec;
      width:14.28%;
      height:96px;
      text-align:left;
      vertical-align:top;
      padding:8px;
      font-size:14px;
    }
    .calendar thead th{ background:#f9fafb; }
    .calendar td > strong{ display:block; margin-bottom:6px; }

    /* ë‹¬ë ¥ ê³¼ì œ pill */
    .task-pill{
      background:#f6c1c1;
      border-radius:10px;
      padding:4px 8px;
      margin-top:6px;
      font-size:12px;
      cursor:pointer;
      display:inline-block;
      border:1px solid rgba(0,0,0,.06);
    }
    .task-pill:hover{ opacity:.9; }

    /* ì„ íƒ ì•ˆë‚´/ë²„íŠ¼ ì˜ì—­ */
    #task-action-selected{ margin:10px 0; font-size:14px; color:#555; }

    /* ================================
       ê³¼ì œë³„ ì™„ë£Œ ì—¬ë¶€(ì¹©)
       ================================ */
    .student-chip-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .student-chip{
      border:1px solid #e6e8eb;
      border-radius:12px;
      padding:10px 12px;
      min-width:92px;
      text-align:center;
      background:#fff;
    }
    .student-chip.missed{
      background:#f6c1c1;
      border-color:#e9b3b3;
    }

    /* ================================
       í•™ìƒ ê´€ë¦¬ í‘œ
       ================================ */
   #student-list{
    width:100%;
    border-collapse:collapse;
    table-layout:fixed;         /* ê° colì´ ì •í•œ í­ì„ ë”°ë¥´ê²Œ */
    }

    /* ì—´ í­: px ëŒ€ì‹  ch/auto ë¡œ ë°˜ì‘í˜• */
   #student-list col:nth-child(1){ width: 8ch; }   /* ë²ˆí˜¸: 2~3ìë¦¬ë©´ ì¶©ë¶„ */
   #student-list col:nth-child(2){ 
    width: auto;       /* ë‚¨ëŠ” ê³µê°„ì„ ì°¨ì§€ */
    min-width: 14rem;  /* ìµœì†Œ ë„“ì´ í™•ë³´ */
   }
   #student-list col:nth-child(3){ width: 14ch; }  /* ë¹„ë°€ë²ˆí˜¸ */
   #student-list col:nth-child(4){ width: 7ch; }   /* ë³´ê¸° ì²´í¬ */
   #student-list col:nth-child(5){ width: 16ch; }  /* ì‘ì—… ë²„íŠ¼ë“¤ */

   #student-list th, #student-list td{
    border:1px solid #ccc;
    padding:6px;
    text-align:center;
    vertical-align:middle;
    }

   /* ì…€ ì•ˆ ì…ë ¥/ë²„íŠ¼ì´ ì…€ ë°–ìœ¼ë¡œ ì•ˆ ë‚˜ê°€ë„ë¡ */
   #student-list td input[type="text"],
   #student-list td input[type="password"]{
    width:100%;
    height:32px;
    box-sizing:border-box;      /* ë³´ë”/íŒ¨ë”© í¬í•¨í•´ì„œ 100% */
    display:block;              /* ì¸ë¼ì¸-ê°„ê²© ì´ìŠˆ ë°©ì§€ */
    margin:0;
   }

  /* ì‘ì—… ë²„íŠ¼ ê°€ìš´ë° ì •ë ¬ */
  #student-list td.col-actions .actions{
   display:flex;
   justify-content:center;
   align-items:center;
   gap:8px;
   }
  #student-list td.col-actions .actions button{
   height:32px;
   padding:0 12px;
   }

  /* í™”ë©´ì´ ì•„ì£¼ ì¢ì•„ì§€ë©´ ì‘ì—…/ë³´ê¸° í­ì„ ì¡°ê¸ˆ ì¤„ì„ */
  @media (max-width: 520px){
  #student-list col:nth-child(4){ width: 6ch; }
  #student-list col:nth-child(5){ width: 14ch; }
  }

  /* í‘œê°€ ì •ë§ ì¢ì•„ì§ˆ ë•Œ ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš©(ê¹¨ì§ ë°©ì§€) */
  .table-wrap{
   overflow-x:auto;
}
    
    /* ë²„íŠ¼ ì¤„ í•œ ì¤„ ì •ë ¬ */
    #task-action-buttons{
      display:flex !important;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;   /* í™”ë©´ ì¢ì„ ë•Œë§Œ ì¤„ë°”ê¿ˆ */
    }
    
    /* (ì„ íƒ) ë²„íŠ¼ ë†’ì´/íŒ¨ë”© ì‚´ì§ í†µì¼ê° */
    #task-action-buttons button{
      height:36px;
      padding:0 14px;
    }
    

  </style>
</head>
<body>
  <!-- =====================================
       ìƒë‹¨ ë¡œê³ ì¹©
       ===================================== -->
  <header>
    <img
      src="logo.png"
      alt="ì˜¤ëŠ˜ í•  ì¼ ë¡œê³ "
      id="logo"
      style="cursor:pointer"
      onclick="location.href='index.html'"
    />
  </header>

  <!-- =====================================
       ê°€ìš´ë° ì¹´ë“œ ì»¨í…Œì´ë„ˆ
       ===================================== -->
  <div class="container">

    <!-- ===== ìƒë‹¨ íƒ­(ì˜¤ëŠ˜ í•  ì¼ / ê³¼ì œ ê´€ë¦¬ / í•™ìƒ ê´€ë¦¬) ===== -->
    <div class="toggle-buttons">
      <button onclick="showStudentStatus()">ì˜¤ëŠ˜ í•  ì¼</button>
      <button onclick="showTaskManagement()">ê³¼ì œ ê´€ë¦¬</button>
      <button onclick="showStudentManagement()">í•™ìƒ ê´€ë¦¬</button>
    </div>

    <!-- ===== ì˜¤ëŠ˜ í•  ì¼(í•™ìƒë³„ í˜„í™©) ===== -->
    <div id="student-status-page" style="display:none; margin-top: 8px;">
      <h3>âœ… í•™ìƒë³„ ê³¼ì œ ì™„ë£Œ í˜„í™©</h3>
      <div
        id="student-status-list"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px;"
      ></div>
    </div>

    <!-- ===== ê³¼ì œ ê´€ë¦¬ + ë‹¬ë ¥ ===== -->
    <div id="task-management" style="display:none; margin-top: 8px;">
      <h2>ğŸ“‹ ê³¼ì œ ì¶”ê°€ ë° ë‹¬ë ¥</h2>

      <!-- ê³¼ì œ ì…ë ¥ ì˜ì—­ -->
      <section>
        <label>ğŸ“… ê³¼ì œ ë‚ ì§œ:</label>
        <input type="date" id="task-date" />

        <div class="task-list" id="task-list">
          <div class="task-input">
            <input type="text" placeholder="í•  ì¼ ì…ë ¥" />
            <button onclick="removeTask(this)">âŠ–</button>
          </div>
        </div>

        <button class="btn-primary" onclick="addTask()">+ í•  ì¼ ì¶”ê°€</button>

        <label style="display:block; margin-top:10px;">ğŸ” ë°˜ë³µ ì„¤ì •:</label>
        <select id="repeat">
          <option value="none">ì—†ìŒ</option>
          <option value="daily">ë§¤ì¼</option>
          <option value="mon">ë§¤ì£¼ ì›”ìš”ì¼</option>
          <option value="tue">ë§¤ì£¼ í™”ìš”ì¼</option>
          <option value="wed">ë§¤ì£¼ ìˆ˜ìš”ì¼</option>
          <option value="thu">ë§¤ì£¼ ëª©ìš”ì¼</option>
          <option value="fri">ë§¤ì£¼ ê¸ˆìš”ì¼</option>
        </select>

        <label style="display:block; margin-top:10px;">ğŸ‘¥ ëŒ€ìƒ ì„ íƒ:</label>
        <select id="target">
          <option value="all">ì „ì²´ í•™ìƒ</option>
          <option value="selected">íŠ¹ì • í•™ìƒ ì§€ì •</option>
        </select>

        <div id="student-checkboxes" class="student-checkboxes" style="display: none;"></div>

        <button class="btn-primary" style="margin-top:10px;" onclick="saveAssignment()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      </section>

      <!-- ë‹¬ë ¥ -->
      <section class="calendar" style="margin-top:20px;">
        <h3>ğŸ—“ï¸ ë‹¬ë ¥ (ê³¼ì œ í´ë¦­ ì‹œ ìˆ˜ì •/ì‚­ì œ/í™•ì¸ ë²„íŠ¼ í‘œì‹œ)</h3>
         <!-- ë‹¬ë ¥ ì›” ë„¤ë¹„ê²Œì´ì…˜ -->
         <div id="cal-controls" style="display:flex;align-items:center;gap:8px;margin:8px 0 4px;">
           <button type="button" onclick="changeMonth(-1)">â—€</button>
           <div id="cal-label" style="font-weight:600;min-width:120px;text-align:center;"></div>
           <button type="button" onclick="changeMonth(1)">â–¶</button>
           <button type="button" onclick="goToday()" style="margin-left:8px;">ì˜¤ëŠ˜</button>
         </div>

        <table>
          <thead>
            <tr>
              <th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th>
            </tr>
          </thead>
          <tbody id="calendar-body"></tbody>
        </table>
      </section>

      <!-- ê³¼ì œ ì„ íƒ ì•ˆë‚´ + ì•¡ì…˜ ë²„íŠ¼ -->
      <div id="task-action-selected"></div>
      <div id="task-action-buttons" style="margin-top:10px; display:none;">
        <button class="btn-primary" onclick="closeTaskCompletion()">ë‹«ê¸°</button>
        <button class="btn-primary" onclick="editTask()">ìˆ˜ì •</button>
        <button class="btn-primary" onclick="deleteTaskClicked()">ì‚­ì œ</button>
      </div>

      <!-- ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€ -->
      <div id="task-completion" style="margin-top:20px; display:none;">
        <h3>ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€</h3>
        <div id="completion-list"></div>
      </div>
    </div>

    <!-- ===== í•™ìƒ ê´€ë¦¬ ===== -->
    <div id="student-management" style="display:none; margin-top:20px;">
      <h3>ğŸ‘©â€ğŸ“ í•™ìƒ ê´€ë¦¬</h3>

      <!-- í•™ìƒ ì¶”ê°€ í¼ -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;">
        <input type="text" id="new-student-id" placeholder="ë²ˆí˜¸" style="flex:0 0 110px;" />
        <input type="text" id="new-student-name" placeholder="ì´ë¦„" style="flex:1 1 160px;" />
        <input type="password" id="new-student-password" placeholder="ë¹„ë°€ë²ˆí˜¸" style="flex:0 0 140px;" />
        <button class="btn-primary" onclick="addStudent()">ì¶”ê°€</button>
      </div>

      <!-- ì „ì²´ ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€ -->
      <div style="display:flex; align-items:center; gap:12px; margin:8px 0;">
        <label>
          <input type="checkbox" id="show-all-passwords" onchange="toggleAllPw(this)">
          ë¹„ë°€ë²ˆí˜¸ ëª¨ë‘ ë³´ê¸°
        </label>
      </div>

      <!-- í•™ìƒ ëª©ë¡ í‘œ -->
      <table id="student-list" border="1" style="margin-top:10px; width: 100%; border-collapse:collapse;">
        <colgroup>
          <col><!-- ë²ˆí˜¸ -->
          <col><!-- ì´ë¦„ -->
          <col><!-- ë¹„ë°€ë²ˆí˜¸ -->
          <col><!-- ë³´ê¸° -->
          <col><!-- ì‘ì—… -->
        </colgroup>
        <thead>
          <tr>
            <th>ë²ˆí˜¸</th>
            <th>ì´ë¦„</th>
            <th>ë¹„ë°€ë²ˆí˜¸</th>
            <th>ë³´ê¸°</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <!-- ===========================================================
       ìŠ¤í¬ë¦½íŠ¸ (ê¸°ëŠ¥ ê·¸ëŒ€ë¡œ / ê°€ë…ì„± ìˆê²Œ ì •ë¦¬ + ì£¼ì„ ì œëª© ì¶”ê°€)
       =========================================================== -->
  <script>
    // ===========================================================
    // ì „ì—­ ìƒíƒœ
    // ===========================================================
    let selectedDate = null;         // ë‹¬ë ¥ì—ì„œ 'ì„ íƒí•œ ë‚ ì§œ'(YYYY-MM-DD)
    let selectedTaskIndex = null;    // ì„ íƒí•œ ê³¼ì œì˜ 'ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤'
    let selectedTaskText = "";       // ì„ íƒí•œ ê³¼ì œ í…ìŠ¤íŠ¸
    let selectedOriginDate = null;   // ì™„ë£Œí‚¤ìš© 'ì›ë³¸ ë‚ ì§œ'(teacherTasks-YYYY-MM-DDì—ì„œ YYYY-MM-DD)
    let selectedOriginKey = null; // ì˜ˆ: "teacherTasks-2025-09-03"
    let isEditing = false;           // í¸ì§‘ ëª¨ë“œ ì—¬ë¶€
    let editingOriginalDate = null;  // í¸ì§‘ ì‹œì‘ ë‹¹ì‹œì˜ ì›ë˜ ë‚ ì§œ(YYYY-MM-DD)

    // ë‚ ì§œë³„ë¡œ ë‹¬ë ¥ì— ë¿Œë ¤ì§„ ê³¼ì œì˜ 'ì›ë³¸ ì°¸ì¡°'(í‚¤/ì¸ë±ìŠ¤) ë§µ
    // ì˜ˆ) calendarRefs["2025-03-12"] = [{ key:"teacherTasks-2025-03-01", taskIndex:0 }, ...]
    let calendarRefs = {};

    // ë‹¬ë ¥ ë·° ìƒíƒœ(í‘œì‹œ ì¤‘ì¸ ì—°/ì›”)
    let viewYear  = (new Date()).getFullYear();
    let viewMonth = (new Date()).getMonth(); // 0=1ì›”, 11=12ì›”

    function pad2(n){ return String(n).padStart(2,'0'); }

    function setCalLabel(){
      const label = document.getElementById('cal-label');
      if (!label) return;
      label.textContent = `${viewYear}ë…„ ${viewMonth+1}ì›”`;
     }

    function changeMonth(delta){
      // delta = -1(ì´ì „ë‹¬) / +1(ë‹¤ìŒë‹¬)
      viewMonth += delta;
      if (viewMonth < 0) { viewMonth = 11; viewYear--; }
      if (viewMonth > 11){ viewMonth = 0;  viewYear++; }
      renderCalendar();  // ìƒˆ ì›”ë¡œ ë‹¤ì‹œ ê·¸ë¦¼
    }

    function goToday(){
      const today = new Date();
      viewYear  = today.getFullYear();
      viewMonth = today.getMonth();
      renderCalendar();
    }


    // ===========================================================
    // ìœ í‹¸ë¦¬í‹°: í•™ìƒ ì •ë ¬/ë¼ë²¨
    // ===========================================================
    function _toNum(v) {
      const n = parseInt(String(v), 10);
      return isNaN(n) ? 0 : n;
    }

    // 1~50 ë¨¼ì €, 51~ ì´í›„ + ê° ê·¸ë£¹ ë‚´ ì˜¤ë¦„ì°¨ìˆœ
    function sortStudents(arr) {
      return (arr || []).slice().sort((a, b) => {
        const an = _toNum(a.id), bn = _toNum(b.id);
        const ag = an > 50 ? 1 : 0, bg = bn > 50 ? 1 : 0;
        if (ag !== bg) return ag - bg;
        return an - bn;
      });
    }

    function getStudentsSorted() {
      return sortStudents(loadStudents());
    }

    function labelOf(stu) {
      return `${stu.id} ${stu.name}`;
    }

    // ===========================================================
    // ì´ˆê¸°í™”: ì²« í™”ë©´ì€ 'ì˜¤ëŠ˜ í•  ì¼'
    // ===========================================================
    window.onload = function () {
      showStudentStatus();
    };

    // ===========================================================
    // í™”ë©´ ì „í™˜: íƒ­ ë²„íŠ¼ í•¸ë“¤ëŸ¬
    // ===========================================================
    function showStudentStatus() {
      document.getElementById("student-status-page").style.display = "block";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "none";

      renderStudentStatus();
    }

    function showTaskManagement() {
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "block";
      document.getElementById("student-management").style.display = "none";

      renderCalendar();
      renderStudentListToCheckbox();

      // ë‹¬ë ¥ ì„¹ì…˜ í‘œì‹œ
      const calendarSection = document.querySelector("#task-management section.calendar");
      if (calendarSection) {
        calendarSection.style.display = "block";
      }
    }

    function showStudentManagement() {
      document.getElementById("student-status-page").style.display = "none";
      document.getElementById("task-management").style.display = "none";
      document.getElementById("student-management").style.display = "block";

      renderStudentList();
    }

    // ===========================================================
    // í•™ìƒ ì²´í¬ë°•ìŠ¤ ë Œë”ë§(ê³¼ì œ ëŒ€ìƒ ì§€ì •ìš©)
    // ===========================================================
    function renderStudentListToCheckbox() {
      const container = document.getElementById("student-checkboxes");
      container.innerHTML = "";

      const students = getStudentsSorted();
      students.forEach(stu => {
        const label = document.createElement("label");
        // valueëŠ” name ê·¸ëŒ€ë¡œ(ë‚´ë¶€ ë°ì´í„° í˜¸í™˜), ë³´ì—¬ì§€ëŠ” í…ìŠ¤íŠ¸ë§Œ "ë²ˆí˜¸ ì´ë¦„"
        label.innerHTML = `<input type="checkbox" value="${stu.name}" /> ${labelOf(stu)}`;
        container.appendChild(label);
      });
    }

    // ëŒ€ìƒ ì„ íƒ 'selected'ì¼ ë•Œë§Œ ì²´í¬ë°•ìŠ¤ ë³´ì´ê¸°
    document.getElementById("target").addEventListener("change", function () {
      const show = this.value === "selected";
      document.getElementById("student-checkboxes").style.display = show ? "block" : "none";
    });

    // ===========================================================
    // ê³¼ì œ ì™„ë£Œ ì €ì¥/ì¡°íšŒ (í•™ìƒë³„)
    // ===========================================================
    function getDoneTasks(student) {
      return JSON.parse(localStorage.getItem("doneTasks-" + student) || "{}");
    }

    function setDoneTasks(student, doneTasks) {
      localStorage.setItem("doneTasks-" + student, JSON.stringify(doneTasks));
    }
    
    // âœ… ê³µí†µ: ì™„ë£Œí‚¤ = ë‚ ì§œ@@ê³¼ì œëª…
    function makeDoneKey(dateStr, taskText) {
      return `${dateStr}@@${taskText}`;
    }
    
    // ì™„ë£Œ ì—¬ë¶€ ì½ê¸°(ë ˆê±°ì‹œ: ê³¼ì œëª… ë‹¨ë… í‚¤ë„ í—ˆìš©)
    function isDone(studentName, dateStr, taskText) {
      const store = getDoneTasks(studentName) || {};
      const doneKey = makeDoneKey(dateStr, taskText);
      return store[doneKey] === true || store[taskText] === true;
    }
    
    // ì™„ë£Œ ìƒíƒœ ì €ì¥/í•´ì œ
    function setDone(studentName, dateStr, taskText, done) {
      const store = getDoneTasks(studentName) || {};
      const doneKey = makeDoneKey(dateStr, taskText);
      if (done) store[doneKey] = true;
      else delete store[doneKey];
      setDoneTasks(studentName, store);
    }


    // ===========================================================
    // ê³¼ì œ ì…ë ¥ í–‰ ì¶”ê°€/ì‚­ì œ
    // ===========================================================
    function addTask() {
      const div = document.createElement("div");
      div.className = "task-input";
      div.innerHTML =
        '<input type="text" placeholder="í•  ì¼ ì…ë ¥" />' +
        '<button onclick="removeTask(this)">âŠ–</button>';
      document.getElementById("task-list").appendChild(div);
    }

    function removeTask(btn) {
      btn.parentElement.remove();
    }

    // ===========================================================
    // ê³¼ì œ ì €ì¥ (ì‹ ê·œ/í¸ì§‘ ëª¨ë“œ ê³µìš©)
    // ===========================================================
   
        // ë‚ ì§œ+ê³¼ì œëª…ìœ¼ë¡œ ìœ ë‹ˆí¬ í‚¤ ìƒì„±
    function makeTaskKey(dateStr, taskText){
     return `${dateStr}@@${taskText}`;
    }
    
    function saveAssignment() {
      // 1) ê¸°ë³¸ ì…ë ¥ê°’ ê²€ì¦
      const date = document.getElementById("task-date").value;
      if (!date) {
        alert("ê³¼ì œ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const repeat = document.getElementById("repeat").value;
      const target = document.getElementById("target").value;

      const newTasks = Array
        .from(document.querySelectorAll("#task-list input"))
        .map(i => i.value.trim())
        .filter(t => t !== "");

      if (newTasks.length === 0) {
        alert("ê³¼ì œë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      // 2) ëŒ€ìƒ í•™ìƒ êµ¬ì„±
      let students = [];
      if (target === "selected") {
        students = Array
          .from(document.querySelectorAll("#student-checkboxes input:checked"))
          .map(cb => cb.value);

        if (students.length === 0) {
          alert("í•™ìƒì„ í•˜ë‚˜ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.");
          return;
        }
      } else {
        students = ["ì „ì²´"];
      }

      // 3) í¸ì§‘ ëª¨ë“œ: ê¸°ì¡´ í•­ëª© ë®ì–´ì“°ê¸°
      if (isEditing) {
        const originalKey = "teacherTasks-" + editingOriginalDate; // í¸ì§‘ ì‹œì‘ ì‹œì ì˜ ë‚ ì§œ
        const newKey      = "teacherTasks-" + date;                // í˜„ì¬ ì…ë ¥ì°½ì˜ ë‚ ì§œ

        const data = { tasks: newTasks, repeat, students };

        if (newKey !== originalKey) {
          localStorage.removeItem(originalKey);
        }
        localStorage.setItem(newKey, JSON.stringify(data));

        // í¸ì§‘ ìƒíƒœ ì´ˆê¸°í™”
        isEditing = false;
        editingOriginalDate = null;

        alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        renderCalendar();
        renderStudentStatus();
        return;
      }

      // 4) ì‹ ê·œ ì €ì¥(ê°™ì€ ë‚ ì§œ ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•©)
      const key = "teacherTasks-" + date;
      const existingRaw = localStorage.getItem(key);
      let existing = null;

      if (existingRaw) {
        try {
          existing = JSON.parse(existingRaw);
        } catch {
          existing = null;
        }
      }

      let mergedTasks = [];
      let mergedStudents = [];

      if (existing) {
        mergedTasks = Array.from(new Set(existing.tasks.concat(newTasks)));
        mergedStudents = Array.from(new Set(existing.students.concat(students)));
      } else {
        mergedTasks = newTasks;
        mergedStudents = students;
      }

      const data = { tasks: mergedTasks, repeat, students: mergedStudents };
      localStorage.setItem(key, JSON.stringify(data));

      alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
      loadSavedTasks();
      renderCalendar();
      renderStudentStatus();
    }

    // ===========================================================
    // ì €ì¥ëœ ê³¼ì œ ëª©ë¡ ì¶œë ¥(í•„ìš” ì‹œ)
    // ===========================================================
    function loadSavedTasks() {
      const container = document.getElementById("task-storage");
      if (!container) return; // í•´ë‹¹ ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì¢…ë£Œ

      const filter = document.getElementById("filter-date")?.value || "";
      container.innerHTML = "";

      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith("teacherTasks-")) continue;

        const date = key.replace("teacherTasks-", "");
        if (filter && filter !== date) continue;

        const data = JSON.parse(localStorage.getItem(key));
        const d = new Date(date);
        const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
        const formattedDate = `${d.getMonth()+1}ì›” ${d.getDate()}ì¼ (${dayNames[d.getDay()]})`;

        const div = document.createElement("div");
        div.className = "saved-item";
        div.innerHTML = `
          <strong>${date}</strong> (${formattedDate}) | ëŒ€ìƒ: ${data.students.join(", ")}<br>
          ğŸ“Œ ${data.tasks.join(", ")}<br>
          ğŸ” ë°˜ë³µ: ${data.repeat}<br>
          <button onclick="copyTask('${date}')">ğŸ“„ ë³µì‚¬</button>
          <button onclick="deleteTask('${date}')">âŒ ì‚­ì œ</button>
        `;
        container.appendChild(div);
      }
    }

    // ===========================================================
    // ê³¼ì œ ì‚­ì œ/ë³µì‚¬
    // ===========================================================
    function deleteTask(date) {
      if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      localStorage.removeItem("teacherTasks-" + date);
      loadSavedTasks();
      renderCalendar();
      renderStudentStatus();
    }

    function copyTask(date) {
      const data = JSON.parse(localStorage.getItem("teacherTasks-" + date));
      const taskList = document.getElementById("task-list");
      taskList.innerHTML = "";

      (data.tasks || []).forEach(task => {
        const div = document.createElement("div");
        div.className = "task-input";
        div.innerHTML = `<input type="text" value="${task}" /><button onclick="removeTask(this)">âŠ–</button>`;
        taskList.appendChild(div);
      });

      document.getElementById("task-date").value = date;
      document.getElementById("repeat").value = data.repeat;

      const isAll = data.students.includes("ì „ì²´");
      document.getElementById("target").value = isAll ? "all" : "selected";
      document.getElementById("student-checkboxes").style.display = isAll ? "none" : "block";

      if (!isAll) {
        document.querySelectorAll("#student-checkboxes input").forEach(input => {
          input.checked = data.students.includes(input.value);
        });
      }
    }

    // ===========================================================
    // ë‹¬ë ¥ ë Œë”ë§ (ë°˜ë³µ ê³¼ì œ ê³„ì‚° í¬í•¨)
    // ===========================================================
    function renderCalendar() {
      const tbody = document.getElementById("calendar-body");
      tbody.innerHTML = "";

      // ë‚ ì§œë³„ ì°¸ì¡° ì´ˆê¸°í™”
      calendarRefs = {};
      
      const year  = viewYear;
      const month = viewMonth;

      const firstDay         = new Date(year, month, 1);
      const startDay         = firstDay.getDay();      // 0(ì¼)~6(í† )
      const adjustedStartDay = (startDay + 6) % 7;     // ì›”ì„ 0ìœ¼ë¡œ ë§ì¶˜ ì •ë ¬
      const lastDate         = new Date(year, month + 1, 0).getDate();

      // 1) ì›ë³¸ ê³¼ì œ ëª¨ë‘ ë¡œë“œ
      const originals = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith("teacherTasks-")) continue;

        const dateKey = key.replace("teacherTasks-", "");
        const data    = JSON.parse(localStorage.getItem(key) || "null");
        if (!data) continue;

        originals.push({ key, dateKey, data });
      }

      // 2) ì´ë²ˆ ë‹¬ ìº˜ë¦°ë”ì— í‘œì‹œë  ì¸ìŠ¤í„´ìŠ¤ ë§Œë“¤ê¸°
      const instancesMap = {};
      const pushInstance = (dateStr, key, taskIndex, text) => {
        instancesMap[dateStr] ??= [];
        instancesMap[dateStr].push({ key, taskIndex, text });
      };
      const pad2 = (n) => String(n).padStart(2, "0");

      for (const { key, dateKey, data } of originals) {
        const tasks = data.tasks || [];
        const rpt   = data.repeat || "none";

        if (rpt === "daily") {
          for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${year}-${pad2(month + 1)}-${pad2(d)}`;
            tasks.forEach((t, idx) => pushInstance(dateStr, key, idx, t));
          }
        } else if (["mon","tue","wed","thu","fri"].includes(rpt)) {
          const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
          for (let d = 1; d <= lastDate; d++) {
            const dateObj = new Date(year, month, d);
            if (dateObj.getDay() === dayMap[rpt]) {
              const dateStr = `${year}-${pad2(month + 1)}-${pad2(d)}`;
              tasks.forEach((t, idx) => pushInstance(dateStr, key, idx, t));
            }
          }
        } else {
          // ë°˜ë³µ ì—†ìŒ: ì›ë³¸ ë‚ ì§œë§Œ
          const dateStr = dateKey;
          tasks.forEach((t, idx) => pushInstance(dateStr, key, idx, t));
        }
      }

      // 3) calendarRefs êµ¬ì„± (ë‚ ì§œë³„ â†’ [{key, taskIndex}...])
      for (const [dateStr, arr] of Object.entries(instancesMap)) {
        calendarRefs[dateStr] = arr.map(({ key, taskIndex }) => ({ key, taskIndex }));
      }

      // 4) í‘œ HTML ìƒì„±
      let html = "<tr>";

      for (let i = 0; i < adjustedStartDay; i++) {
        html += "<td></td>";
      }

      for (let day = 1; day <= lastDate; day++) {
        const dateStr = `${year}-${pad2(month + 1)}-${pad2(day)}`;
        const pills = (instancesMap[dateStr] || []).map((inst, idx) => {
          const esc = inst.text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
          return `<div class="task-pill" onclick="selectTask('${dateStr}', ${idx})">${esc}</div>`;
        }).join("");

        html += `<td><strong>${day}</strong>${pills}</td>`;

        if ((adjustedStartDay + day) % 7 === 0) {
          html += "</tr><tr>";
        }
      }

      html += "</tr>";
      tbody.innerHTML = html;
      setCalLabel();
    }

    // ===========================================================
    // ê³¼ì œ í¸ì§‘/ì‚­ì œ/í™•ì¸
    // ===========================================================
    function editTask() {
      if (!selectedDate) {
        alert("ê³¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      // ì„ íƒí•œ ë‚ ì§œì˜ ì°¸ì¡° ëª©ë¡ ì¤‘, í˜„ì¬ selectedTaskIndexë¥¼ ê°€ì§„ ì›ë³¸ ì°¾ê¸°
      const refs = calendarRefs[selectedDate] || [];
      const found = refs.find(r => {
        const data = JSON.parse(localStorage.getItem(r.key) || "null");
        return data?.tasks?.[selectedTaskIndex] !== undefined;
      });

      if (!found) {
        alert("ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const data = JSON.parse(localStorage.getItem(found.key) || "{}");

      // ì…ë ¥ì°½ì— ê°’ ì±„ì›Œë„£ê¸°
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';

      (data.tasks || []).forEach(task => {
        const div = document.createElement('div');
        div.className = 'task-input';
        div.innerHTML = `<input type="text" value="${task}"/><button onclick="removeTask(this)">âŠ–</button>`;
        taskList.appendChild(div);
      });

      // ì›ë³¸ ë‚ ì§œ
      const originalDate = found.key.replace("teacherTasks-", "");
      document.getElementById('task-date').value = originalDate;
      document.getElementById('repeat').value    = data.repeat || 'none';

      const target = (data.students || []).includes('ì „ì²´') ? 'all' : 'selected';
      document.getElementById('target').value = target;
      document.getElementById('student-checkboxes').style.display = (target === 'selected') ? 'block' : 'none';

      if (target === 'selected') {
        const set = new Set(data.students || []);
        document.querySelectorAll('#student-checkboxes input').forEach(cb => {
          cb.checked = set.has(cb.value);
        });
      }

      isEditing = true;
      editingOriginalDate = originalDate;

      // ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteTaskClicked() {
      if (!selectedDate || selectedTaskIndex == null) {
        alert("ê³¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      const refs = calendarRefs[selectedDate] || [];
      const ref = refs.find(r => {
        const d = JSON.parse(localStorage.getItem(r.key) || "null");
        return d?.tasks?.[selectedTaskIndex] !== undefined;
      });

      if (!ref) {
        alert("ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const data  = JSON.parse(localStorage.getItem(ref.key) || "null");
      const target = data.tasks[selectedTaskIndex];

      if (!confirm(`"${target}" ê³¼ì œë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;

      data.tasks.splice(selectedTaskIndex, 1);

      if (data.tasks.length === 0) {
        localStorage.removeItem(ref.key);
      } else {
        localStorage.setItem(ref.key, JSON.stringify(data));
      }

      selectedTaskIndex = null;
      document.getElementById('task-action-buttons').style.display = 'none';

      renderCalendar();
      renderStudentStatus();
    }


    function closeTaskCompletion() {
      document.getElementById("task-completion").style.display = "none";
    }

    // ===========================================================
  // ë‹¬ë ¥: ê³¼ì œ ì„ íƒ ì‹œ ìƒíƒœ ê°±ì‹ 
   // ===========================================================
    function selectTask(dateStr, idx) {
      selectedDate = dateStr;
      selectedTaskIndex = null;
      selectedTaskText = "";
      selectedOriginDate = null;
      selectedOriginKey  = null;
  
      const refs = calendarRefs[dateStr] || [];
      const ref  = refs[idx];

      const $btns     = document.getElementById('task-action-buttons');
      const $selected = document.getElementById('task-action-selected');
      const $compBox  = document.getElementById('task-completion');

      // 1) ìœ íš¨ì„± ê²€ì‚¬
      if (!ref) {
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }

      // 2) ì›ë³¸ ë°ì´í„° ì½ê¸° (null-safe)
      let pack = null;
      try {
        pack = JSON.parse(localStorage.getItem(ref.key) || 'null');
      } catch {
        pack = null;
      }
      const text = pack?.tasks?.[ref.taskIndex];

      if (typeof text !== 'string' || text.trim() === "") {
        // ë°ì´í„° ì†ìƒ/ì¸ë±ìŠ¤ ë¶ˆì¼ì¹˜
        if ($btns)     $btns.style.display = 'none';
        if ($compBox)  $compBox.style.display = 'none';
        if ($selected) $selected.textContent = "";
        return;
      }

      // 3) ìƒíƒœ í™•ì • (ì›ë³¸ ë‚ ì§œ ì €ì¥: doneKey ê³„ì‚°ìš©)
      selectedTaskIndex  = ref.taskIndex;
      selectedTaskText   = text;
      selectedOriginDate = ref.key.replace('teacherTasks-', '');
      selectedOriginKey  = ref.key; // í™•ì¸ ë²„íŠ¼ì—ì„œ ê·¸ëŒ€ë¡œ ì‚¬ìš©

      // 4) UI ê°±ì‹ 
      if ($selected) $selected.textContent = `ì„ íƒ: ${dateStr} â€” ${selectedTaskText}`;

      // 5) âœ… í•™ìƒ ëª©ë¡ì„ ì¦‰ì‹œ ë Œë” & í‘œì‹œ
      if (typeof renderTaskCompletion === 'function') {
        renderTaskCompletion(selectedOriginKey, selectedTaskIndex);
      }
      if ($compBox) $compBox.style.display = 'block';

      // 6) âœ… ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ + í•™ìƒ ëª©ë¡ 'ì•„ë˜'ë¡œ ì´ë™
      if ($btns) {
        $btns.style.display = 'block';
        const parent = $compBox?.parentNode;
        if (parent && $compBox) {
          parent.insertBefore($btns, $compBox.nextSibling); // ëª©ë¡ ë°”ë¡œ ë‹¤ìŒìœ¼ë¡œ ì´ë™
        }
      }
      
    }


    // ===========================================================
    // ê³¼ì œë³„ í•™ìƒ ì™„ë£Œ ì—¬ë¶€ ë Œë”ë§
    // ===========================================================
    function renderTaskCompletion(originKey, taskIdx) {
      const container = document.getElementById("completion-list");
      container.innerHTML = "";

      // 0) ì¸ì ê²€ì¦
      if (!originKey || typeof taskIdx !== 'number') {
        container.textContent = "ì›ë³¸ ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      // 1) ì›ë³¸ ì½ê¸°
      let data = null;
      try {
        data = JSON.parse(localStorage.getItem(originKey) || "null");
      } catch {
        data = null;
      }
      if (!data || !Array.isArray(data.tasks) || data.tasks[taskIdx] == null) {
        container.textContent = "ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const task       = data.tasks[taskIdx];
      const originDate = originKey.replace("teacherTasks-",""); // YYYY-MM-DD
     

      // 2) ëŒ€ìƒ í•™ìƒ + ì •ë ¬
      let students = getStudentsSorted();
      if (!data.students.includes("ì „ì²´")) {
        const set = new Set(data.students || []);
        students  = students.filter(s => set.has(s.name));
      }

      // 3) ì œëª©
      const h = document.createElement('h4');
      h.textContent = `ğŸ“Œ ${task} (${originDate})`;
      container.appendChild(h);

      // 4) ì¹© ë Œë” (í´ë¦­ í† ê¸€)
      const grid = document.createElement('div');
      grid.className = "student-chip-grid";
      grid.style.userSelect = "none"; // ë“œë˜ê·¸ ë°©ì§€

      students.forEach(stu => {
        const done = isDone(stu.name, originDate, task);

        const chip = document.createElement('div');
        chip.className = "student-chip" + (done ? "" : " missed");
        chip.dataset.student = stu.name;
        chip.dataset.date = originDate;
        chip.dataset.task = task;
        chip.style.cursor = "pointer";
        chip.textContent = `${stu.id} ${stu.name}`;
        grid.appendChild(chip);
      });

      container.appendChild(grid);

      // 5) ì¹© í´ë¦­ â†’ ì €ì¥/í•´ì œ + UI ì¦‰ì‹œ ë°˜ì˜ + êµì‚¬ í™”ë©´ ê°±ì‹ 
      grid.onclick = (e) => {
        const chip = e.target.closest('.student-chip');
        if (!chip) return;

        const student = chip.dataset.student;
        const dateStr = chip.dataset.date;
        const taskTxt = chip.dataset.task;

        const nowIsDone = !chip.classList.contains('missed'); // í˜„ì¬ ìƒíƒœ
        setDone(student, dateStr, taskTxt, !nowIsDone);

        chip.classList.toggle('missed', nowIsDone); // UI ë°˜ì˜
  
        // êµì‚¬ â€˜ì˜¤ëŠ˜ í•  ì¼â€™ ì¦‰ì‹œ ê°±ì‹ 
        if (typeof renderStudentStatus === 'function') renderStudentStatus();
      };
    }

    // ===========================================================
    // 'ì˜¤ëŠ˜ í•  ì¼' í™”ë©´ ë Œë”ë§ (í•™ìƒë³„ ì¹´ë“œ)
    // ===========================================================
    function renderStudentStatus() {
      const container = document.getElementById("student-status-list");
      container.innerHTML = "";

      // í•™ìƒ ëª©ë¡(ê°ì²´) ì •ë ¬
      const students = getStudentsSorted();

      // ì €ì¥ëœ ëª¨ë“  ê³¼ì œ ë¡œë“œ
      let allAssignments = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (!key.startsWith("teacherTasks-")) continue;

        const data    = JSON.parse(localStorage.getItem(key));
        const dateStr = key.replace("teacherTasks-", "");

        allAssignments.push({ ...data, date: dateStr });
      }

      // ì˜¤ëŠ˜ ê¸°ì¤€ í•„í„° + í‘œì‹œìš© ë‚ ì§œ ë¬¸ìì—´ ìƒì„±
      const today = new Date(); today.setHours(0,0,0,0);

      const validAssignments = allAssignments
        .filter(assign => {
          if (!assign.date) return false;
          const dateObj = new Date(assign.date);
          if (isNaN(dateObj)) return false;
          dateObj.setHours(0,0,0,0);
          return dateObj <= today;     // ì˜¤ëŠ˜ ì´ì „/ì˜¤ëŠ˜ë§Œ
        })
        .map(assign => {
          const dateObj = new Date(assign.date);
          dateObj.setHours(0,0,0,0);
          const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
          const formattedDate = `${dateObj.getMonth()+1}ì›” ${dateObj.getDate()}ì¼ (${dayNames[dateObj.getDay()]})`;
          return { ...assign, dateObj, formattedDate };
        })
        .sort((a, b) => b.dateObj - a.dateObj); // ìµœì‹  ë‚ ì§œ ìš°ì„ 

      // í•™ìƒë³„ ì¹´ë“œ êµ¬ì„±
      students.forEach(stu => {
        const div = document.createElement("div");
        div.style.border = "1px solid #e6e8eb";
        div.style.padding = "12px";
        div.style.borderRadius = "16px";
        div.style.background = "#fff";
        div.style.boxShadow = "0 4px 10px rgba(0,0,0,.04)";
        div.style.marginBottom = "10px";

        // ì œëª©: ë²ˆí˜¸ ì´ë¦„
        div.innerHTML = `ğŸ‘¦ ${labelOf(stu)}<div style="margin-top: 10px;">`;

        validAssignments.forEach(assign => {
          const assigned = assign.students.includes("ì „ì²´") || assign.students.includes(stu.name);
          if (!assigned) return;

          assign.tasks.forEach(task => {
            const store  = getDoneTasks(stu.name) || {};
            const doneKey = `${assign.date}@@${task}`;
            // ì™„ë£Œ ì—¬ë¶€ ê³„ì‚° (ë‚ ì§œ+ê³¼ì œëª… ê¸°ì¤€, ë ˆê±°ì‹œ ê³¼ì œëª… í‚¤ë„ í—ˆìš©)
            const done = isDone(stu.name, assign.date, task);
            const isPast = assign.dateObj < today;

            if (done && isPast) return; // ê³¼ê±° ì™„ë£Œ ê³¼ì œëŠ” ìˆ¨ê¹€

            let color = "#f6c1c1";
            let dateColor = "#666";

            if (isPast && !done) {
              color = "#c0392b";     // ì§€ë‚œ ë¯¸ì™„ë£Œ: ê°•ì¡°(ë¶‰ì€í†¤)
              dateColor = "#fff";
            } else if (!isPast && done) {
              color = "white";    // ì˜¤ëŠ˜ ì™„ë£Œ: í°ìƒ‰
              dateColor = "#666";
            }

            div.innerHTML += `
              <div class="student-chip ${done ? '' : 'missed'}"
                   style="
                    border: 1px solid #e6e8eb;
                    background: ${color};
                    padding: 8px;
                    border-radius: 12px;
                    margin: 6px 0;
                    display:flex;
                    justify-content:space-between;
                    align-items:center;
                    cursor:pointer;"
                   data-student="${stu.name}"
                   data-date="${assign.date}"
                   data-task="${task}">
                <span>${task}</span>
                <span style="font-size:10px; color:${dateColor};">${assign.formattedDate}</span>
              </div>
            `;
          });
        });

        div.innerHTML += "</div>";
        container.appendChild(div);
      });
    }
    
    // 'ì˜¤ëŠ˜ í•  ì¼' í•™ìƒ ì¹© í´ë¦­ ë¸ë¦¬ê²Œì´ì…˜ (í•œ ë²ˆë§Œ ë°”ì¸ë”©)
    (function attachStudentStatusDelegation(){
      const container = document.getElementById('student-status-list');
      if (!container) return;

      container.addEventListener('click', (e) => {
        const chip = e.target.closest('.student-chip');
        if (!chip || !container.contains(chip)) return;

    // data-*ì—ì„œ ì •ë³´ ì½ê¸°
    const student = chip.dataset.student;
    const dateStr = chip.dataset.date;
    const taskTxt = chip.dataset.task;

    // í˜„ì¬ ìƒíƒœ(ì™„ë£Œ ì—¬ë¶€)
    const nowIsDone = !chip.classList.contains('missed');

    // ì €ì¥/í•´ì œ (í—¬í¼ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì‚¬ìš©)
    // --- í—¬í¼ ì—†ì´ ì§ì ‘ ì €ì¥ ---
    const dKey  = `${dateStr}@@${taskTxt}`;
    const store = getDoneTasks(student) || {};
    if (nowIsDone) {
      // ì™„ë£Œ â†’ í´ë¦­ ì‹œ ë¯¸ì™„ë£Œ
      delete store[dKey];
      chip.classList.add('missed');
    } else {
      // ë¯¸ì™„ë£Œ â†’ í´ë¦­ ì‹œ ì™„ë£Œ
      store[dKey] = true;
      chip.classList.remove('missed');
    }
    setDoneTasks(student, store);

    // êµì‚¬ 'ì˜¤ëŠ˜ í•  ì¼' ì¦‰ì‹œ ê°±ì‹ 
    renderStudentStatus();
  }, false);
})();


    // ===========================================================
    // í•™ìƒ ë°ì´í„° ë¡œë“œ/ì €ì¥
    // ===========================================================
    function loadStudents() {
      const raw = localStorage.getItem("students");
      return raw ? JSON.parse(raw) : [];
    }

    function saveStudents(students) {
      localStorage.setItem("students", JSON.stringify(students));
    }

    // ===========================================================
    // í•™ìƒ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    // ===========================================================
    function renderStudentList() {
      const students = getStudentsSorted();
      const showAll = document.getElementById("show-all-passwords")?.checked;
      const tbody = document.querySelector("#student-list tbody");

      tbody.innerHTML = "";

      students.forEach(stu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="col-id">
            <input data-field="id" value="${stu.id}" />
          </td>
          <td>
            <input data-field="name" value="${stu.name}" />
          </td>
          <td>
            <input data-field="password" ${showAll ? 'type="text"' : 'type="password"'} value="${stu.password}" />
          </td>
          <td style="text-align:center;">
            <input type="checkbox" onchange="toggleRowPw(this)" ${showAll ? "checked" : ""}/>
          </td>
          <td class="col-actions">
            <div class="actions">
              <button onclick="saveStudentRow('${stu.id}','${stu.name}', this)">ì €ì¥</button>
              <button onclick="deleteStudentByKey('${stu.id}','${stu.name}')">ì‚­ì œ</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ===========================================================
    // í•™ìƒ: ë¹„ë°€ë²ˆí˜¸ ë³´ê¸° í† ê¸€(í–‰ ë‹¨ìœ„ / ì „ì²´)
    // ===========================================================
    function toggleRowPw(checkboxEl) {
      const tr = checkboxEl.closest("tr");
      const pwInput = tr.querySelector('input[data-field="password"]');
      pwInput.type = checkboxEl.checked ? "text" : "password";
    }

    function toggleAllPw(masterCheckbox) {
      const show = masterCheckbox.checked;

      // í‘œ ì „ì²´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì°½ íƒ€ì… ë³€ê²½
      document
        .querySelectorAll('#student-list tbody input[data-field="password"]')
        .forEach(inp => (inp.type = show ? "text" : "password"));

      // ê° í–‰ì˜ ê°œë³„ ì²´í¬ë°•ìŠ¤ë„ ìƒíƒœ ë™ê¸°í™”
      document
        .querySelectorAll('#student-list tbody input[type="checkbox"]')
        .forEach(cb => (cb.checked = show));
    }

    // ===========================================================
    // í•™ìƒ: ì¶”ê°€/ì €ì¥/ì‚­ì œ
    // ===========================================================
    function addStudent() {
      const id = document.getElementById("new-student-id").value.trim();
      const name = document.getElementById("new-student-name").value.trim();
      const password = document.getElementById("new-student-password").value.trim();

      if (!id || !name || !password) {
        alert("ë²ˆí˜¸, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const students = loadStudents();

      // ì¤‘ë³µ ë²ˆí˜¸ ì²´í¬
      if (students.some(s => s.id === id)) {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤.");
        return;
      }

      students.push({ id, name, password });
      saveStudents(students);

      // ì…ë ¥ì°½ ì´ˆê¸°í™” + ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
      document.getElementById("new-student-id").value = "";
      document.getElementById("new-student-name").value = "";
      document.getElementById("new-student-password").value = "";
      renderStudentList();
    }

    function saveStudentRow(oldId, oldName, btnEl) {
      const tr = btnEl.closest("tr");

      const newId = tr.querySelector('input[data-field="id"]').value.trim();
      const newName = tr.querySelector('input[data-field="name"]').value.trim();
      const newPw = tr.querySelector('input[data-field="password"]').value.trim();

      if (!newId || !newName || !newPw) {
        alert("ë²ˆí˜¸, ì´ë¦„, ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(oldId) && s.name === oldName);

      if (idx < 0) {
        alert("ëŒ€ìƒ í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // ë²ˆí˜¸ ë³€ê²½ ì‹œ ì¤‘ë³µ ë°©ì§€
      if (String(newId) !== String(oldId) && students.some(s => String(s.id) === String(newId))) {
        alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤.");
        return;
      }

      // ì—…ë°ì´íŠ¸
      students[idx] = { id: newId, name: newName, password: newPw };
      saveStudents(students);

      // í™”ë©´ ê°±ì‹  (ì²´í¬ë°•ìŠ¤/í˜„í™©/ë‹¬ë ¥ë„ í•¨ê»˜)
      renderStudentList();
      renderStudentListToCheckbox?.();
      renderStudentStatus?.();
    }

    // (ë¯¸ì‚¬ìš© ê²½ë¡œ ë³´í˜¸ìš©)
    function deleteStudent(index) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const students = loadStudents();
      students.splice(index, 1);
      saveStudents(students);

      renderStudentList();
    }

    function deleteStudentByKey(id, name) {
      if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      const students = loadStudents();
      const idx = students.findIndex(s => String(s.id) === String(id) && s.name === name);

      if (idx >= 0) {
        students.splice(idx, 1);
        saveStudents(students);

        // í™”ë©´ ê°±ì‹ (ì²´í¬ë°•ìŠ¤/í˜„í™©/ë‹¬ë ¥)
        renderStudentList();
        renderStudentListToCheckbox();
        renderStudentStatus();
      }
    }

    // ===========================================================
    // ìµœì´ˆ ë¡œë“œ ì‹œ ì¼ë¶€ ë Œë” í˜¸ì¶œ
    // ===========================================================
    loadSavedTasks();
    renderCalendar();
    renderStudentStatus();
    renderStudentList();
  </script>
</body>
</html>
