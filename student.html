<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>오늘 할 일 (학생용)</title>

  <!-- 폰트: 제목=Jua, 본문/버튼=SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">

  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js" defer></script>

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --btn:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);
      --chip:#ffffff;
    }

    *{box-sizing:border-box}

    /* 구름 배경 */
    html,body{height:100%}
    body{
      margin:0;
      padding-top: 120px; /* 로고 칩 여백 */
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      position:relative;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; opacity:.9; pointer-events:none;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }

    /* 상단 로고 칩 (기존 header 유지) */
    header{
      position: fixed;
      top: 18px; left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: var(--chip);
      padding: 8px 10px;
      border-radius: 16px;
      border:1px solid var(--card-line);
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    #logo{
      width: 64px; height:auto; cursor:pointer; display:block;
    }

    /* 메인 컨테이너 카드 */
    body{
      max-width: 760px;
      margin: 0 auto;
      text-align: center;
      padding-left: 0;
      padding-right: 0;
    }
    #task-box{
      border: 1px solid var(--card-line);
      background: var(--card);
      padding: 28px 24px;
      border-radius: 26px;
      margin: 0 16px 40px;
      box-shadow: 0 16px 40px rgba(0,0,0,.10);
    }

    /* 날짜/제목 */
    #today-date{
      margin: 10px 0 18px;
      font-family:'Jua',sans-serif;  /* 제목 서체 */
      font-weight: 400;
      font-size: 28px;
      letter-spacing:-.2px;
    }

    /* 날짜 네비게이션 버튼 */
    #date-nav{ margin-bottom: 8px; }
    #date-nav button{
      margin: 0 8px;
      padding: 10px 14px;
      cursor: pointer;
      border-radius: 999px;
      border:1px solid var(--card-line);
      background:#fff;
      font: inherit;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    #date-nav button:hover{ filter:brightness(0.98); }

    /* 할 일 박스들 (JS가 배경색을 따로 지정해도 테두리/모양은 유지) */
    .task-box{
     width: 46%;
     display: inline-flex;              /* ← inline-block → inline-flex 로 변경 */
     justify-content: space-between;    /* 좌우 배치 */
     align-items: center;
     gap: 12px;                         /* 이름과 날짜 간격 */
     border: 2px solid #dcdfe4;
     padding: 16px 14px;
     border-radius: 20px;
     font-size: 18px;
     cursor: pointer;
     user-select: none;
     box-shadow: 0 2px 0 rgba(0,0,0,.02) inset, 0 4px 10px rgba(0,0,0,.05);
    }
    .task-name{ flex:1; min-width:0; text-align:left; 
     overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* 긴 제목 말줄임 */


    .task-date{
     font-size:13px;
     padding:4px 10px;
     border-radius:999px;
     background:#ffffff;         /* 기본: 흰색 캡슐 */
     color:#666;
     white-space:nowrap;
     border:1px solid rgba(0,0,0,.05);
    }
    
    .task-box.done{
      background: transparent !important;
      color: #9aa6b2 !important;
      border-color: #dcdfe4 !important;
      text-decoration: line-through;
    }

    /* 과거 미완료(빨강 배경)에서도 읽기 좋은 색감 */
    .task-box.past:not(.done) .task-date{
     background: rgba(255,255,255,.9);
     color:#7a2d2d;
     border-color: transparent;
    }
 
   /* 오늘 표기 전용 강조(원하면 유지/삭제 가능) */
   .task-date.is-today{
    background:#2e7d57;
    color:#fff;
    border-color: transparent;
   }

    /* 로그아웃 버튼 */
    button#logout-btn{
      font-size: 18px;
      padding: 14px 22px;
      cursor: pointer;
      border: 0;
      border-radius: 22px;
      color: #fff;
      background: var(--btn);
      box-shadow: 0 12px 28px var(--btn-shadow);
      font-family:'SUIT',sans-serif;
      margin-top: 14px;
    }
    button#logout-btn:hover{ filter:brightness(1.04); }

    /* 반응형 */
    @media (max-width:560px){
      .task-box{ width: 96%; margin: 8px 2%; font-size: 17px; }
      #today-date{ font-size: 24px; }
      #logo{ width:58px; }
      header{ padding:6px 8px; }
    }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="오늘 할 일 로고" id="logo" onclick="location.href='index.html';" />
</header>

<div id="task-box" style="display:none;">
  <div id="date-nav">
    <button id="prev-day">◀ 이전날</button>
    <button id="next-day">다음날 ▶</button>
  </div>
  <h2 id="today-date"></h2>
  <div id="todo-container"></div>
  <button id="logout-btn">로그아웃</button>
</div>

<script>
  let currentStudent = null;
  let currentDate = new Date();

  const taskBox = document.getElementById("task-box");
  const todoContainer = document.getElementById("todo-container");
  const todayDate = document.getElementById("today-date");
  const logoutBtn = document.getElementById("logout-btn");
  const prevDayBtn = document.getElementById("prev-day");
  const nextDayBtn = document.getElementById("next-day");

  function loadStudents() {
    const raw = localStorage.getItem("students");
    return raw ? JSON.parse(raw) : [];
  }

  function formatDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function displayDate(d) {
    const month = d.getMonth() + 1;
    const date = d.getDate();
    const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
    const day = dayNames[d.getDay()];
    return `${month}월 ${date}일 (${day})`;
  }
  
  function getDoneTasks(student) {
    return getJSON("doneTasks-" + student, {});
  }

  function setDoneTasks(student, doneTasks) {
    setJSON("doneTasks-" + student, doneTasks);
  }

  function makeTaskKey(dateStr, taskText){
    return `${dateStr}@@${taskText}`;
  }
  
  function getAllAssignments() {
    // 공통: teacherTasks-* 전부 한 번에 로드
    const originals = loadAllTeacherTasks();
    // 학생 화면에서 필요한 필드(date, tasks)만 매핑
    return originals.map(({ dateKey, data }) => ({
      date: dateKey,
      tasks: data?.tasks || []
    }));
  }

  function renderTasks() {
    todoContainer.innerHTML = "";
    const doneTasks = getDoneTasks(currentStudent);
    const assignments = getAllAssignments();

    const today0 = normalizeDate(new Date());

    const currDateStr = formatDate(currentDate);

    todayDate.textContent = displayDate(currentDate);

    assignments
      .filter(a => {
        const taskDate = normalizeDate(a.date);
        const currDate0 = normalizeDate(currentDate);
        return taskDate <= currDate0;
      })
      .forEach(({date, tasks}) => {
        const taskDate = normalizeDate(a.date);
        const isPast = taskDate < today0;

        tasks.forEach(taskName => {
          const doneKey = makeTaskKey(date, taskName); // date는 forEach 상단에 있는 변수
          const done = (doneTasks[doneKey] === true) || (doneTasks[taskName] === true);
          if (doneTasks[taskName] === true && doneTasks[doneKey] !== true) {
          doneTasks[doneKey] = true;
          delete doneTasks[taskName];
          setDoneTasks(currentStudent, doneTasks);
          }


          if (done && isPast) {
            return;
          }

        const box = document.createElement("div");
        box.className = "task-box" + (done ? " done" : "");
 
        // 날짜 계산
        const currDate0 = new Date(currentDate); currDate0.setHours(0,0,0,0);
        const isToday = taskDate.getTime() === currDate0.getTime();

        // 날짜 라벨: 오늘이면 '오늘', 아니면 '8월 24일 (일)' 형식
        const dayNames = ['일','월','화','수','목','금','토'];
        const labelText = isToday
          ? '오늘'
          : `${taskDate.getMonth()+1}월 ${taskDate.getDate()}일 (${dayNames[taskDate.getDay()]})`;

        // 내부 레이아웃 (이름 + 날짜 뱃지)
        box.innerHTML = `
          <span class="task-name">${escapeHTML(taskName)}</span>
          <span class="task-date${isToday ? ' is-today' : ''}">${labelText}</span>
        `;

        // 상태별 배경색 (기존 로직 유지)
        if (done) {
          box.style.backgroundColor = "transparent";
          box.style.color = "#999";
        } else if (isPast) {
          box.style.backgroundColor = "#f05555";
          box.style.color = "#fff";
          box.classList.add('past'); // ← 과거 미완료 스타일 보조
        } else {
          box.style.backgroundColor = "#f6c1c1";
          box.style.color = "#000";
        }

        // 클릭 토글
       box.onclick = () => {
         const k = makeTaskKey(date, taskName);
         if (doneTasks[taskName] === true && doneTasks[k] !== true) {
           delete doneTasks[taskName];
         }
         doneTasks[k] = !done;
         setDoneTasks(currentStudent, doneTasks);
         renderTasks();
       };

        todoContainer.appendChild(box);

        });
      });
  }

  prevDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() - 1);
    renderTasks();
  };

  nextDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() + 1);
    renderTasks();
  };

  window.onload = () => {
    const savedStudent = localStorage.getItem('currentStudent');
    if (savedStudent) {
      currentStudent = savedStudent;
      taskBox.style.display = "block";
      renderTasks();
    } else {
      location.href = "index.html";
    }
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem('currentStudent');
    location.href = "index.html";
  };
</script>
</body>
</html>
