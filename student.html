<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ í•  ì¼</title>

  <!-- í°íŠ¸: SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">
  
  <!-- ê³µí†µ -->
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js"></script>
  <script src="js/challenges.js"></script>

  <style>
     .student-page{
       --btn:#2e7d57;
       --chip:#ffffff;
    }

    *{box-sizing:border-box}

    /* êµ¬ë¦„ ë°°ê²½ */
    html,body{height:100%}
    body{
      margin:0;
      padding-top: 96px;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      position:relative;
      
      padding-left:0;
      padding-right:0;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; opacity:.9; pointer-events:none;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }

    /* ì „ì²´ ë ˆì´ì•„ì›ƒ ì»¨í…Œì´ë„ˆ */
    .container{
      width:calc(100% - 40px);
      margin:0 auto;
    }
    
    /* ë‚ ì§œ/ì œëª© */
    #today-date{
      margin: 10px 0 18px;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      font-weight: 500;
      font-size: 28px;
      letter-spacing:-.2px;
      text-align:center;
    }

    /* ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
    #date-nav{ margin-bottom: 8px; text-align:center; }
    #date-nav button{
      margin: 0 8px;
      padding: 10px 14px;
      cursor: pointer;
      border-radius: 999px;
      border:1px solid var(--card-line);
      background:#fff;
      font: inherit;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    #date-nav button:hover{ filter:brightness(0.98); }

    /* í•  ì¼ ë°•ìŠ¤ë“¤ (JSê°€ ë°°ê²½ìƒ‰ì„ ë”°ë¡œ ì§€ì •í•´ë„ í…Œë‘ë¦¬/ëª¨ì–‘ì€ ìœ ì§€) */
    .task-box{
     width: 46%;
     display: inline-flex;              /* â† inline-block â†’ inline-flex ë¡œ ë³€ê²½ */
     justify-content: space-between;    /* ì¢Œìš° ë°°ì¹˜ */
     align-items: center;
     gap: 12px;                         /* ì´ë¦„ê³¼ ë‚ ì§œ ê°„ê²© */
     border: 2px solid #dcdfe4;
     padding: 16px 14px;
     border-radius: 20px;
     font-size: 18px;
     cursor: pointer;
     user-select: none;
     box-shadow: 0 2px 0 rgba(0,0,0,.02) inset, 0 4px 10px rgba(0,0,0,.05);
    }
    .task-box.pending{
     background:#f6c1c1;
     color:#000;
    }
    .task-box.past.pending{
     background:#f05555;
     color:#fff;
    }
    .task-box.postponed{
     background:#fddf7f;
     color:#000;
     border-color:#f0c24c;
    }
    .task-name{ flex:1; min-width:0; text-align:left;
     overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* ê¸´ ì œëª© ë§ì¤„ì„ */

    .task-date{
     font-size:13px;
     padding:4px 10px;
     border-radius:999px;
     background:#ffffff;         /* ê¸°ë³¸: í°ìƒ‰ ìº¡ìŠ */
     color:#666;
     white-space:nowrap;
     border:1px solid rgba(0,0,0,.05);
    }

    /* ê³¼ê±° ë¯¸ì™„ë£Œ(ë¹¨ê°• ë°°ê²½)ì—ì„œë„ ì½ê¸° ì¢‹ì€ ìƒ‰ê° */
    .task-box.past:not(.done) .task-date{
     background: rgba(255,255,255,.9);
     color:#7a2d2d;
     border-color: transparent;
    }
 
   /* ì˜¤ëŠ˜ í‘œê¸° ì „ìš© ê°•ì¡°(ì›í•˜ë©´ ìœ ì§€/ì‚­ì œ ê°€ëŠ¥) */
    .task-date.is-today{
      background:#2e7d57;
      color:#fff;
      border-color: transparent;
    }

    /* ë‹¬ë ¥ ìŠ¤íƒ€ì¼ */
    .calendar{ display:none; }
    .calendar table{
      width:100%;
      border-collapse:collapse;
      margin-top:14px;
      background:#fff;
      border-radius:14px;
      overflow:hidden;
    }
    .calendar th, .calendar td{
      border:1px solid #ececec;
      width:14.28%;
      height:96px;
      text-align:left;
      vertical-align:top;
      padding:8px;
      font-size:14px;
    }
    .calendar thead th{
      background:#f9fafb;
      text-align:center;
      height:36px;
      padding:6px 0;
      vertical-align:middle;
    }
    .calendar td > strong{ display:block; margin-bottom:6px; }
    .calendar td.weekend > strong,
    .calendar td.holiday > strong,
    .calendar td.vacation > strong{ color:#d33; }
    .calendar td.sun  .day-num,
    .calendar td.sat  .day-num{ color:#d74b4b; }
    .calendar td.holiday .day-num,
    .calendar td.vacation .day-num{ color:#d74b4b; }
    .calendar .task-pill{
      background:#f6c1c1;
      border-radius:10px;
      padding:4px 8px;
      margin-top:6px;
      font-size:12px;
      display:inline-block;
      border:1px solid rgba(0,0,0,.06);
    }
    .calendar .task-pill.done{
      background:#fff;
      border-color:#dfe3e6;
    }
    .calendar .task-pill.exempt{
      background:#E5E7EB;
      color:#374151;
      border-color:#D1D5DB;
    }
    .calendar .event-pill{
      margin-top:6px;
      font-size:12px;
      display:inline-block;
      cursor:pointer;
    }
    .badge-holiday, .badge-vacation{
      display:inline-block;
      margin-left:6px;
      font-size:12px;
      color:#d33;
      font-weight:600;
    }

    /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
    button#logout-btn{
      font-size: 18px;
      padding: 14px 22px;
      cursor: pointer;
      border: 0;
      border-radius: 22px;
      color: #fff;
      background: var(--btn);
      box-shadow: 0 12px 28px var(--btn-shadow);
      font-family:'SUIT',sans-serif;
      margin: 14px auto 0;
      display:block;
    }
    button#logout-btn:hover{ filter:brightness(1.04); }

    /* ë°˜ì‘í˜• */
    @media (max-width:560px){
      .task-box{ width: 96%; margin: 8px 2%; font-size: 17px; }
      #today-date{ font-size: 24px; }
      header{ padding:6px 8px; }
    }

    /* --- ë©´ì œ í‘œì‹œìš© --- */
.tag{
  display:inline-block;
  padding:2px 8px;
  font-size:12px;
  border-radius:999px;
  border:1px solid #e2e5e9;
  background:#fff;
  color:#555;
  margin-right:8px;
}

.tag-exempt{
  background:#f0f3f5;
  border-color:#d9dee3;
  color:#586172;
}

/* ë©´ì œ ì¹´ë“œëŠ” ë¶‰ì€ ê²½ê³  í†¤ ëŒ€ì‹  ì¤‘ë¦½ í†¤ */
.task-box.exempt{
  background:#E5E7EB !important;
  color:#374151 !important;
  border-color:#D1D5DB !important;
  text-decoration:none !important;
}

    /* ë ˆì´ì•„ì›ƒ */
    .content-grid{ display:grid; grid-template-columns:1fr; gap:16px; align-items:start; }
    @media (min-width: 960px){ .content-grid{ grid-template-columns: 2fr 1fr; } }
    #right-col{ display:block; }
    .sec-title{ margin:4px 0 8px; font-weight:700; }


    /* ë„ì „ ì¹´ë“œ */
    #challenges-container{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .challenge-card{ border:1px solid #e5e7eb; border-radius:14px; padding:14px 16px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.04); cursor:pointer; position:relative; overflow:hidden; color:#101828; }
    .challenge-card.not-started{ border-color:#dfe3e8; }
    .challenge-card.in-progress{ border-color:#2e7d57; }
    .challenge-card.done{ border-color:#dcdfe4; opacity:.95; }
    .challenge-card.done .ch-title{ text-decoration:line-through; color:#98a2b3; }
    .challenge-card:hover{ filter:brightness(0.99); }
    .challenge-card:focus-visible{ outline:3px solid rgba(46,125,87,.4); outline-offset:2px; }
    .challenge-card .ch-progress{ position:relative; width:100%; height:14px; border-radius:999px; background:#edf1f4; overflow:hidden; margin-bottom:12px; }
    .challenge-card .ch-progress-fill{ position:absolute; inset:0; width:var(--prog,0%); background:linear-gradient(90deg, #2e7d57, #4bb27d); transition:width .3s ease; }
    .challenge-card .ch-title{ font-weight:700; margin-bottom:6px; }
    .challenge-card .ch-desc{ font-size:14px; color:#475467; margin-bottom:8px; }
    .challenge-card .ch-state{ font-size:13px; color:#344054; }
    .challenge-card .ch-steps{ margin-top:8px; display:none; flex-direction:column; gap:4px; }
    .challenge-card.expanded .ch-steps{ display:flex; }
    .challenge-card .ch-step{ padding:6px 8px; text-align:left; border:1px solid #e5e7eb; border-radius:8px; background:#f9fafb; cursor:pointer; }
    .challenge-card .ch-step.done{ background:#e0f2f1; text-decoration:line-through; color:#2e7d57; }
    
  </style>
</head>
<body class="student-page">

  <!-- ê³µí†µ ìƒë‹¨ë°” -->
  <header class="topbar">
 <div class="logo-area">
      <a href="./"><img src="logo.png" alt="ì˜¤ëŠ˜ í•  ì¼ ë¡œê³ "></a>
    </div>
    <nav class="menu-area" aria-label="ì£¼ìš” ë©”ë‰´">
      <button id="tab-todo" class="active" onclick="showTodo()">ì˜¤ëŠ˜ í•  ì¼</button>
      <button id="tab-calendar" onclick="showCalendar()">ë‹¬ë ¥</button>
    </nav>
    <div class="right-tools"></div>
  </header>

<div class="container" id="task-box" style="display:none;">
  <!-- â–¼â–¼ ì˜¤ëŠ˜ ì¼ì • ìŠ¤íŠ¸ë¦½: ì—¬ê¸° ì¶”ê°€ -->
  <div id="events-strip" class="event-grid"></div>

  <div id="date-nav">
    <button id="prev-day">â—€ ì´ì „ë‚ </button>
    <button id="next-day">ë‹¤ìŒë‚  â–¶</button>
  </div>
    
  <div id="main-content" class="content-grid">
    <section id="left-col">
      <h2 id="today-date"></h2>
      <div id="todo-container"></div>
    </section>
    <aside id="right-col">
      <h3 class="sec-title">ğŸ¯ ì˜¤ëŠ˜ì˜ ë„ì „ <span id="ch-progress-avg"></span></h3>
      <select id="ch-sort" onchange="Challenges.renderChallengesForStudent(currentStudent)" style="margin-bottom:8px;">
        <option value="name">ì´ë¦„ ìˆœ</option>
        <option value="low">ì§„í–‰ë¥  ë‚®ì€ ìˆœ</option>
        <option value="high">ì§„í–‰ë¥  ë†’ì€ ìˆœ</option>
      </select>
      <div id="challenges-container"></div>
    </aside>
  </div>
  <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
</div>

  <div class="container" id="calendar-box" style="display:none;">
  <section class="calendar" style="display:block;">
    <div id="cal-controls" style="display:flex;align-items:center;gap:8px;margin:8px 0 4px;">
      <button type="button" onclick="changeMonth(-1)">â—€</button>
      <div id="cal-label" style="font-weight:600;min-width:120px;text-align:center;"></div>
      <button type="button" onclick="changeMonth(1)">â–¶</button>
      <button type="button" onclick="goToday()" style="margin-left:8px;">ì˜¤ëŠ˜</button>
    </div>
    <table>
      <thead>
        <tr>
          <th class="mon">ì›”</th>
          <th class="tue">í™”</th>
          <th class="wed">ìˆ˜</th>
          <th class="thu">ëª©</th>
          <th class="fri">ê¸ˆ</th>
          <th class="sat">í† </th>
          <th class="sun">ì¼</th>
        </tr>
      </thead>
      <tbody id="calendar-body"></tbody>
    </table>
  </section>
</div>


<script>
  let currentStudent = null;
  let currentDate = new Date();
  let joinDate = '0000-00-00';
  let joinDateObj = new Date(0);

  const taskBox = document.getElementById("task-box");
  const todoContainer = document.getElementById("todo-container");
  const todayDate = document.getElementById("today-date");
  const logoutBtn = document.getElementById("logout-btn");
  const prevDayBtn = document.getElementById("prev-day");
  const nextDayBtn = document.getElementById("next-day");
  const calendarBox = document.getElementById("calendar-box");

  function formatDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function displayDate(d) {
    const month = d.getMonth() + 1;
    const date = d.getDate();
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const day = dayNames[d.getDay()];
    return `${month}ì›” ${date}ì¼ (${day})`;
  }


  /* -------- V2 ì €ì¥ì†Œ -------- */
  // í•™ìƒë„ í•­ìƒ ë™ì¼ ì›ë³¸(tasksV2)ë§Œ ë³´ë„ë¡ í†µì¼
  function getTasks(){
    return getJSON('tasksV2', []);
  }

const pad2 = (n)=> String(n).padStart(2,'0');

  let viewYear  = (new Date()).getFullYear();
let viewMonth = (new Date()).getMonth();

function getVacations(){ return getJSON('vacations', []); }

function setActiveTab(key){
  document.getElementById('tab-todo').classList.toggle('active', key === 'todo');
  document.getElementById('tab-calendar').classList.toggle('active', key === 'calendar');
}

function showTodo(){
  setActiveTab('todo');
  taskBox.style.display = 'block';
  calendarBox.style.display = 'none';
  renderTasks();
}

function showCalendar(){
  setActiveTab('calendar');
  taskBox.style.display = 'none';
  calendarBox.style.display = 'block';
  renderCalendar();
}

function setCalLabel(){
  const label = document.getElementById('cal-label');
  if (label) label.textContent = `${viewYear}ë…„ ${viewMonth+1}ì›”`;
}

function changeMonth(delta){
  viewMonth += delta;
  if (viewMonth < 0){ viewMonth = 11; viewYear--; }
  if (viewMonth > 11){ viewMonth = 0; viewYear++; }
  renderCalendar();
}

function goToday(){
  const t = new Date();
  viewYear  = t.getFullYear();
  viewMonth = t.getMonth();
  renderCalendar();
}

async function renderCalendar(){
  const tbody = document.getElementById('calendar-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  const year = viewYear;
  const month = viewMonth;

  let holidaysMap = {};
  try {
    const hm = await ensureHolidays(year, 'KR');
    holidaysMap = (hm && typeof hm === 'object') ? hm : {};
  } catch(e){
    holidaysMap = {};
  }
  const vacations = getVacations() || [];
  const isVacation = (dateStr) => {
    const v = vacations.find(v => v.start <= dateStr && dateStr <= v.end);
    return v ? v.name : null;
  };

  const firstDay = new Date(year, month, 1);
  const startDay = firstDay.getDay();
  const adjustedStart = (startDay + 6) % 7;
  const lastDate = new Date(year, month + 1, 0).getDate();

  const tasks = getTasks();
  const instancesMap = {};
  const pushInst = (dateStr, t) => {
    const bucket = instancesMap[dateStr] ?? (instancesMap[dateStr] = []);
    bucket.push({
      id: t.id,
      text: t.text,
      type: t.type,
      desc: t.desc || '',
      order: bucket.length
    });
  };
  const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };

  tasks.forEach(t => {
    const assigned = (t.students||['ì „ì²´']).includes('ì „ì²´') || (t.students||[]).includes(currentStudent);
    if (!assigned) return;

    const inRange = (dateStr) => {
      const s = t.repeatStart || t.date || '';
      const e = t.repeatEnd   || '';
      if (s && dateStr < s) return false;
      if (e && dateStr > e) return false;
      return true;
    };

    const rpt = t.repeat || 'none';
    if (rpt === 'daily'){
      for (let d=1; d<=lastDate; d++){
        const ds = `${year}-${pad2(month+1)}-${pad2(d)}`;
        if (!inRange(ds)) continue;
        if (joinDate && ds < joinDate) continue;
        pushInst(ds, t);
      }
    } else if (dayMap[rpt] != null) {
      for (let d=1; d<=lastDate; d++){
        const dateObj = new Date(year, month, d);
        if (dateObj.getDay() === dayMap[rpt]){
          const ds = `${year}-${pad2(month+1)}-${pad2(d)}`;
          if (!inRange(ds)) continue;
          if (joinDate && ds < joinDate) continue;
          pushInst(ds, t);
        }
      }
    } else {
      const d = new Date(t.date);
      if (d.getFullYear() === year && d.getMonth() === month){
        const ds = `${year}-${pad2(month+1)}-${pad2(d.getDate())}`;
        if (!(joinDate && ds < joinDate)) pushInst(ds, t);
      }
    }
  });

  Object.values(instancesMap).forEach(arr => {
    arr.sort((a, b) => {
      const aIsEvent = a.type === 'event';
      const bIsEvent = b.type === 'event';
      if (aIsEvent !== bIsEvent) return aIsEvent ? -1 : 1;
      return (a.order ?? 0) - (b.order ?? 0);
    });
  });

  let html = '<tr>';
  for (let i=0; i<adjustedStart; i++) html += '<td></td>';

  for (let day=1; day<=lastDate; day++){
    const dateStr = `${year}-${pad2(month+1)}-${pad2(day)}`;
    const isSat = ((adjustedStart + day - 1) % 7 === 5);
    const isSun = ((adjustedStart + day - 1) % 7 === 6);
    
    const holName = holidaysMap[dateStr] || null;
    const vacName = isVacation(dateStr);
    const badge = holName
      ? `<span class="badge-holiday">${escapeHTML(holName)}</span>`
      : (vacName ? `<span class="badge-vacation">${escapeHTML(vacName)}</span>` : '');
    
    const cellCls = [];
    if (isSun) cellCls.push('sun');
    if (isSat) cellCls.push('sat');
    if (holName) cellCls.push('holiday');
    if (vacName) cellCls.push('vacation');

    const added = new Set();  // ê°™ì€ id ì¤‘ë³µ ë°©ì§€ìš©

    // ë‚ ì§œì— ë“¤ì–´ê°ˆ ì•„ì´í…œë“¤(ì¼ì •/ê³¼ì œ) ë§Œë“¤ê¸°
    const itemsHTML = (instancesMap[dateStr] || []).map(inst => {
      if (added.has(inst.id)) return '';
      added.add(inst.id);
      if (inst.type === 'event') {
        const title = escapeHTML(inst.text || '(ì œëª© ì—†ìŒ)');
        const desc  = escapeHTML((inst.desc || '').trim() || 'ì„¤ëª… ì—†ìŒ');
        const descAttr = desc.replace(/\r?\n/g, '&#10;');
        return `<div class="event-pill" data-title="${title}" data-desc="${descAttr}">${title}</div>`;
      } else {
        
        // ê³¼ì œ pill (ë©´ì œ/ì™„ë£Œ/ë¯¸ì™„ë£Œ)
        let statusCode = '';
        let postponedTo = null;
        if (typeof getStatusFor === 'function') {
          const st = getStatusFor(currentStudent, inst.id); // {s:'e'|'d'|'p'|'' ...}
          statusCode = st?.s || '';
          postponedTo = st?.du || null;
        }

        // ë¯¸ë£¬ ë‚ ì§œ ì…€ì—ì„œëŠ” 1íšŒë§Œ í‘œì‹œ(ì¤‘ë³µ ë°©ì§€). ì›ë˜ ë‚ ì§œëŠ” ê·¸ëŒ€ë¡œ í‘œì‹œ.
        if (statusCode === 'p' && postponedTo && postponedTo === dateStr) {
          // ê·¸ëŒ€ë¡œ ì§„í–‰(í•œ ë²ˆë§Œ ë Œë”)
        }
        
        const isExempt = statusCode === 'e';
        const done = statusCode === 'd';
        const pillCls = isExempt ? 'task-pill exempt' : (done ? 'task-pill done' : 'task-pill pending');
        const icon    = isExempt ? ' ğŸš«' : '';
        return `<div class="${pillCls}">${escapeHTML(inst.text)}${icon}</div>`;
      }
    }).join('');

    html += `<td class="${cellCls.join(' ')}">
      <strong class="day-num">${day}</strong>
      ${badge}
      ${itemsHTML}
    </td>`;

    if ((adjustedStart + day) % 7 === 0) html += '</tr><tr>';
  }

  html += '</tr>';
  tbody.innerHTML = html;

  tbody.querySelectorAll('.event-pill').forEach(pill => {
    pill.addEventListener('click', () => {
      const title = (pill.dataset.title || '(ì œëª© ì—†ìŒ)').trim();
      const desc = (pill.dataset.desc || '').trim() || 'ì„¤ëª… ì—†ìŒ';
      alert(`ğŸ“£ ${title}\n\n${desc.replace(/\r?\n/g, '\n')}`);
    });
  });
  setCalLabel();
}

  // targetDate í•˜ë£¨ì¹˜ë§Œ ê³„ì‚°. 'ë¯¸ë£¸' ë‚ ì§œë©´ í•œ ë²ˆë§Œ, ì›ë˜/ë°˜ë³µ ë‚ ì§œë„ ê·¸ëŒ€ë¡œ ë³´ì´ê²Œ.
function buildInstancesOn(targetDate){
  const tasks = getTasks();
  const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
  const d0 = normalizeDate(targetDate);
  const y = d0.getFullYear(), m = d0.getMonth()+1, dd = d0.getDate();
  const dateStr = `${y}-${pad2(m)}-${pad2(dd)}`;
  const out = [];

  const inRangeOn = (t) => {
    const s = t.repeatStart || t.date || '';
    const e = t.repeatEnd   || '';
    if (s && dateStr < s) return false;
    if (e && dateStr > e) return false;
    return true;
  };

  const pushOne = (t) => {
    out.push({
      uid: t.id,
      text: t.text,
      date: dateStr,
      dateObj: new Date(d0),
      students: t.students || ['ì „ì²´']
    });
  };

  tasks.forEach(t => {
    if (t.type === 'event' || t.type === 'challenge') return;

    // ëŒ€ìƒ í•™ìƒë§Œ
    const assigned = (t.students||['ì „ì²´']).includes('ì „ì²´') || (t.students||[]).includes(currentStudent);
    if (!assigned) return;

    // ìƒíƒœ ì¡°íšŒ
    const st  = (typeof getStatusFor === 'function') ? getStatusFor(currentStudent, t.id) : null;
    const code = st?.s || '';     // '', 'd', 'p', 'e'
    const du   = st?.du || null;

    let pushedByPostpone = false;

    // â‘  ë¯¸ë£¬ ë‚ ì§œë©´ ì—¬ê¸°ì„œ 1íšŒë§Œ í‘¸ì‹œ(ì¤‘ë³µ ë°©ì§€)
    if (code === 'p' && du === dateStr) {
      pushOne(t);
      pushedByPostpone = true;
    }

    // â‘¡ ì›ë˜/ë°˜ë³µ ë‚ ì§œ íŒë‹¨ (ë¯¸ë£¬ ë‚ ì§œì—ì„œ ì´ë¯¸ ë„£ì—ˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€)
    if (!pushedByPostpone && inRangeOn(t)) {
      const rpt = t.repeat || 'none';
      if (rpt === 'daily') {
        pushOne(t);
      } else if (dayMap[rpt] != null) {
        if (d0.getDay() === dayMap[rpt]) pushOne(t);
      } else {
        if ((t.date || '') === dateStr) pushOne(t);
      }
    }
  });

  // ì•ˆì „ dedup (ê°™ì€ uidê°€ ì‹¤ìˆ˜ë¡œ 2ë²ˆ ë“¤ì–´ì˜¤ë©´ 1ê°œë§Œ)
  const seen = new Set();
  const dedup = out.filter(o => (seen.has(o.uid) ? false : (seen.add(o.uid), true)));

  // ë³´ê¸° ì¢‹ê²Œ ì •ë ¬(ì„ íƒì‚¬í•­)
  dedup.sort((a,b)=> a.text.localeCompare(b.text));

  return dedup;
}


  
  // ê³µí†µ í—¬í¼ ì‚¬ìš©  
  function renderTasks() {
    renderEventsStrip('events-strip', { studentName: currentStudent }); // ì˜¤ëŠ˜ ì¼ì • ë¨¼ì €
    todoContainer.innerHTML = "";
    todayDate.textContent = displayDate(currentDate);
    
    const today0 = normalizeDate(new Date());
    const currDate0 = normalizeDate(currentDate);

    const instances = [];
    const tasks = getTasks();
    let earliest = null;
    tasks.forEach(t => {
      if (t.type === 'event' || t.type === 'challenge') return;
      const assigned = (t.students||['ì „ì²´']).includes('ì „ì²´') || (t.students||[]).includes(currentStudent);
      if (!assigned) return;
      const ds = t.date || t.repeatStart || null;
      if (!ds) return;
      if (!earliest || ds < earliest) earliest = ds;
    });
    const start = earliest ? new Date(earliest) : new Date(currentDate);
    start.setHours(0,0,0,0);
    for (let d = new Date(start); d <= currentDate; d.setDate(d.getDate() + 1)) {
      const list = buildInstancesOn(d);
      list.forEach(inst => {
        const st = (typeof getStatusFor === 'function') ? getStatusFor(currentStudent, inst.uid) : null;
        const statusCode = st?.s || '';
        if (statusCode === '') instances.push(inst);
      });
    }

    instances.sort((a,b)=> a.dateObj - b.dateObj || a.text.localeCompare(b.text));

    instances.forEach(inst=>{
      const isPast = inst.dateObj < today0;

      const box = document.createElement('div');
      box.className = "task-box";
      
      const isToday = inst.dateObj.getTime() === currDate0.getTime();
      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const labelText = isToday
          ? 'ì˜¤ëŠ˜'
          : `${inst.dateObj.getMonth()+1}ì›” ${inst.dateObj.getDate()}ì¼ (${dayNames[inst.dateObj.getDay()]})`;
     
      box.innerHTML = `
      <span class="task-name">${escapeHTML(inst.text)}</span>
        <span class="task-date${isToday ? ' is-today' : ''}">${labelText}</span>
      `;
      
      if (isPast) {
        box.style.backgroundColor = "#f05555";
        box.style.color = "#fff";
        box.classList.add('past');
      } else {
        box.style.backgroundColor = "#f6c1c1";
        box.style.color = "#000";

     }

      box.onclick = () => {
        setDone(currentStudent, inst.uid, true);
        renderTasks();
      };
      
      todoContainer.appendChild(box);
    });

    if (todoContainer.children.length === 0) {
      const p = document.createElement('p');
      p.style.color = '#667085';
      p.style.textAlign = 'center';
      p.textContent = 'í‘œì‹œí•  í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.';
      todoContainer.appendChild(p);
  }

    Challenges.renderChallengesForStudent(currentStudent);

  }
  prevDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() - 1);
    renderTasks();
  };

  nextDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() + 1);
    renderTasks();
  };

  window.onload = () => {
    if (typeof migrateToUIDOnce === 'function') migrateToUIDOnce();
    const savedStudent = localStorage.getItem('currentStudent');
    if (savedStudent) {
      currentStudent = savedStudent;
      const stu = (loadStudents() || []).find(s => s.name === currentStudent) || null;
      joinDate = stu?.joined || '0000-00-00';
      joinDateObj = stu?.joined ? new Date(stu.joined) : new Date(0);
      joinDateObj.setHours(0,0,0,0);
      showTodo();
    } else {
      location.href = "index.html";
    }
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem('currentStudent');
    location.href = "index.html";
  };
  
</script>

  <!-- Supabase CDN -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;
  const SUPABASE_URL = "https://ytouzrchngqyuqafziad.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_WUrSn1U6sszhHrpEPOXwCA_ZQoJo6nW";
  window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

</body>

</html>