<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ í•  ì¼ (í•™ìƒìš©)</title>

  <!-- í°íŠ¸: ì œëª©=Jua, ë³¸ë¬¸/ë²„íŠ¼=SUIT -->
  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css">
  
  <!-- ê³µí†µ -->
  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js" defer></script>

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --btn:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);
      --chip:#ffffff;
    }

    *{box-sizing:border-box}

    /* êµ¬ë¦„ ë°°ê²½ */
    html,body{height:100%}
    body{
      margin:0;
      padding-top: 96px;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      position:relative;
      
      max-width:760px;
      margin:0 auto;
      text-align:center;
      padding-left:0;
      padding-right:0;
    }
    body::before{
      content:"";
      position:fixed; inset:0; z-index:-1; opacity:.9; pointer-events:none;
      background:
        radial-gradient(200px 80px at 16% 30%, #fff 60%, transparent 61%),
        radial-gradient(150px 60px at 27% 26%, #fff 60%, transparent 61%),
        radial-gradient(180px 70px at 77% 28%, #fff 60%, transparent 61%),
        radial-gradient(140px 60px at 88% 35%, #fff 60%, transparent 61%),
        radial-gradient(120px 50px at 12% 52%, #fff 60%, transparent 61%),
        radial-gradient(110px 45px at 92% 56%, #fff 60%, transparent 61%);
    }
    
    /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ì¹´ë“œ */
    #task-box{
      border: 1px solid var(--card-line);
      background: var(--card);
      padding: 28px 24px;
      border-radius: 26px;
      margin: 0 16px 40px;
      box-shadow: 0 16px 40px rgba(0,0,0,.10);
    }

    /* ë‚ ì§œ/ì œëª© */
    #today-date{
      margin: 10px 0 18px;
      font-family:'Jua',sans-serif;  /* ì œëª© ì„œì²´ */
      font-weight: 400;
      font-size: 28px;
      letter-spacing:-.2px;
    }

    /* ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
    #date-nav{ margin-bottom: 8px; }
    #date-nav button{
      margin: 0 8px;
      padding: 10px 14px;
      cursor: pointer;
      border-radius: 999px;
      border:1px solid var(--card-line);
      background:#fff;
      font: inherit;
      box-shadow: 0 6px 14px rgba(0,0,0,.06);
    }
    #date-nav button:hover{ filter:brightness(0.98); }

    /* í•  ì¼ ë°•ìŠ¤ë“¤ (JSê°€ ë°°ê²½ìƒ‰ì„ ë”°ë¡œ ì§€ì •í•´ë„ í…Œë‘ë¦¬/ëª¨ì–‘ì€ ìœ ì§€) */
    .task-box{
     width: 46%;
     display: inline-flex;              /* â† inline-block â†’ inline-flex ë¡œ ë³€ê²½ */
     justify-content: space-between;    /* ì¢Œìš° ë°°ì¹˜ */
     align-items: center;
     gap: 12px;                         /* ì´ë¦„ê³¼ ë‚ ì§œ ê°„ê²© */
     border: 2px solid #dcdfe4;
     padding: 16px 14px;
     border-radius: 20px;
     font-size: 18px;
     cursor: pointer;
     user-select: none;
     box-shadow: 0 2px 0 rgba(0,0,0,.02) inset, 0 4px 10px rgba(0,0,0,.05);
    }
    .task-name{ flex:1; min-width:0; text-align:left; 
     overflow:hidden; text-overflow:ellipsis; white-space:nowrap; } /* ê¸´ ì œëª© ë§ì¤„ì„ */


    .task-date{
     font-size:13px;
     padding:4px 10px;
     border-radius:999px;
     background:#ffffff;         /* ê¸°ë³¸: í°ìƒ‰ ìº¡ìŠ */
     color:#666;
     white-space:nowrap;
     border:1px solid rgba(0,0,0,.05);
    }
    
    .task-box.done{
      background: transparent !important;
      color: #9aa6b2 !important;
      border-color: #dcdfe4 !important;
      text-decoration: line-through;
    }

    /* ê³¼ê±° ë¯¸ì™„ë£Œ(ë¹¨ê°• ë°°ê²½)ì—ì„œë„ ì½ê¸° ì¢‹ì€ ìƒ‰ê° */
    .task-box.past:not(.done) .task-date{
     background: rgba(255,255,255,.9);
     color:#7a2d2d;
     border-color: transparent;
    }
 
   /* ì˜¤ëŠ˜ í‘œê¸° ì „ìš© ê°•ì¡°(ì›í•˜ë©´ ìœ ì§€/ì‚­ì œ ê°€ëŠ¥) */
   .task-date.is-today{
    background:#2e7d57;
    color:#fff;
    border-color: transparent;
   }

    /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
    button#logout-btn{
      font-size: 18px;
      padding: 14px 22px;
      cursor: pointer;
      border: 0;
      border-radius: 22px;
      color: #fff;
      background: var(--btn);
      box-shadow: 0 12px 28px var(--btn-shadow);
      font-family:'SUIT',sans-serif;
      margin-top: 14px;
    }
    button#logout-btn:hover{ filter:brightness(1.04); }

    /* ë°˜ì‘í˜• */
    @media (max-width:560px){
      .task-box{ width: 96%; margin: 8px 2%; font-size: 17px; }
      #today-date{ font-size: 24px; }
      header{ padding:6px 8px; }
    }
    
    /* ì¼ì • ë²„íŠ¼(í•™ìƒ í™”ë©´) */
    .event-link{
      all:unset;
      cursor:pointer;
      color:#111;
      text-decoration:underline;
    }
    .event-link:hover{ opacity:.8; }
    
  </style>
</head>
<body>

  <!-- ê³µí†µ ìƒë‹¨ë°” -->
  <header class="topbar">
  <div class="logo-area">
    <a href="./"><img src="logo.png" alt="ì˜¤ëŠ˜ í•  ì¼ ë¡œê³ "></a>
  </div>
   <div class="right-tools"></div>
</header>

<div id="task-box" style="display:none;">
  <div id="date-nav">
    <button id="prev-day">â—€ ì´ì „ë‚ </button>
    <button id="next-day">ë‹¤ìŒë‚  â–¶</button>
  </div>
  <h2 id="today-date"></h2>
  <div id="todo-container"></div>
  <button id="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
</div>

<script>
  let currentStudent = null;
  let currentDate = new Date();

  const taskBox = document.getElementById("task-box");
  const todoContainer = document.getElementById("todo-container");
  const todayDate = document.getElementById("today-date");
  const logoutBtn = document.getElementById("logout-btn");
  const prevDayBtn = document.getElementById("prev-day");
  const nextDayBtn = document.getElementById("next-day");

  function loadStudents() {
    const raw = localStorage.getItem("students");
    return raw ? JSON.parse(raw) : [];
  }

  function formatDate(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function displayDate(d) {
    const month = d.getMonth() + 1;
    const date = d.getDate();
    const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const day = dayNames[d.getDay()];
    return `${month}ì›” ${date}ì¼ (${day})`;
  }


  /* -------- V2 ì €ì¥ì†Œ -------- */
  // teacherê°€ teacherTasksV2 í‚¤ë¡œ ì €ì¥ ì¤‘ì´ë©´ ê·¸ê±¸ ìš°ì„ , ì—†ìœ¼ë©´ tasksV2ë¥¼ ì½ìŒ
    function getTasks(){
    return getJSON('teacherTasksV2', null) || getJSON('tasksV2', []);
  }
  // UID ê¸°ë°˜ ì™„ë£Œ ì €ì¥ì†Œ
  function getDoneStore(name){ return getJSON('doneTasks-'+name, {}) || {}; }
  function setDoneStore(name, obj){ setJSON('doneTasks-'+name, obj || {}); }

  // UID ê¸°ë°˜ ì™„ë£Œ ì²´í¬/ì €ì¥
  function isDone(name, uid){
    const s = getDoneStore(name);
    return s[uid] === true;
  }
  function setDone(name, uid, done){
    const s = getDoneStore(name);
    if (done) s[uid] = true; else delete s[uid];
    setDoneStore(name, s);
  }



const pad2 = (n)=> String(n).padStart(2,'0');

function buildInstancesUpTo(dateLimit /* Date */){
  const tasks = getTasks();  // [{id,type,date,text,repeat,repeatStart,repeatEnd,students}]
  const limit0 = normalizeDate(dateLimit);
  const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
  const out = [];

  const push = (t, dObj) => {
    const y=dObj.getFullYear(), m=dObj.getMonth()+1, dd=dObj.getDate();
    out.push({
      uid: t.id,
      text: t.text,
      date: `${y}-${pad2(m)}-${pad2(dd)}`,
      dateObj: new Date(dObj),
      students: t.students || ['ì „ì²´']
    });
  };

  tasks.forEach(t=>{
    if (t.type === 'event' || t.type === 'challenge') return;

    const base = normalizeDate(t.repeatStart || t.date);
    const end  = t.repeatEnd ? normalizeDate(t.repeatEnd) : limit0;
    const rpt  = t.repeat || 'none';

    if (rpt === 'daily'){
      for (let cur=new Date(base); cur<=limit0 && cur<=end; cur.setDate(cur.getDate()+1)){
        push(t, cur);
      }
    } else if (dayMap[rpt] != null){
      const targetDow = dayMap[rpt];
      const cur = new Date(base);
      while (cur.getDay() !== targetDow) cur.setDate(cur.getDate()+1);
      for (; cur<=limit0 && cur<=end; cur.setDate(cur.getDate()+7)){
        push(t, cur);
      }
    } else {
      if (!isNaN(base) && base <= limit0) push(t, base);
    }
  });

  out.sort((a,b)=> b.dateObj - a.dateObj); // ìµœê·¼ì¼ ìš°ì„ 
  return out;
}




  
  
  // ê³µí†µ í—¬í¼ ì‚¬ìš©  
  function renderTasks() {
    todoContainer.innerHTML = "";
    function occursOn(t, dateObj) {
      const d0 = new Date(dateObj); d0.setHours(0,0,0,0);
      const y=d0.getFullYear(), m=d0.getMonth()+1, dd=d0.getDate();
      const dateStr = `${y}-${String(m).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;

      const s = t.repeatStart || t.date || "";
      const e = t.repeatEnd   || "";

      const inRange = (ds) => {
        if (s && ds < s) return false;
        if (e && ds > e) return false;
        return true;
      };

      const rpt = t.repeat || 'none';
      if (rpt === 'daily') return inRange(dateStr);

      const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
      if (dayMap[rpt] != null) {
        if (!inRange(dateStr)) return false;
        return d0.getDay() === dayMap[rpt];
      }
      if (!t.date) return false;
      const base = new Date(t.date); base.setHours(0,0,0,0);
      return base.getTime() === d0.getTime();
    }

    function renderEventsForDay() {
      const show = localStorage.getItem('showEvents');
      if (show === '0' || show === 'false' || show === 'no') return false;
      const all = getTasks(); // common.jsì˜ V2
      const list = all
        .filter(t => t.type === 'event' && occursOn(t, currentDate))
        .filter(t => (t.students||['ì „ì²´']).includes('ì „ì²´') || (t.students||[]).includes(currentStudent));

      if (!list.length) return false;

      // ê³¼ì œì™€ êµ¬ë¶„ì„  (ê³¼ì œê°€ ì´ë¯¸ ìˆìœ¼ë©´)
      if (todoContainer.children.length > 0) {
        const hr = document.createElement('hr');
        hr.style.cssText = 'border:none;border-top:1px solid #e2e5e9;margin:10px 0 12px;';
        todoContainer.appendChild(hr);
      }


      // ì„¹ì…˜ íƒ€ì´í‹€
      const h = document.createElement('h3');
      h.textContent = 'ğŸ“£ ì˜¤ëŠ˜ì˜ ì¼ì •';
      h.style.cssText = 'text-align:left;margin:6px 0 4px;';
      todoContainer.appendChild(h);

      // ê¸€ì”¨ë§Œ(ë°°ê²½ ì—†ìŒ) ë§í¬ í˜•íƒœ
      const ul = document.createElement('ul');
      ul.style.cssText = 'list-style:none;padding:0;margin:0 0 8px 0;';
      list.forEach(t=>{
        const li = document.createElement('li');
        li.style.cssText = 'text-align:left;margin:4px 0;';
        li.innerHTML = `<button type="button" class="event-link">${escapeHTML(t.text)}</button>`;
        li.querySelector('button').onclick = () => {
          const msg = (t.desc && t.desc.trim()) ? t.desc.trim() : 'ì„¤ëª… ì—†ìŒ';
          alert(`ğŸ“£ ${t.text}\n\n${msg}`);
        };
        ul.appendChild(li);
      });
      todoContainer.appendChild(ul);

    
      return true;
    }

    const today0 = normalizeDate(new Date());
    const currDate0 = normalizeDate(currentDate);
    todayDate.textContent = displayDate(currentDate);

    const instances = buildInstancesUpTo(currentDate); // currentDateê¹Œì§€ì˜ ì¸ìŠ¤í„´ìŠ¤
    const allTasks  = getTasks();                      // ëŒ€ìƒ í•„í„°ìš©

    instances.forEach(inst=>{
      const t = allTasks.find(x=> x.id === inst.uid);
      if (!t) return;

      // ëŒ€ìƒ í•™ìƒ í•„í„°
      const assigned = (t.students||['ì „ì²´']).includes('ì „ì²´') || (t.students||[]).includes(currentStudent);
      if (!assigned) return;

      const done = isDone(currentStudent, inst.uid);
      const isPast = inst.dateObj < today0;

      // ê³¼ê±° + ì™„ë£ŒëŠ” ìˆ¨ê¹€
      if (done && isPast) return;

      const box = document.createElement('div');
      box.className = "task-box" + (done ? " done" : "");

      // ë‚ ì§œ ë¼ë²¨
      const isToday = inst.dateObj.getTime() === currDate0.getTime();
      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      const labelText = isToday
        ? 'ì˜¤ëŠ˜'
        : `${inst.dateObj.getMonth()+1}ì›” ${inst.dateObj.getDate()}ì¼ (${dayNames[inst.dateObj.getDay()]})`;

       box.innerHTML = `
        <span class="task-name">${escapeHTML(inst.text)}</span>
        <span class="task-date${isToday ? ' is-today' : ''}">${labelText}</span>
      `;


       // ì‹œê° íš¨ê³¼
      if (done) {
        box.style.backgroundColor = "transparent";
        box.style.color = "#9aa6b2";
      } else if (isPast) {
        box.style.backgroundColor = "#f05555";
        box.style.color = "#fff";
        box.classList.add('past');
      } else {
        box.style.backgroundColor = "#f6c1c1";
        box.style.color = "#000";
      }

      

      // í´ë¦­ í† ê¸€ (UID ì €ì¥)
      box.onclick = () => {
        setDone(currentStudent, inst.uid, !done);
        renderTasks();
      };


         todoContainer.appendChild(box);
    });
  }

  // â‹ ì˜¤ëŠ˜ ì¼ì • í‘œì‹œ (êµì‚¬ ì„¤ì • ë™ê¸°í™”)
    renderEventsForDay();

  prevDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() - 1);
    renderTasks();
  };

  nextDayBtn.onclick = () => {
    currentDate.setDate(currentDate.getDate() + 1);
    renderTasks();
  };

  window.onload = () => {
    const savedStudent = localStorage.getItem('currentStudent');
    if (savedStudent) {
      currentStudent = savedStudent;
      taskBox.style.display = "block";
      renderTasks();
    } else {
      location.href = "index.html";
    }
  };

  logoutBtn.onclick = () => {
    localStorage.removeItem('currentStudent');
    location.href = "index.html";
  };



  
</script>
</body>
</html>
