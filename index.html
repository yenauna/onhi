<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오늘 할 일 - 조회용</title>

  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css" />

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --brand:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);

      --accent:#4caf7d; /* 활성 버튼용 */
    }
    *{ box-sizing:border-box }
    html, body { height:100% }

    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      padding:96px 16px 24px;  /* 상단바 공간 */
    }
    .topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:#fff; z-index:1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .topbar .logo{ display:flex; align-items:center; gap:10px; }
    .topbar .logo img{
      height:44px; width:auto;          /* ⬅️ 직사각형 로고 대응 */
      object-fit:contain; display:block; /* 비율 유지 */
    }
    .topbar .menu{ display:flex; gap:8px; }
    .topbar .menu button{
      border:1px solid #dcdfe4; background:#fff; color:#1f2a33;
      border-radius:999px; padding:8px 14px; font-size:14px; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.18s;
    }
    .topbar .menu button:hover{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .topbar .menu button.active{
      background:var(--accent); color:#fff; border-color:var(--accent);
      box-shadow:0 8px 18px var(--btn-shadow);
    }

    .container{
      max-width:1100px; margin:0 auto;
      background:var(--card); border:1px solid var(--card-line);
      border-radius:26px; box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:20px;
    }

    .header-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    h1{
      margin:0; font-family:'Jua',sans-serif; font-weight:400; letter-spacing:-.2px;
      font-size:28px;
    }
    .mode-pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--card-line); background:#fff;
      color:#566574;
    }

    /* 학생 카드 그리드 */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:10px;
    }
    .card{
      background:#fff; border:1px solid #e6e8eb; border-radius:16px;
      padding:12px; box-shadow:0 4px 10px rgba(0,0,0,.04);
    }
    .card .title{ font-weight:600; margin-bottom:8px; }

    .chip{
      border:1px solid #e6e8eb; border-radius:12px; padding:8px;
      display:flex; justify-content:space-between; align-items:center;
      margin:6px 0; user-select:none;
    }
    /* 상태색: 오늘 미완료(연한), 지난 미완료(강조) */
    .chip.missed-today { background:#f6c1c1; }
    .chip.missed-past  { background:#c0392b; color:#fff; border-color:#b23326; }
    .chip.done { display:none; } /* 완료는 아예 숨김(오늘 완료도 숨김) */

    .date { font-size:10px; opacity:.9; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo" onclick="location.href='index.html'" style="cursor:pointer">
      <img src="logo.png" alt="오늘 할 일 로고" />
    </div>
    <nav class="menu" aria-label="주요 메뉴">
      <button class="active" type="button">조회용</button>
      <button type="button" onclick="location.href='login.html'">학생용</button>
      <button type="button" onclick="location.href='teacher.html'">교사용</button>
    </nav>
  </header>

  <main class="container">
    <div class="header-row">
      <h1>학생 전체 미완료 과제</h1>
      <span class="mode-pill" id="mode-pill">보기 전용</span>
    </div>
    <div class="grid" id="board"></div>
  </main>

  <script>
    // =============== 공통 스토리지 헬퍼 ===============
    function loadStudents() {
      try {
        const raw = localStorage.getItem("students");
        return raw ? JSON.parse(raw) : [];
      } catch { return []; }
    }
    function _toNum(v){ const n = parseInt(String(v),10); return isNaN(n)?0:n; }
    function sortStudents(arr){
      return (arr||[]).slice().sort((a,b)=>{
        const an=_toNum(a.id), bn=_toNum(b.id);
        const ag = an>50?1:0, bg = bn>50?1:0; if(ag!==bg) return ag-bg; return an-bn;
      });
    }
    function getDoneStore(name){
      try{ return JSON.parse(localStorage.getItem("doneTasks-"+name)||"{}"); }catch{ return {}; }
    }
    function makeDoneKey(dateStr, taskText){ return `${dateStr}@@${taskText}`; }
    function isDone(name,dateStr,taskText){
      const s=getDoneStore(name); const k=makeDoneKey(dateStr,taskText);
      return s[k]===true || s[taskText]===true; // 레거시 허용
    }
    function setDone(name,dateStr,taskText,done){
      const s=getDoneStore(name); const k=makeDoneKey(dateStr,taskText);
      if(done) s[k]=true; else delete s[k];
      localStorage.setItem("doneTasks-"+name, JSON.stringify(s));
    }

    // =============== 과제 로드 ===============
    function loadAllAssignments(){
      const list=[];
      for(let i=0;i<localStorage.length;i++){
        const key=localStorage.key(i);
        if(!key.startsWith("teacherTasks-")) continue;
        try{
          const data=JSON.parse(localStorage.getItem(key));
          list.push({ key, date: key.replace("teacherTasks-",""), ...data });
        }catch{}
      }
      return list;
    }

    // =============== 보드 렌더 ===============
    function renderBoard(){
      const board = document.getElementById('board');
      board.innerHTML = '';

      const mode = localStorage.getItem('boardMode') || 'view'; // 'view' | 'edit'
      document.getElementById('mode-pill').textContent = (mode==='edit'?'편집 전용':'보기 전용');

      const students = sortStudents(loadStudents());
      const assigns  = loadAllAssignments();

      // 오늘과 과거만(미래 제외)
      const today = new Date(); today.setHours(0,0,0,0);

      const dayNames = ['일','월','화','수','목','금','토'];
      const filtered = assigns
        .map(a => {
          const d=new Date(a.date); if(isNaN(d)) return null;
          d.setHours(0,0,0,0);
          return { ...a, dateObj:d, formatted:`${d.getMonth()+1}월 ${d.getDate()}일 (${dayNames[d.getDay()]})` };
        })
        .filter(a => a && a.dateObj <= today)
        .sort((a,b)=> b.dateObj - a.dateObj); // 최근 먼저

      students.forEach(stu=>{
        const card = document.createElement('div');
        card.className='card';
        const title = document.createElement('div');
        title.className='title';
        title.textContent = `${stu.id} ${stu.name}`;
        card.appendChild(title);

        let any = false;

        filtered.forEach(assign=>{
          const isTarget = (assign.students||[]).includes('전체') || (assign.students||[]).includes(stu.name);
          if(!isTarget) return;

          (assign.tasks||[]).forEach(task=>{
            const done = isDone(stu.name, assign.date, task);
            const isPast = assign.dateObj < today;

            // 완료 과제는 숨김(오늘 완료 포함)
            if (done) return;

            any = true;
            const chip = document.createElement('div');
            chip.className = 'chip ' + (isPast ? 'missed-past' : 'missed-today');
            chip.dataset.student = stu.name;
            chip.dataset.date = assign.date;
            chip.dataset.task = task;
            chip.innerHTML = `
              <span>${task}</span>
              <span class="date">${assign.formatted}</span>
            `;

            // 편집모드일 때만 클릭 토글 허용
            if (mode === 'edit') {
              chip.style.cursor='pointer';
              chip.addEventListener('click', ()=>{
                setDone(stu.name, assign.date, task, true); // 체크 → 완료로 기록
                chip.remove(); // 즉시 화면에서 제거
              });
            }
            card.appendChild(chip);
          });
        });

        if (!any){
          // 미완료 없으면 비워두되, 자리 유지 위해 안내 1줄
          const none = document.createElement('div');
          none.style.color='#8a97a6'; none.style.fontSize='13px'; none.style.marginTop='4px';
          none.textContent='미완료 과제 없음';
          card.appendChild(none);
        }

        board.appendChild(card);
      });
    }

    window.addEventListener('load', renderBoard);
  </script>
</body>
</html>
