<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오늘 할 일 - 전체확인</title>

  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css" />

  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js" defer></script>

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --brand:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);

      --accent:#4caf7d; /* 활성 버튼용 */
    }
    *{ box-sizing:border-box }
    html, body { height:100% }

    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      padding:96px 16px 24px;  /* 상단바 공간 */
    }
    .topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:#fff; z-index:1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .topbar .logo{ display:flex; align-items:center; gap:10px; }
    .topbar .logo img{
      height:44px; width:auto;          /* ⬅️ 직사각형 로고 대응 */
      object-fit:contain; display:block; /* 비율 유지 */
    }
    .topbar .menu{ display:flex; gap:8px; }
    .topbar .menu button{
      border:1px solid #dcdfe4; background:#fff; color:#1f2a33;
      border-radius:999px; padding:8px 14px; font-size:14px; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.18s;
    }
    .topbar .menu button:hover{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .topbar .menu button.active{
      background:var(--accent); color:#fff; border-color:var(--accent);
      box-shadow:0 8px 18px var(--btn-shadow);
    }

    .container{
      max-width:1100px; margin:0 auto;
      background:var(--card); border:1px solid var(--card-line);
      border-radius:26px; box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:20px;
    }

    .header-row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px;
    }
    h1{
      margin:0; font-family:'Jua',sans-serif; font-weight:400; letter-spacing:-.2px;
      font-size:28px;
    }
    .mode-pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--card-line); background:#fff;
      color:#566574;
    }

    /* 학생 카드 그리드 */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:10px;
    }
    .card{
      background:#fff; border:1px solid #e6e8eb; border-radius:16px;
      padding:12px; box-shadow:0 4px 10px rgba(0,0,0,.04);
    }
    .card .title{ font-weight:600; margin-bottom:8px; }

    .chip{
      border:1px solid #e6e8eb; border-radius:12px; padding:8px;
      display:flex; justify-content:space-between; align-items:center;
      margin:6px 0; user-select:none;
    }
    /* 상태색: 오늘 미완료(연한), 지난 미완료(강조) */
    .chip.missed-today { background:#f6c1c1; }
    .chip.missed-past  { background:#c0392b; color:#fff; border-color:#b23326; }
    .chip.done { display:none; } /* 완료는 아예 숨김(오늘 완료도 숨김) */

    .date { font-size:10px; opacity:.9; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo" onclick="location.href='index.html'" style="cursor:pointer">
      <img src="logo.png" alt="오늘 할 일 로고" />
    </div>
    <nav class="menu" aria-label="주요 메뉴">
      <button class="active" type="button">전체확인</button>
      <button type="button" onclick="location.href='login.html'">학생</button>
      <button type="button" onclick="location.href='teacher.html'">선생님</button>
    </nav>
  </header>

  <main class="container">
    <div class="header-row">
      <span class="mode-pill" id="mode-pill">보기 전용</span>
    </div>
    <div class="grid" id="board"></div>
  </main>

  <script>
    
    // ==== common.js 폴백(없을 때만 정의) ====
    (function(){ 
      if (typeof getJSON !== 'function') {
        window.getJSON = function(k, fb=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch{ return fb; } };
      }
      if (typeof setJSON !== 'function') {
        window.setJSON = function(k, v){ localStorage.setItem(k, JSON.stringify(v)); };
      }
      if (typeof escapeHTML !== 'function') {
        window.escapeHTML = function(s){ return String(s)
          .replace(/&/g,'&amp;').replace(/</g,'&lt;')
          .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); };
      }
      if (typeof normalizeDate !== 'function') {
        window.normalizeDate = function(d){
          const t = new Date(d); // 'YYYY-MM-DD' 문자열도 OK
          t.setHours(0,0,0,0);
          return t;
        };
      }
      if (typeof loadAllTeacherTasks !== 'function') {
        window.loadAllTeacherTasks = function(){
          const res = [];
          for (let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if (!key.startsWith('teacherTasks-')) continue;
            try{
              const data = JSON.parse(localStorage.getItem(key));
              res.push({ key, dateKey: key.slice('teacherTasks-'.length), data });
            }catch{}
          }
          return res;
        };
      }
    })();
    
    // =============== 공통 스토리지 헬퍼 ===============
    function loadStudents() {
      return getJSON("students", []);
    }
    function _toNum(v){ const n = parseInt(String(v),10); return isNaN(n)?0:n; }
    function sortStudents(arr){
      return (arr||[]).slice().sort((a,b)=>{
        const an=_toNum(a.id), bn=_toNum(b.id);
        const ag = an>50?1:0, bg = bn>50?1:0; if(ag!==bg) return ag-bg; return an-bn;
      });
    }
    function getDoneStore(name){
      return getJSON("doneTasks-" + name, {});
    }
    function makeDoneKey(dateStr, taskText){ return `${dateStr}@@${taskText}`; }
    function isDone(name,dateStr,taskText){
      const s=getDoneStore(name); const k=makeDoneKey(dateStr,taskText);
      return s[k]===true || s[taskText]===true; // 레거시 허용
    }
    function setDone(name, dateStr, taskText, done){
      const k = `${dateStr}@@${taskText}`;
      const store = getDoneStore(name);
      if (done) store[k] = true; else delete store[k];
      setJSON("doneTasks-" + name, store);
    }

    // =============== 과제 로드 ===============
    function loadAllAssignments(){
      // 공통: teacherTasks-* 전부 읽기
      const originals = loadAllTeacherTasks();
      // 전체확인에서 쓰는 필드만 추려서 반환
      return originals.map(({ key, dateKey, data }) => ({
        key,
        date: dateKey,
        students: data?.students || [],
        tasks: data?.tasks || []
      }));
    }

    // =============== 보드 렌더 ===============
    function renderBoard(){
      const board = document.getElementById('board');
      board.innerHTML = '';

      const mode = localStorage.getItem('boardMode') || 'view'; // 'view' | 'edit'
      document.getElementById('mode-pill').textContent = (mode==='edit'?'편집 전용':'보기 전용');

      const students = sortStudents(loadStudents());
      const assigns  = loadAllAssignments();

      // 오늘과 과거만(미래 제외)
      const today = normalizeDate(new Date());

      const dayNames = ['일','월','화','수','목','금','토'];
      const filtered = assigns
        .map(a => {
          const d = normalizeDate(a.date);
          return { 
            ...a, 
            dateObj: d, 
            formatted: `${d.getMonth()+1}월 ${d.getDate()}일 (${dayNames[d.getDay()]})`
          };
        })
        .filter(a => a && a.dateObj <= today)
        .sort((a,b)=> b.dateObj - a.dateObj);

      students.forEach(stu=>{
        const card = document.createElement('div');
        card.className='card';
        const title = document.createElement('div');
        title.className='title';
        title.textContent = `${stu.id} ${stu.name}`;
        card.appendChild(title);

        let any = false;

        filtered.forEach(assign=>{
          const isTarget = (assign.students||[]).includes('전체') || (assign.students||[]).includes(stu.name);
          if(!isTarget) return;

          (assign.tasks||[]).forEach(task=>{
            const done = isDone(stu.name, assign.date, task);
            const isPast = assign.dateObj < today;

            // 완료 과제는 숨김(오늘 완료 포함)
            if (done) return;

            any = true;
            const chip = document.createElement('div');
            chip.className = 'chip ' + (isPast ? 'missed-past' : 'missed-today');
            chip.dataset.student = stu.name;
            chip.dataset.date = assign.date;
            chip.dataset.task = task;
            chip.innerHTML = `
              <span>${escapeHTML(task)}</span>
              <span class="date">${assign.formatted}</span>
            `;

            // 편집모드일 때만 클릭 토글 허용
            if (mode === 'edit') {
              chip.style.cursor='pointer';
              chip.addEventListener('click', ()=>{
                setDone(stu.name, assign.date, task, true); // 체크 → 완료로 기록
                chip.remove(); // 즉시 화면에서 제거
              });
            }
            card.appendChild(chip);
          });
        });

        if (!any){
          // 미완료 없으면 비워두되, 자리 유지 위해 안내 1줄
          const none = document.createElement('div');
          none.style.color='#8a97a6'; none.style.fontSize='13px'; none.style.marginTop='4px';
          none.textContent='끝';
          card.appendChild(none);
        }

        board.appendChild(card);
      });
    }

    window.addEventListener('load', renderBoard);

    /* ===== 세션 유틸 ===== */
function clearSession(){
  localStorage.removeItem('currentStudent');
  localStorage.removeItem('sessionExpireAt');
}
function setSession(name){
  localStorage.setItem('currentStudent', name);
  localStorage.setItem('sessionExpireAt', String(Date.now() + 8*60*60*1000)); // 8시간
}
function isSessionValid(){
  const exp = parseInt(localStorage.getItem('sessionExpireAt')||'0', 10);
  return exp && Date.now() < exp;
}
(function checkExpireSilently(){
  if (!isSessionValid()) clearSession(); // 조용히 만료 처리(알림 없음)
})();

/* ===== 패널 DOM 생성/제거 ===== */
function openLoginPanel(studentName){
  const container = document.querySelector('.container');
  if (!container) return;

  // 이미 열려 있으면 교체만
  closeLoginPanel();

  const dim = document.createElement('div');
  dim.className = 'login-dim';
  dim.addEventListener('click', closeLoginPanel);

  const panel = document.createElement('div');
  panel.className = 'login-panel';
  panel.setAttribute('role','dialog');
  panel.setAttribute('aria-modal','true');

  panel.innerHTML = `
    <header>
      <div>학생 로그인</div>
      <button class="close" aria-label="닫기">✕</button>
    </header>
    <div class="desc">선택한 학생의 비밀번호를 입력하세요.</div>
    <input id="lpw" type="password" placeholder="비밀번호" autocomplete="current-password" />
    <div class="error" id="lerr"></div>
    <div class="btns">
      <button class="cancel">취소</button>
      <button class="ok">확인</button>
    </div>
  `;

  // 카드 하이라이트 전환(선택 안내는 색만)
  highlightSelectedCard(studentName);

  // 핸들러
  panel.querySelector('.close').onclick  = closeLoginPanel;
  panel.querySelector('.cancel').onclick = closeLoginPanel;
  panel.querySelector('.ok').onclick     = () => submitLogin(studentName);
  panel.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closeLoginPanel();
    if (e.key === 'Enter')  submitLogin(studentName);
  });

  // 컨테이너에 추가
  container.appendChild(dim);
  container.appendChild(panel);

  // 입력에 자동 포커스
  setTimeout(()=> panel.querySelector('#lpw')?.focus(), 0);
}

function closeLoginPanel(){
  document.querySelector('.login-dim')?.remove();
  document.querySelector('.login-panel')?.remove();
  // 카드 하이라이트 초기화
  document.querySelectorAll('.card.is-selected')?.forEach(el=>el.classList.remove('is-selected'));
}

/* ===== 선택 카드 하이라이트(텍스트에서 이름 추출 방식, 렌더 변경 없이 사용 가능) ===== */
function highlightSelectedCard(studentName){
  document.querySelectorAll('.card').forEach(card=>{
    const nameText = card.querySelector('.title')?.textContent?.trim() || '';
    const nameOnly = nameText.split(/\s+/).slice(1).join(' ');
    if (nameOnly === studentName) card.classList.add('is-selected');
    else card.classList.remove('is-selected');
  });
}

/* ===== 실제 검증 & 이동 ===== */
function submitLogin(studentName){
  const pw = document.getElementById('lpw')?.value ?? '';
  const err = document.getElementById('lerr');

  // 학생 목록에서 비번 비교
  const students = (getJSON('students', []) || []);
  const stu = students.find(s => s.name === studentName);
  if (!stu){ err.textContent = '학생 정보를 찾을 수 없습니다.'; return; }

  if (String(stu.password) !== String(pw)){
    err.textContent = '비밀번호가 올바르지 않습니다.';
    return;
  }

  // 성공: 세션 저장(8시간), 이동 또는 현재 페이지 유지
  setSession(studentName);
  // 원하는 행동 선택: 학생 전용 페이지로 이동
  location.href = 'student.html';
}

/* ===== 카드 클릭 시 패널 열기(이벤트 델리게이션) ===== */
/* index.html의 학생 카드 구조:
   <div class="card"><div class="title">51 홍길동</div> ... </div>
   이름은 title 텍스트의 "번호 이름" 중 이름만 추출
*/
(function attachCardLogin(){
  const grid = document.getElementById('board') || document.querySelector('#student-status-list');
  if (!grid) return;

  grid.addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if (!card || !grid.contains(card)) return;

    const title = card.querySelector('.title')?.textContent?.trim() || '';
    const name  = title.split(/\s+/).slice(1).join(' ');
    if (!name) return;

    openLoginPanel(name);
  });
})();
  </script>
</body>
</html>
