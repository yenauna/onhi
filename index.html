<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>오늘 할 일 - 전체확인</title>

  <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sunn-us/SUIT/fonts/variable/woff2/SUIT.css" />

  <link rel="stylesheet" href="css/common.css">
  <script src="js/common.js" defer></script>

  <style>
    :root{
      --bg-base:#eaf4ef;
      --bg-yellow:#f6e4b5;
      --bg-mint:#cfeee0;

      --card:#fbf3da;
      --card-line:#efe6cd;

      --text:#1f2a33;
      --muted:#6f7d8c;

      --brand:#2e7d57;
      --btn-shadow:rgba(46,125,87,.26);

      --accent:#4caf7d; /* 활성 버튼용 */
    }
    *{ box-sizing:border-box }
    html, body { height:100% }

    body{
      margin:0;
      font-family:'SUIT',system-ui,-apple-system,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 360px at 12% -8%, var(--bg-yellow), transparent 60%),
        radial-gradient(820px 340px at 108% 0%, var(--bg-mint), transparent 62%),
        linear-gradient(180deg, var(--bg-base), var(--bg-base));
      padding:96px 16px 24px;  /* 상단바 공간 */
    }
    .topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:#fff; z-index:1000;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; box-shadow:0 2px 10px rgba(0,0,0,.08);
    }
    .topbar .logo{ display:flex; align-items:center; gap:10px; }
    .topbar .logo img{
      height:44px; width:auto;          /* 직사각형 로고 대응 */
      object-fit:contain; display:block; /* 비율 유지 */
    }
    .topbar .menu{ display:flex; gap:8px; }
    .topbar .menu button{
      border:1px solid #dcdfe4; background:#fff; color:#1f2a33;
      border-radius:999px; padding:8px 14px; font-size:14px; cursor:pointer;
      box-shadow:0 6px 14px rgba(0,0,0,.06); transition:.18s;
    }
    .topbar .menu button:hover{ background:var(--brand); color:#fff; border-color:var(--brand); }
    .topbar .menu button.active{
      background:var(--accent); color:#fff; border-color:var(--accent);
      box-shadow:0 8px 18px var(--btn-shadow);
    }

    .container{
      max-width:1100px; margin:0 auto;
      background:var(--card); border:1px solid var(--card-line);
      border-radius:26px; box-shadow:0 16px 40px rgba(0,0,0,.10);
      padding:20px;
    }

    h1{
      margin:0; font-family:'Jua',sans-serif; font-weight:400; letter-spacing:-.2px;
      font-size:28px;
    }
    
    .events{ margin-bottom:14px; }
    .events-title{ font-weight:600; margin-bottom:8px; }

    /* 학생 카드 그리드 */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:10px;
    }
    .card{
      background:#fff; border:1px solid #e6e8eb; border-radius:16px;
      padding:12px; box-shadow:0 4px 10px rgba(0,0,0,.04);
    }
    .card .title{ font-weight:600; margin-bottom:8px; }

    .chip{
      border:1px solid #e6e8eb; border-radius:12px; padding:8px;
      display:flex; justify-content:space-between; align-items:center;
      margin:6px 0; user-select:none;
    }
    .card.selected { outline: 3px solid #2e7d57; outline-offset: 2px; }
    
    /* 상태색: 오늘 미완료(연한), 지난 미완료(강조) */
    .chip.missed-today { background:#f6c1c1; }
    .chip.missed-past  { background:#c0392b; color:#fff; border-color:#b23326; }
    .chip.done { display:none; } /* 완료는 아예 숨김(오늘 완료도 숨김) */

    .date { font-size:10px; opacity:.9; }

    /* 학생 로그인 선택 모드 표시 */
    body.login-pick-mode .topbar .menu #btn-student-login.active{
      background: var(--accent); color:#fff; border-color: var(--accent);
    }
    
    /* 모드가 켜지면 카드가 선택 가능한 느낌 */
    body.login-pick-mode .grid .card{ 
      cursor: pointer;
      box-shadow: 0 0 0 3px rgba(46,125,87,.18) inset;
    }
    
    /* 실제로 선택된 카드 */
    .grid .card.selected{
      outline: 3px solid #2e7d57; outline-offset: 2px;
    }

    
  </style>
</head>
<body>
  <header class="topbar">
    <div class="logo" onclick="location.href='index.html'" style="cursor:pointer">
      <img src="logo.png" alt="오늘 할 일 로고" />
    </div>
    <nav class="menu" aria-label="주요 메뉴">
      <button class="active" type="button">전체확인</button>
      <button type="button" id="btn-student-login">학생</button>
      <button type="button" onclick="location.href='teacher.html'">선생님</button>
    </nav>
    <div class="right-tools">
      <button type="button" id="eventsBtn" class="mode-btn" aria-pressed="false"></button>
    </div>
  </header>

  <main class="container">
    <div class="events" id="events"></div>
    <div class="grid" id="board"></div>
  </main>

  <script>
    
    // ==== common.js 폴백(없을 때만 정의) ====
    (function(){ 
      if (typeof getJSON !== 'function') {
        window.getJSON = function(k, fb=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fb; }catch{ return fb; } };
      }
      if (typeof setJSON !== 'function') {
        window.setJSON = function(k, v){ localStorage.setItem(k, JSON.stringify(v)); };
      }
      if (typeof escapeHTML !== 'function') {
        window.escapeHTML = function(s){ return String(s)
          .replace(/&/g,'&amp;').replace(/</g,'&lt;')
          .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); };
      }
      if (typeof normalizeDate !== 'function') {
        window.normalizeDate = function(d){
          const t = new Date(d); // 'YYYY-MM-DD' 문자열도 OK
          t.setHours(0,0,0,0);
          return t;
        };
      }
      if (typeof loadAllTeacherTasks !== 'function') {
        window.loadAllTeacherTasks = function(){
          const res = [];
          for (let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if (!key.startsWith('teacherTasks-')) continue;
            try{
              const data = JSON.parse(localStorage.getItem(key));
              res.push({ key, dateKey: key.slice('teacherTasks-'.length), data });
            }catch{}
          }
          return res;
        };
      }
    })();
    
    // =============== 공통 스토리지 헬퍼 ===============
    // === 완료표시 저장소 공통 ===
function getDoneStore(name){ return getJSON("doneTasks-" + name, {}) || {}; }
function setDoneStore(name, obj){ setJSON("doneTasks-" + name, obj || {}); }

// === ✅ 신규: UID 기반 ===
function isDoneUID(name, uid){
  const s = getDoneStore(name);
  return s[uid] === true;
}
function setDoneUID(name, uid, done){
  const s = getDoneStore(name);
  if (done) s[uid] = true; else delete s[uid];
  setDoneStore(name, s);
}

// === (옵션) 레거시 호환: date@@text 키 ===
function makeDoneKey(dateStr, taskText){ return `${dateStr}@@${taskText}`; }
function isDoneLegacy(name, dateStr, taskText){
  const s = getDoneStore(name);
  return s[makeDoneKey(dateStr, taskText)] === true || s[taskText] === true; // 아주 옛 키도 허용
}
function setDoneLegacy(name, dateStr, taskText, done){
  const s = getDoneStore(name);
  const k = makeDoneKey(dateStr, taskText);
  if (done) s[k] = true; else delete s[k];
  setDoneStore(name, s);
}

// === 안전한 호환 래퍼 (예전 코드가 isDone/setDone을 불러도 동작) ===
// isDone(name, uid)  -> UID 모드
// isDone(name, date, text) -> 레거시 모드
function isDone(name, a, b){
  return (b === undefined) ? isDoneUID(name, a) : isDoneLegacy(name, a, b);
}
// setDone(name, uid, done)  -> UID 모드
// setDone(name, date, text, done) -> 레거시 모드
function setDone(name, a, b, d){
  if (typeof d === 'boolean') return setDoneLegacy(name, a, b, d);
  return setDoneUID(name, a, b);
}


    // ===== 새 구조(tasksV2) 로더 (+ 구버전 teacherTasks-* 백업 호환) =====
function getTasks(){ return getJSON('tasksV2', []) || []; }
function setTasks(arr){ setJSON('tasksV2', arr || []); }

// (선택) 구버전 → 새 구조 1회 마이그레이션 (이미 이전했으면 그냥 통과)
(function migrateOnce(){
  if ((getTasks()||[]).length) return; // 이미 새 구조 있음
  const old = (window.loadAllTeacherTasks ? loadAllTeacherTasks() : []).map(({data,dateKey})=>{
    const repeat = data?.repeat || 'none';
    const students = data?.students || ['전체'];
    const tasks = data?.tasks || [];
    return tasks.map(t=>({
      id: (Date.now()+Math.random()+""),
      type: 'assignment',
      date: dateKey,
      text: t,
      desc: '',
      repeat,
      repeatStart: repeat==='none'? null : dateKey,
      repeatEnd: null,
      students
    }));
  }).flat();
  if (old.length) setTasks(old);
})();

    
    function loadStudents() {
      return getJSON("students", []);
    }
    function _toNum(v){ const n = parseInt(String(v),10); return isNaN(n)?0:n; }
    function sortStudents(arr){
      return (arr||[]).slice().sort((a,b)=>{
        const an=_toNum(a.id), bn=_toNum(b.id);
        const ag = an>50?1:0, bg = bn>50?1:0;
        if (ag!==bg) return ag-bg;
        return an-bn;
      });
    }
    function labelOf(stu){ return `${stu.id} ${stu.name}`; } // (옵션) 필요하면 사용



    // =============== 과제 로드 ===============
    // === 과제 인스턴스(오늘까지) 생성: tasksV2 기반 ===
function buildInstancesFromTasks(){
  const tasks = getTasks(); // [{id,type,date,text,repeat,repeatStart,repeatEnd,students}]
  const today = normalizeDate(new Date());
  const dayMap = { mon:1, tue:2, wed:3, thu:4, fri:5 };
  const out = [];

  const push = (t, dObj) => {
    const y=dObj.getFullYear(), m=dObj.getMonth()+1, dd=dObj.getDate();
    out.push({
      uid: t.id,
      text: t.text,
      date: `${y}-${String(m).padStart(2,'0')}-${String(dd).padStart(2,'0')}`,
      dateObj: new Date(dObj),
      students: t.students || ['전체']
    });
  };

  tasks.forEach(t=>{
    if (t.type === 'event') return; // 일정은 완료/미완료 개념 없음 → 메인 보드 제외
    if (t.type === 'challenge') return; // 도전도 날짜 인스턴스 아님 → 보드 제외(원하면 규칙 정해 별도 처리)

    const base = normalizeDate(t.repeatStart || t.date);
    const end  = t.repeatEnd ? normalizeDate(t.repeatEnd) : today; // 끝 없으면 오늘까지만
    const rpt  = t.repeat || 'none';

    if (rpt === 'daily'){
      for (let cur=new Date(base); cur<=today && cur<=end; cur.setDate(cur.getDate()+1)){
        push(t, cur);
      }
    } else if (dayMap[rpt] != null){
      const targetDow = dayMap[rpt];
      // base 이후 첫 타깃 요일까지 이동
      const cur = new Date(base);
      while (cur.getDay() !== targetDow) cur.setDate(cur.getDate()+1);
      for (; cur<=today && cur<=end; cur.setDate(cur.getDate()+7)){
        push(t, cur);
      }
    } else {
      // 반복 없음: 기준 날짜 1건(오늘 이전/같은 경우만)
      if (!isNaN(base) && base <= today) push(t, base);
    }
  });

  // 최신순 정렬
  out.sort((a,b)=> b.dateObj - a.dateObj);
  return out;
}

    function renderEvents(){
      const wrap = document.getElementById('events');
      if (!wrap) return;
      wrap.innerHTML='';
      let pref = localStorage.getItem('showEvents');
      if (pref !== 'yes' && pref !== 'no'){ pref='yes'; localStorage.setItem('showEvents', pref); }
      const show = pref !== 'no';
      if (!show){ wrap.style.display='none'; return; }
      const events = (getTasks()||[]).filter(t=>t.type==='event');
      if (!events.length){ wrap.style.display='none'; return; }
      events.sort((a,b)=> a.date.localeCompare(b.date));
      wrap.style.display='block';
      const title=document.createElement('div');
      title.className='events-title';
      title.textContent='일정';
      wrap.appendChild(title);
      events.forEach(ev=>{
        const chip=document.createElement('div');
        chip.className='chip';
        chip.innerHTML=`<span>${escapeHTML(ev.text)}</span><span class="date">${ev.date}</span>`;
        wrap.appendChild(chip);
      });
    }


    // =============== 보드 렌더 ===============
    function renderBoard(){
      const board = document.getElementById('board');
      board.innerHTML = '';

      renderEvents();
      const mode = 'view'; // force view-only

      const students = sortStudents(loadStudents());
      const instances = buildInstancesFromTasks();

      // 오늘과 과거만(미래 제외)
      const today = normalizeDate(new Date());

      students.forEach(stu=>{
        const card = document.createElement('div');
        card.className='card';

        // 카드 클릭하면 로그인 패널 열리도록 연결
        card.dataset.student = stu.name;          // 선택된 학생 전달용
        
        const title = document.createElement('div');
        title.className='title';
        title.textContent = `${stu.id} ${stu.name}`;
        card.appendChild(title);

        let any = false;

        instances.forEach(inst=>{
          const isTarget = inst.students.includes('전체') || inst.students.includes(stu.name);
          if (!isTarget) return;
          
          const done   = isDone(stu.name, inst.uid);   // ✅ UID로 체크
          const isPast = inst.dateObj < today;
          if (done) return; // 완료는 숨김

          any = true;
          const chip = document.createElement('div');
          chip.className = 'chip ' + (isPast ? 'missed-past' : 'missed-today');
          chip.dataset.student = stu.name;
          chip.dataset.uid = inst.uid;                 // UID 보관
          chip.innerHTML = `
          <span>${escapeHTML(inst.text)}</span>
          <span class="date">${inst.date}</span>
          `;
          
          if (mode === 'edit') {
            chip.style.cursor='pointer';
            chip.addEventListener('click', (e)=>{
              e.stopPropagation();
              setDone(stu.name, inst.uid, true);       // UID로 저장
              chip.remove();
            });
          }
          card.appendChild(chip);
        });


        if (!any){
          // 미완료 없으면 비워두되, 자리 유지 위해 안내 1줄
          const none = document.createElement('div');
          none.style.color='#8a97a6'; none.style.fontSize='13px'; none.style.marginTop='4px';
          none.textContent='오늘 할 일 끝';
          card.appendChild(none);
        }

        board.appendChild(card);
      });
    }

    // ===== 카드 클릭은 "로그인 선택 모드"일 때만 동작 =====
    (function attachPickHandler(){
      const grid = document.getElementById('board');
      if (!grid) return;
      
      grid.addEventListener('click', (e) => {
        if (!loginPickMode) return;                    // ← 모드 OFF면 무시
        
        const card = e.target.closest('.card');
        if (!card || !grid.contains(card)) return;
        
        // 선택 표시 갱신
          document.querySelectorAll('.grid .card.selected')
            .forEach(el => el.classList.remove('selected'));
        card.classList.add('selected');
        
        // 학생 이름 추출 (data-student 또는 타이틀 텍스트)
        const name = card.dataset.student ||
          (card.querySelector('.title')?.textContent?.trim().split(/\s+/).slice(1).join(' ') || '');
        if (!name) return;
        
        // 비밀번호 입력창 열기
        openLoginPanel(name);
      });
    })();

    function applyShowEventsBtn(){
      const btn = document.getElementById('eventsBtn');
      if (!btn) return;
      let pref = localStorage.getItem('showEvents');
      if (pref !== 'yes' && pref !== 'no'){ pref='yes'; localStorage.setItem('showEvents', pref); }
      const show = pref !== 'no';
      btn.textContent = show ? '일정숨김' : '일정표시';
      btn.setAttribute('aria-pressed', String(show));
    }
    function toggleShowEvents(){
      const show = localStorage.getItem('showEvents') !== 'no';
      localStorage.setItem('showEvents', show ? 'no' : 'yes');
      applyShowEventsBtn();
      renderBoard();
    }



     // 페이지가 하단에서 스크립트를 로드하므로 즉시 초기화 가능
    applyShowEventsBtn();
    renderBoard();
    document.getElementById('eventsBtn')?.addEventListener('click', toggleShowEvents);

     window.addEventListener('storage', (e) => {
      if (e.key === 'tasksV2' || e.key === 'showEvents') renderBoard();
      if (e.key === 'showEvents') applyShowEventsBtn();
    });

    /* ===== 세션 유틸 ===== */
function clearSession(){
  localStorage.removeItem('currentStudent');
  localStorage.removeItem('sessionExpireAt');
}
function setSession(name){
  localStorage.setItem('currentStudent', name);
  localStorage.setItem('sessionExpireAt', String(Date.now() + 8*60*60*1000)); // 8시간
}
function isSessionValid(){
  const exp = parseInt(localStorage.getItem('sessionExpireAt')||'0', 10);
  return exp && Date.now() < exp;
}
(function checkExpireSilently(){
  if (!isSessionValid()) clearSession(); // 조용히 만료 처리(알림 없음)
})();


    
    
// 카드 하이라이트: 선택된 학생 카드만 selected 클래스
function highlightSelectedCard(name){
  document.querySelectorAll('.grid .card').forEach(el=>{
    el.classList.toggle('selected', el.dataset.student === name);
  });
}

// 모달 열기/닫기/확인
let _loginSelected = null;
function openLoginPanel(studentName){
  _loginSelected = studentName;
  const modal  = document.getElementById('studentLoginModal');
  const input  = document.getElementById('studentPwInput');
  if (!modal || !input) return;
  modal.style.display = 'block';
  input.value = '';
  setTimeout(()=>input.focus(), 0);
}
function closeLoginPanel(){
  const modal  = document.getElementById('studentLoginModal');
  if (modal) modal.style.display = 'none';
  _loginSelected = null;
}
function confirmStudentLogin(){
  if (!_loginSelected) return;
  const input = document.getElementById('studentPwInput');
  const pw = input ? input.value.trim() : '';
  const students = loadStudents(); // 기존 공통 함수 사용
  const stu = students.find(s => s.name === _loginSelected);
  if (!stu) { alert('학생 정보를 찾지 못했습니다.'); return; }
  if (stu.password === pw){
    setSession(stu.name);   // 위쪽에 이미 있는 8시간 만료 세션 유틸 사용
    closeLoginPanel();
    // 필요 시 학생 페이지로 이동(or 그대로 유지)
    location.href = 'student.html';
  } else {
    alert('비밀번호가 올바르지 않습니다.');
    input?.focus();
  }
}

    // ===== 학생 버튼 토글: 로그인 선택 모드 =====
    let loginPickMode = false;
    
    const btnStudent = document.getElementById('btn-student-login');
    btnStudent?.addEventListener('click', () => {
      loginPickMode = !loginPickMode;
      
      // 버튼 / 바디 상태 토글
      btnStudent.classList.toggle('active', loginPickMode);
      document.body.classList.toggle('login-pick-mode', loginPickMode);
      
      // 끌 때는 선택/모달 정리
      if (!loginPickMode) {
        document.querySelectorAll('.grid .card.selected')
          .forEach(el => el.classList.remove('selected'));
        closeLoginPanel?.();
      }
    });


    
    
    
  </script>
  
  <!-- 학생 로그인 모달: 보드(#board) 밖에 둔다 -->
<div id="studentLoginModal" style="display:none; position:fixed; inset:0; z-index:2000;">
  <!-- 반투명 백드롭 -->
  <div style="position:absolute; inset:0; background:rgba(0,0,0,.35);" onclick="closeLoginPanel()"></div>

  <!-- 팝업 카드 -->
  <div style="
    position:absolute; left:50%; top:20%;
    transform:translateX(-50%);
    width:min(640px, 92vw);
    background:#fff; border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.18);
    padding:20px;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
      <h3 style="margin:0; font-size:18px;">학생 로그인</h3>
      <button type="button" onclick="closeLoginPanel()" style="all:unset; cursor:pointer; font-size:20px;">×</button>
    </div>

    <input id="studentPwInput" type="password" placeholder="비밀번호"
           style="width:100%; height:44px; border:1px solid #dcdfe4; border-radius:12px; padding:0 12px; font:inherit;">

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button type="button" class="btn-primary" onclick="confirmStudentLogin()">확인</button>
    </div>

    <div id="loginError" style="display:none; color:#c62828; margin-top:8px; font-size:14px;">
      비밀번호가 올바르지 않습니다.
    </div>
  </div>
</div>
</body>
</html>
